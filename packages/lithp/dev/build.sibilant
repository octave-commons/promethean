(namespace build)
;; (include "../headers/core")
(import-namespace kit)
(print "yo")
;; (include "../headers/async.sibilant")
(import-namespace async)

(import-default lith "./dist/lang/sibilant.js")
(import mirror-with-handler "@shared/ts/dist/fs/mirrorWrite.js")
(import dirname "path")
(import promises "fs")
(const write-file promises.writeFile)
;; (.include lith "./headers/core.sibilant")

(def inject-headers (source relative-file)
  (+


   "(namespace hack)"
   "(include \"@shared/sibilant/headers/core.sibilant\")"
   "(import-namespace kit)"

   "(include \"@shared/sibilant/headers/interface.sibilant\")"
   "(import-namespace interface)"

   "(include \"@shared/sibilant/inc/litteral.sibilant\")"
   "(import-namespace rand)"
   "(include \"@shared/sibilant/inc/docs.sibilant\")"
   "(import-namespace docs)"
   "(include \"@shared/sibilant/inc/misc.sibilant\")"
   "(import-namespace misc)"
   "(include \"@shared/sibilant/inc/generators.sibilant\")"
   "(import-namespace generators)"
   "(include \"@shared/sibilant/inc/rand.sibilant\")"
   "(import-namespace async)"

   (if relative-file (+ "(meta (assign sibilant.dir \"" (dirname  ("./src/" relative-file))  "\" ) null)") "")
   source
   (if relative-file "(meta (assign sibilant.dir \".\") null)" "")
   )
  )
(def-async transpile (file)
  (print file.rel-path)
  (const source (await (.text file)))
  (try (when (= (.to-lower-case file.ext) ".sibilant")
        (const (lit js map) (lith (inject-headers  source file.src-path)
                                  (lit  (map:true)
                                       ;; (file file.src-path)
                                       )))
        (const out-rel (.replace file.rel-path ".sibilant" ".js"))
        (lit (path out-rel) (content js) (encoding "utf8"))
        ;; (pipe (write-file  (+ "./dist/" out-rel ".map") (.to-string map)

        ;;                    (lit (encoding "utf8")))
        ;;       (.catch (aprint "failed to write sourcemap"))
        ;;       (then-do (lit (path out-rel) (content js) (encoding "utf8"))))
        )
       (print e))
  (if! (.ends-with file.ext ".draft")
       (return "skip"))
  (return "copy"))

(const mirror-config (lit (concurrency 16)
                          (over-write "if-newer")
                          (hash-compoare true)
                          (delete-extra "files")
                          (dry-run true)
                          (delete-filter (=> (*abs rel) (not (.starts-with rel ".cache/"))))
                          (predicate (=> (*abs d) (not (and d.is-directory
                                                            (or (= d.name "node_modules")
                                                                (= d.name ".git"))))))))
(await (mirror-with-handler "./src" "./dist" transpile mirror-config))

