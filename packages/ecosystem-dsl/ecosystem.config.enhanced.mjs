/**
 * Enhanced PM2 Ecosystem Configuration for Promethean Monorepo
 * Generated by Clojure DSL from EDN files
 * Generated at: Sun Nov 09 11:42:13 CST 2025
 *
 * Features:
 * - Monitors file changes across all packages and services
 * - Automatically runs tests/builds on affected projects using Nx
 * - Comprehensive logging and error handling
 * - Performance optimization with debouncing and caching
 * - Support for all cacheable operations defined in nx.json
 */

import dotenv from 'dotenv';
import { fileURLToPath } from 'node:url';
import { dirname, join } from 'node:path';

// Load environment variables
try {
  dotenv.config();
} catch (error) {
  if (error?.code !== 'ERR_MODULE_NOT_FOUND') {
    throw error;
  }
}

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const PROJECT_ROOT = __dirname;

const generatedApps = {
  "apps": [
    {
      "killTimeout": 15000,
      "minUptime": 10000,
      "args": [
        "--watch-dirs",
        "packages\/*\/src",
        "services\/*\/src",
        "shared\/*\/src",
        "--operations",
        "build,test,test:unit,test:integration,test:e2e,lint,typecheck,coverage",
        "--debounce",
        2000,
        "--batch-delay",
        5000,
        "--max-concurrent",
        3,
        "--workspace-layout",
        "{\"apps-dir\":\"services\",\"libs-dir\":\"packages\"}"
      ],
      "pidFile": "logs\/nx-watcher.pid",
      "watch": [
        "packages\/*\/src\/**\/*",
        "services\/*\/src\/**\/*",
        "shared\/*\/src\/**\/*",
        "tools\/**\/*",
        "scripts\/**\/*"
      ],
      "cwd": "\/home\/err\/devel\/orgs\/riatzukiza\/promethean\/packages\/ecosystem-dsl",
      "name": "nx-watcher",
      "script": "scripts\/nx-watcher.mjs",
      "time": true,
      "env": {
        "NX_VERBOSE_LOGGING": "false",
        "NX_DAEMON": "true",
        "NX_PERF_LOGGING": "false",
        "PM2_PROCESS_NAME": "nx-watcher",
        "PROJECT_ROOT": "\/home\/err\/devel\/orgs\/riatzukiza\/promethean\/packages\/ecosystem-dsl"
      },
      "autorestart": true,
      "mergeLogs": true,
      "interpreter": "\/usr\/bin\/env",
      "ignoreWatch": [
        "node_modules\/**\/*",
        "dist\/**\/*",
        "build\/**\/*",
        "coverage\/**\/*",
        "logs\/**\/*",
        ".git\/**\/*",
        "**\/*.log",
        "**\/*.tmp",
        ".nx\/cache\/**\/*"
      ],
      "maxRestarts": 10,
      "outFile": "logs\/nx-watcher-out.log",
      "maxMemoryRestart": "1G",
      "logDateFormat": "YYYY-MM-DD HH:mm:ss Z",
      "instances": 1,
      "errorFile": "logs\/nx-watcher-err.log",
      "restartDelay": 5000,
      "logFile": "logs\/nx-watcher-combined.log",
      "description": "Intelligent file watcher that triggers Nx operations on affected projects"
    }
  ]
};

// Export complete ecosystem configuration
export const apps = generatedApps;

// PM2 deployment configuration
export const deploy = {
  production: {
    user: 'deploy',
    host: ['promethean.example.com'],
    ref: 'origin/main',
    repo: 'git@github.com:promethean/promethean.git',
    path: '/var/www/promethean',
    'post-deploy': 'pnpm install && pnpm build:all && pm2 reload ecosystem.config.enhanced.mjs --env production'
  }
};

console.log(`üöÄ Enhanced PM2 ecosystem configuration loaded`);
console.log(`üìä Total processes configured: 1`);
console.log(`üìÅ Logs directory: ${join(PROJECT_ROOT, 'logs')}`);

export default {
  apps,
  deploy
};
