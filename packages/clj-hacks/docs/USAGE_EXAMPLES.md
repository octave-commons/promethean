# MCP Bridge Usage Examples

This document provides comprehensive examples of using the MCP Bridge package for various configuration management scenarios.

## Table of Contents

1. [Basic Setup](#basic-setup)
2. [Configuration Management](#configuration-management)
3. [IDE Integration](#ide-integration)
4. [HTTP Transport Configuration](#http-transport-configuration)
5. [Advanced Scenarios](#advanced-scenarios)
6. [Troubleshooting](#troubleshooting)

## Basic Setup

### Initial Configuration

Create your canonical MCP configuration file:

```clojure
;; config/mcp.edn
{:mcp-servers
 {:filesystem
  {:command "npx"
   :args ["@modelcontextprotocol/server-filesystem" "/tmp"]
   :description "Local filesystem access"
   :auto-connect? true}

  :github
  {:command "npx"
   :args ["@modelcontextprotocol/server-github"]
   :env {"GITHUB_PERSONAL_ACCESS_TOKEN" "${GITHUB_TOKEN}"}
   :description "GitHub repository access"
   :auto-approve ["repos.read" "repos.write"]
   :disabled? false}}

 :outputs
 [{:schema :mcp.json :path "~/.config/claude/mcp.json"}
  {:schema :vscode.json :path "~/.vscode/settings.json"}
  {:schema :elisp :path "~/.config/emacs/mcp-servers.el"}
  {:schema :codex.toml :path "~/.config/codex.toml"}]}
```

### First Synchronization

```bash
# Synchronize all configurations
clojure -M:tasks sync-all --edn config/mcp.edn

# Verify configuration health
clojure -M:tasks doctor --edn config/mcp.edn
```

## Configuration Management

### Adding a New Server

```clojure
;; Add to config/mcp.edn
{:mcp-servers
 {;; Existing servers...
  :new-server
  {:command "docker"
   :args ["run" "--rm" "my-mcp-server:latest"]
   :cwd "/workspace"
   :env {"API_KEY" "${API_KEY}"}
   :timeout 60000
   :description "Containerized MCP server"
   :metadata {"maintainer" "team@company.com"}
   :capabilities {"streaming" true "tools" ["custom-tool"]}}}}
```

```bash
# Update all targets
clojure -M:tasks sync-all --edn config/mcp.edn
```

### Selective Target Updates

```bash
# Update only VSCode configuration
clojure -M:tasks push vscode.json ~/.vscode/settings.json --edn config/mcp.edn

# Update only Emacs configuration
clojure -M:tasks push elisp ~/.config/emacs/mcp-servers.el --edn config/mcp.edn

# Pull changes from Claude Code
clojure -M:tasks pull claude_code.json ~/.config/claude/mcp.json --edn config/mcp.edn
```

### Environment-Specific Configurations

```clojure
;; config/development.edn
{:mcp-servers
 {:local-dev
  {:command "node"
   :args ["./dist/server.js" "--port" "3001"]
   :cwd "./packages/my-server"
   :env {"NODE_ENV" "development"}
   :description "Local development server"}}}

;; config/production.edn
{:mcp-servers
 {:prod-server
  {:command "npx"
   :args ["@company/mcp-server"]
   :env {"NODE_ENV" "production" "API_ENDPOINT" "https://api.company.com"}
   :description "Production MCP server"}}}
```

```bash
# Deploy development configuration
clojure -M:tasks sync-all --edn config/development.edn

# Deploy production configuration
clojure -M:tasks sync-all --edn config/production.edn
```

## IDE Integration

### VSCode Integration

```bash
# Pull existing VSCode settings
clojure -M:tasks pull vscode.json ~/.vscode/settings.json --edn config/mcp.edn

# Push updated configuration
clojure -M:tasks push vscode.json ~/.vscode/settings.json --edn config/mcp.edn
```

Resulting VSCode configuration:

```json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": ["@modelcontextprotocol/server-filesystem", "/tmp"],
      "type": "stdio"
    },
    "github": {
      "command": "npx",
      "args": ["@modelcontextprotocol/server-github"],
      "env": {
        "GITHUB_PERSONAL_ACCESS_TOKEN": "${GITHUB_TOKEN}"
      },
      "type": "stdio"
    }
  }
}
```

### Emacs Integration

```bash
# Update Emacs configuration
clojure -M:tasks push elisp ~/.config/emacs/mcp-servers.el --edn config/mcp.edn
```

Generated Emacs configuration:

```elisp
;; AUTO-GENERATED by mk.mcp-cli -- edits will be overwritten.
(with-eval-after-load 'mcp
  (setq mcp-hub-servers
        '((:filesystem . (:command "npx"
                         :args ("@modelcontextprotocol/server-filesystem" "/tmp")
                         :description "Local filesystem access"
                         :auto-connect t))
          (:github . (:command "npx"
                     :args ("@modelcontextprotocol/server-github")
                     :env ("GITHUB_PERSONAL_ACCESS_TOKEN" . "${GITHUB_TOKEN}")
                     :description "GitHub repository access"
                     :auto-approve ("repos.read" "repos.write"))))))
```

### Claude Code Integration

```bash
# Update Claude Code configuration
clojure -M:tasks push claude_code.json ~/.config/claude/mcp.json --edn config/mcp.edn
```

### Codex Integration

```bash
# Update Codex configuration
clojure -M:tasks push codex.toml ~/.config/codex.toml --edn config/mcp.edn
```

Generated TOML configuration:

```toml
[mcp_servers."filesystem"]
command = "npx"
args = ["@modelcontextprotocol/server-filesystem", "/tmp"]

[mcp_servers."github"]
command = "npx"
args = ["@modelcontextprotocol/server-github"]
env = { "GITHUB_PERSONAL_ACCESS_TOKEN" = "${GITHUB_TOKEN}" }
```

## HTTP Transport Configuration

### Basic HTTP Setup

```clojure
{:mcp-servers
 {:local-fs
  {:command "npx"
   :args ["@modelcontextprotocol/server-filesystem" "/tmp"]}}

 :http
 {:transport :http
  :base-url "http://127.0.0.1:3210"
  :tools ["filesystem" "github"]
  :include-help? true
  :stdio-meta
  {:title "MCP Hub"
   :description "Central MCP HTTP endpoint"
   :workflow ["setup" "configure" "use"]
   :expectations
   {:usage ["HTTP client required"]
    :pitfalls ["Network connectivity issues"]
    :prerequisites ["MCP server running"]}}
  :endpoints
  {:filesystem
   {:tools ["files_read" "files_write"]
    :include-help? true
    :meta
    {:title "Filesystem Tools"
     :description "Local file operations"
     :expectations
     {:usage ["File path required"]
      :pitfalls ["Permission denied"]}}}
   :github
   {:tools ["repos_read" "repos_write"]
    :include-help? false
    :meta
    {:title "GitHub Integration"
     :description "GitHub repository operations"}}}
  :proxy {:config "./config/mcp_servers.edn"}}}
```

### HTTP Endpoint to Server Conversion

Different formats handle HTTP endpoints differently:

#### MCP JSON Format

```json
{
  "transport": "http",
  "base-url": "http://127.0.0.1:3210",
  "tools": ["filesystem", "github"],
  "includeHelp": true,
  "stdioMeta": {
    "title": "MCP Hub",
    "description": "Central MCP HTTP endpoint"
  },
  "endpoints": {
    "filesystem": {
      "tools": ["files_read", "files_write"],
      "includeHelp": true,
      "meta": {
        "title": "Filesystem Tools",
        "description": "Local file operations"
      }
    }
  },
  "stdioProxyConfig": "./config/mcp_servers.edn",
  "mcpServers": {
    "local-fs": {
      "command": "npx",
      "args": ["@modelcontextprotocol/server-filesystem", "/tmp"]
    }
  }
}
```

#### Claude Code Format

```json
{
  "mcpServers": {
    "http-default": {
      "command": "npx",
      "args": ["mcp-remote", "http://127.0.0.1:3210/mcp"]
    },
    "http-filesystem": {
      "command": "npx",
      "args": ["mcp-remote", "http://127.0.0.1:3210/filesystem"]
    },
    "local-fs": {
      "command": "npx",
      "args": ["@modelcontextprotocol/server-filesystem", "/tmp"]
    }
  }
}
```

#### Codex TOML Format

```toml
[mcp_servers."local-fs"]
command = "npx"
args = ["@modelcontextprotocol/server-filesystem", "/tmp"]

[mcp_servers."http-default"]
command = "pnpm"
args = ["--filter", "@promethean/mcp", "dev"]
env = { "MCP_CONFIG_JSON" = "{\"transport\":\"stdio\",\"tools\":[\"filesystem\",\"github\"],\"includeHelp\":true}" }

[mcp_servers."http-filesystem"]
command = "pnpm"
args = ["--filter", "@promethean/mcp", "dev"]
env = { "MCP_CONFIG_JSON" = "{\"transport\":\"stdio\",\"tools\":[\"files_read\",\"files_write\"],\"includeHelp\":true}" }
```

## Advanced Scenarios

### Multi-Environment Configuration

```clojure
;; config/base.edn
{:mcp-servers
 {:core-services
  {:command "npx"
   :args ["@company/core-mcp"]
   :description "Core company services"}}

 :http
 {:transport :http
  :base-url "http://127.0.0.1:3210"
  :tools ["core"]}}

;; config/development.edn
{:mcp-servers
 {:dev-tools
  {:command "node"
   :args ["./dist/dev-server.js"]
   :cwd "./tools/dev-server"
   :description "Development tools"}}}

;; config/production.edn
{:mcp-servers
 {:prod-monitoring
  {:command "npx"
   :args ["@company/monitoring-mcp"]
   :env {"ENVIRONMENT" "production"}
   :description "Production monitoring"}}}
```

```bash
# Merge configurations and deploy
clojure -M:tasks -X -Sdeps '{:deps {clojure-tools-deps/clj-tools-deps {:mvn/version "1.11.1"}}}' \
  -M -e "(require '[clojure.java.io :as io]) \
         (require '[clj-hacks.mcp.ops :as ops]) \
         (let [base (read-string (slurp \"config/base.edn\")) \
               dev (read-string (slurp \"config/development.edn\")) \
               merged (merge base dev)] \
           (spit \"config/merged.edn\" merged) \
           (ops/push-all! merged \".\" (:outputs merged)))"
```

### Configuration Templates

```clojure
;; templates/server-template.edn
{:mcp-servers
 {:{{server-name}}
  {:command "{{command}}"
   :args {{args}}
   :cwd "{{cwd}}"
   :env {{env}}
   :description "{{description}}"
   :auto-connect? {{auto-connect}}
   :disabled? {{disabled}}}}

 :outputs
 [{:schema :mcp.json :path "~/.config/claude/mcp.json"}
  {:schema :vscode.json :path "~/.vscode/settings.json"}]}
```

### Conditional Configuration

```clojure
{:mcp-servers
 (cond
   (some? (System/getenv "DEVELOPMENT"))
   {:dev-server
    {:command "node"
     :args ["./dist/dev.js"]
     :description "Development server"}}

   (some? (System/getenv "PRODUCTION"))
   {:prod-server
    {:command "npx"
     :args ["@company/prod-server"]
     :description "Production server"}}

   :else
   {:local-server
    {:command "node"
     :args ["./dist/local.js"]
     :description "Local server"}})}
```

### Backup and Restore

```bash
# Create backup
cp config/mcp.edn config/mcp.backup.$(date +%Y%m%d).edn

# Restore from backup
clojure -M:tasks sync-all --edn config/mcp.backup.20241026.edn
```

### Configuration Validation

```clojure
;; Custom validation script
(require '[clj-hacks.mcp.core :as core])
(require '[clojure.spec.alpha :as s])

(s/def ::command string?)
(s/def ::args (s/coll-of string?))
(s/def ::server-spec (s/keys :req-un [::command ::args]))

(defn validate-config [config]
  (let [servers (:mcp-servers config)]
    (every? #(s/valid? ::server-spec %) (vals servers))))

;; Usage
(when-not (validate-config (read-string (slurp "config/mcp.edn")))
  (println "Configuration validation failed!"))
```

## Troubleshooting

### Common Issues

#### 1. Path Resolution Problems

```bash
# Check path expansion
clojure -M:tasks doctor --edn config/mcp.edn

# Manual path check
clojure -M -e "(require '[clj-hacks.mcp.core :as core]) \
               (println (core/resolve-path \".\" \"~/.config/mcp.json\"))"
```

#### 2. Permission Issues

```bash
# Check file permissions
ls -la ~/.config/claude/mcp.json
ls -la ~/.vscode/settings.json

# Fix permissions
chmod 644 ~/.config/claude/mcp.json
chmod 644 ~/.vscode/settings.json
```

#### 3. Server Command Not Found

```bash
# Check command availability
which npx
which node
which docker

# Add to PATH or use absolute paths
{:mcp-servers
 {:server-name
  {:command "/usr/local/bin/npx"  ; Absolute path
   :args ["@package/server"]}}}
```

#### 4. Environment Variable Issues

```bash
# Check environment variables
echo $GITHUB_TOKEN
echo $API_KEY

# Test expansion
clojure -M -e "(require '[clj-hacks.mcp.core :as core]) \
               (println (core/expand-home-str \"${HOME}/.config\"))"
```

### Debug Mode

```clojure
;; Enable debug logging
(require '[clj-hacks.mcp.ops :as ops])
(require '[clojure.pprint :as pp])

;; Debug pull operation
(let [result (ops/pull-one {} "." {:schema :mcp.json :path "~/.config/claude/mcp.json"})]
  (pp/pprint result))
```

### Recovery Procedures

#### Corrupted Configuration

```bash
# Reset to known good state
git checkout HEAD -- config/mcp.edn
clojure -M:tasks sync-all --edn config/mcp.edn
```

#### Partial Sync Failure

```bash
# Identify failed targets
clojure -M:tasks doctor --edn config/mcp.edn

# Retry individual targets
clojure -M:tasks sync mcp.json ~/.config/claude/mcp.json --edn config/mcp.edn
```

#### Rollback Changes

```bash
# Use git to rollback
git log --oneline config/
git checkout <commit-hash> -- config/mcp.edn
clojure -M:tasks sync-all --edn config/mcp.edn
```

## Best Practices

1. **Version Control**: Always keep configuration in version control
2. **Environment Variables**: Use environment variables for sensitive data
3. **Validation**: Run `doctor` command before deployments
4. **Backups**: Create backups before major changes
5. **Testing**: Test configurations in development first
6. **Documentation**: Document custom server configurations
7. **Monitoring**: Monitor MCP server logs for issues

## Integration Scripts

### Automated Deployment Script

```bash
#!/bin/bash
# deploy-mcp-config.sh

set -e

CONFIG_FILE=${1:-"config/mcp.edn"}

echo "Validating configuration..."
clojure -M:tasks doctor --edn "$CONFIG_FILE"

echo "Creating backup..."
cp "$CONFIG_FILE" "${CONFIG_FILE}.backup.$(date +%Y%m%d%H%M%S)"

echo "Deploying configuration..."
clojure -M:tasks sync-all --edn "$CONFIG_FILE"

echo "Verifying deployment..."
clojure -M:tasks doctor --edn "$CONFIG_FILE"

echo "Deployment completed successfully!"
```

### Configuration Update Script

```bash
#!/bin/bash
# update-server.sh

SERVER_NAME=$1
COMMAND=$2
ARGS=$3

CONFIG_FILE="config/mcp.edn"

# Update configuration using clojure script
clojure -M -e "
(require '[clojure.java.io :as io])
(require '[clojure.edn :as edn])

(let [config (edn/read-string (slurp \"$CONFIG_FILE\"))
      updated (assoc-in config [:mcp-servers (keyword \"$SERVER_NAME\")]
                    {:command \"$COMMAND\"
                     :args [\"$ARGS\"]
                     :description \"Updated server\"})]
  (spit \"$CONFIG_FILE\" (with-out-str (clojure.pprint/pprint updated))))"

# Deploy changes
./deploy-mcp-config.sh "$CONFIG_FILE"
```

These examples demonstrate the flexibility and power of the MCP Bridge package for managing complex MCP configurations across diverse development environments.
