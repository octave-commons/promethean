---
```
uuid: 07397dd3-9360-4c8b-b515-9d7a8c818875
```
```
created_at: balanced-bst.md
```
```
filename: balanced-bst
```
```
title: balanced-bst
```
```
description: >-
```
  A generic balanced binary search tree (AVL) implementation with Map-like
  functionality, including floor/ceil, rank/select, and range iterators.
  Supports Olog n operations for efficient key-value management.
tags:
  - avl
  - bst
  - balanced
  - map
  - generic
  - iterable
  - rank
  - select
  - floor
  - ceil
```
related_to_uuid:
```
  - 7cfc230d-8ec2-4cdb-b931-8aec26de2a00
  - b09141b7-544f-4c8e-8f49-bf76cecaacbb
  - 008f2ac0-bfaa-4d52-9826-2d5e86c0059f
  - 7aa1eb92-7f9a-485b-8218-9b553aa9eefc
  - 15d25922-0de6-414f-b7d1-e50e2a57b33a
  - dd00677a-2280-45a7-91af-0728b21af3ad
  - 618198f4-cfad-4677-9df6-0640d8a97bae
  - 0580dcd3-533d-4834-8a2f-eae3771960a9
  - ac60a1d6-fd9f-46dc-bbe7-176dd8017c59
  - 72e4fd3c-7a07-4a95-91a3-6fca7f7fcaa3
  - de34f84b-270b-4f16-92a8-a681a869b823
  - 5c307293-04cb-4478-ba2c-4cd85dbec260
  - f2d83a77-7f86-4c56-8538-1350167a0c6c
  - d2b3628c-6cad-4664-8551-94ef8280851d
  - 3a3bf2c9-c0f6-4d7b-bf84-c83c70dece3f
  - d17d3a96-c84d-4738-a403-6c733b874da2
  - d8059b6a-c1ec-487d-8e0b-3ce33d6b4d06
  - 4330e8f0-5f46-4235-918b-39b6b93fa561
  - 10d98225-12e0-4212-8e15-88b57cf7bee5
  - 13951643-1741-46bb-89dc-1beebb122633
  - 18344cf9-0c49-4a71-b6c8-b8d84d660fca
  - 03a5578f-d689-45db-95e9-11300e5eee6f
  - 0f6f8f38-98d0-438f-9601-58f478acc0b7
  - 7b7ca860-780c-44fa-8d3f-be8bd9496fba
  - bb90903a-4723-44f7-850e-a71415ef6224
```
related_to_title:
```
  - field-dynamics-math-blocks
  - field-interaction-equations
  - eidolon-field-math-foundations
  - Board Walk – 2025-08-11
  - run-step-api
  - heartbeat-fragment-demo
  - AI-First-OS-Model-Context-Protocol
  - api-gateway-versioning
  - Board Automation Improvements
  - Git Commit Optimization for Code Reviews
  - Promethean Documentation Update
  - Self-Improving Documentation Tool
  - aionian-circuit-math
  - Language-Agnostic Mirror System
  - Promethean Documentation Pipeline Overview
  - Pure TypeScript Search Microservice
  - schema-evolution-workflow
  - Stateful Partitions and Rebalancing
  - Creative Moments
  - Duck's Attractor States
  - Promethean Chat Activity Report
  - Promethean Dev Workflow Update
  - windows-tiling-with-autohotkey
  - TypeScript Patch for Tool Calling Support
  - AGENTS.md
references:
  - uuid: d2b3628c-6cad-4664-8551-94ef8280851d
    line: 504
    col: 0
    score: 1
  - uuid: 2901a3e9-96f0-497c-ae2c-775f28a702dd
    line: 45
    col: 0
    score: 1
  - uuid: 7b7ca860-780c-44fa-8d3f-be8bd9496fba
    line: 560
    col: 0
    score: 1
  - uuid: bb7f0835-c347-474f-bfad-eabd873b51ad
    line: 187
    col: 0
    score: 1
  - uuid: 1f32c94a-4da4-4266-8ac0-6c282cfb401f
    line: 186
    col: 0
    score: 1
  - uuid: 22b989d5-f4aa-4880-8632-709c21830f83
    line: 212
    col: 0
    score: 1
  - uuid: e9b27b06-f608-4734-ae6c-f03a8b1fcf5f
    line: 162
    col: 0
    score: 1
  - uuid: dd00677a-2280-45a7-91af-0728b21af3ad
    line: 191
    col: 0
    score: 1
  - uuid: 37b5d236-2b3e-4a95-a4e8-31655c3023ef
    line: 233
    col: 0
    score: 1
  - uuid: 291c7d91-da8c-486c-9bc0-bd2254536e2d
    line: 129
    col: 0
    score: 1
  - uuid: d144aa62-348c-4e5d-ae8f-38084c67ceca
    line: 212
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 11
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 151
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 152
    col: 0
    score: 1
  - uuid: 0580dcd3-533d-4834-8a2f-eae3771960a9
    line: 286
    col: 0
    score: 1
  - uuid: 0580dcd3-533d-4834-8a2f-eae3771960a9
    line: 288
    col: 0
    score: 1
  - uuid: ac60a1d6-fd9f-46dc-bbe7-176dd8017c59
    line: 12
    col: 0
    score: 1
  - uuid: 7aa1eb92-7f9a-485b-8218-9b553aa9eefc
    line: 135
    col: 0
    score: 1
  - uuid: 7aa1eb92-7f9a-485b-8218-9b553aa9eefc
    line: 138
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 149
    col: 0
    score: 1
  - uuid: 0580dcd3-533d-4834-8a2f-eae3771960a9
    line: 285
    col: 0
    score: 1
  - uuid: 7aa1eb92-7f9a-485b-8218-9b553aa9eefc
    line: 134
    col: 0
    score: 1
  - uuid: 7cfc230d-8ec2-4cdb-b931-8aec26de2a00
    line: 193
    col: 0
    score: 1
  - uuid: 22b989d5-f4aa-4880-8632-709c21830f83
    line: 203
    col: 0
    score: 1
  - uuid: e9b27b06-f608-4734-ae6c-f03a8b1fcf5f
    line: 151
    col: 0
    score: 1
  - uuid: 1cfae310-35dc-49c2-98f1-b186da25d84b
    line: 281
    col: 0
    score: 1
  - uuid: dd00677a-2280-45a7-91af-0728b21af3ad
    line: 181
    col: 0
    score: 1
  - uuid: 37b5d236-2b3e-4a95-a4e8-31655c3023ef
    line: 220
    col: 0
    score: 1
  - uuid: 291c7d91-da8c-486c-9bc0-bd2254536e2d
    line: 110
    col: 0
    score: 1
  - uuid: ffb9b2a9-744d-4a53-9565-130fceae0832
    line: 118
    col: 0
    score: 1
  - uuid: e018dd7a-1fb7-4732-9e67-cd8b2f0831cf
    line: 329
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 160
    col: 0
    score: 1
  - uuid: ac60a1d6-fd9f-46dc-bbe7-176dd8017c59
    line: 19
    col: 0
    score: 1
  - uuid: 7aa1eb92-7f9a-485b-8218-9b553aa9eefc
    line: 160
    col: 0
    score: 1
  - uuid: 73d3dbf6-9240-46fd-ada9-cc2e7e00dc5f
    line: 426
    col: 0
    score: 1
  - uuid: f7702bf8-f7db-473c-9a5b-8dbf66ad3b9e
    line: 1534
    col: 0
    score: 1
  - uuid: ae24a280-678e-4c0b-8cc4-56667fa04172
    line: 610
    col: 0
    score: 1
  - uuid: 6deed6ac-2473-40e0-bee0-ac9ae4c7bff2
    line: 1262
    col: 0
    score: 1
  - uuid: e90b5a16-d58f-424d-bd36-70e9bd2861ad
    line: 863
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 161
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 162
    col: 0
    score: 1
  - uuid: 7aa1eb92-7f9a-485b-8218-9b553aa9eefc
    line: 163
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 291
    col: 0
    score: 1
  - uuid: 7aa1eb92-7f9a-485b-8218-9b553aa9eefc
    line: 164
    col: 0
    score: 1
  - uuid: 5e408692-0e74-400e-a617-84247c7353ad
    line: 247
    col: 0
    score: 1
  - uuid: ac60a1d6-fd9f-46dc-bbe7-176dd8017c59
    line: 24
    col: 0
    score: 1
  - uuid: 7aa1eb92-7f9a-485b-8218-9b553aa9eefc
    line: 165
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 164
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 238
    col: 0
    score: 1
  - uuid: ac60a1d6-fd9f-46dc-bbe7-176dd8017c59
    line: 26
    col: 0
    score: 1
  - uuid: 7aa1eb92-7f9a-485b-8218-9b553aa9eefc
    line: 167
    col: 0
    score: 1
  - uuid: 1c4046b5-742d-4004-aec6-b47251fef5d6
    line: 1045
    col: 0
    score: 1
  - uuid: 0f6f8f38-98d0-438f-9601-58f478acc0b7
    line: 2169
    col: 0
    score: 1
  - uuid: 7aa1eb92-7f9a-485b-8218-9b553aa9eefc
    line: 178
    col: 0
    score: 1
  - uuid: 1b1338fc-bb4d-41df-828f-e219cc9442eb
    line: 1167
    col: 0
    score: 1
  - uuid: 10d98225-12e0-4212-8e15-88b57cf7bee5
    line: 881
    col: 0
    score: 1
  - uuid: 13951643-1741-46bb-89dc-1beebb122633
    line: 1621
    col: 0
    score: 1
  - uuid: 008f2ac0-bfaa-4d52-9826-2d5e86c0059f
    line: 1860
    col: 0
    score: 1
  - uuid: 1cfae310-35dc-49c2-98f1-b186da25d84b
    line: 924
    col: 0
    score: 1
  - uuid: 18344cf9-0c49-4a71-b6c8-b8d84d660fca
    line: 873
    col: 0
    score: 1
  - uuid: 03a5578f-d689-45db-95e9-11300e5eee6f
    line: 1656
    col: 0
    score: 1
  - uuid: 1b1338fc-bb4d-41df-828f-e219cc9442eb
    line: 1168
    col: 0
    score: 1
  - uuid: 0b872af2-4197-46f3-b631-afb4e6135585
    line: 821
    col: 0
    score: 1
  - uuid: 0f6f8f38-98d0-438f-9601-58f478acc0b7
    line: 1736
    col: 0
    score: 1
  - uuid: 0580dcd3-533d-4834-8a2f-eae3771960a9
    line: 307
    col: 0
    score: 1
  - uuid: ac60a1d6-fd9f-46dc-bbe7-176dd8017c59
    line: 82
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 240
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 241
    col: 0
    score: 1
  - uuid: 0580dcd3-533d-4834-8a2f-eae3771960a9
    line: 308
    col: 0
    score: 1
  - uuid: ac60a1d6-fd9f-46dc-bbe7-176dd8017c59
    line: 56
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 270
    col: 0
    score: 1
  - uuid: 0580dcd3-533d-4834-8a2f-eae3771960a9
    line: 330
    col: 0
    score: 1
  - uuid: 1b1338fc-bb4d-41df-828f-e219cc9442eb
    line: 2285
    col: 0
    score: 1
  - uuid: 13951643-1741-46bb-89dc-1beebb122633
    line: 1881
    col: 0
    score: 1
  - uuid: 008f2ac0-bfaa-4d52-9826-2d5e86c0059f
    line: 3570
    col: 0
    score: 1
  - uuid: 18344cf9-0c49-4a71-b6c8-b8d84d660fca
    line: 1918
    col: 0
    score: 1
  - uuid: 03a5578f-d689-45db-95e9-11300e5eee6f
    line: 3412
    col: 0
    score: 1
  - uuid: 0b872af2-4197-46f3-b631-afb4e6135585
    line: 1621
    col: 0
    score: 1
  - uuid: 1c4046b5-742d-4004-aec6-b47251fef5d6
    line: 1817
    col: 0
    score: 1
  - uuid: 18138627-a348-4fbb-b447-410dfb400564
    line: 2012
    col: 0
    score: 1
  - uuid: 10d98225-12e0-4212-8e15-88b57cf7bee5
    line: 1553
    col: 0
    score: 1
  - uuid: 13951643-1741-46bb-89dc-1beebb122633
    line: 3791
    col: 0
    score: 1
  - uuid: 18344cf9-0c49-4a71-b6c8-b8d84d660fca
    line: 1624
    col: 0
    score: 1
  - uuid: 03a5578f-d689-45db-95e9-11300e5eee6f
    line: 4979
    col: 0
    score: 1
  - uuid: 0b872af2-4197-46f3-b631-afb4e6135585
    line: 1328
    col: 0
    score: 1
  - uuid: 1c4046b5-742d-4004-aec6-b47251fef5d6
    line: 1523
    col: 0
    score: 1
  - uuid: 03a5578f-d689-45db-95e9-11300e5eee6f
    line: 4404
    col: 0
    score: 1
  - uuid: 0b872af2-4197-46f3-b631-afb4e6135585
    line: 1200
    col: 0
    score: 1
  - uuid: 1c4046b5-742d-4004-aec6-b47251fef5d6
    line: 1384
    col: 0
    score: 1
  - uuid: 18138627-a348-4fbb-b447-410dfb400564
    line: 3691
    col: 0
    score: 1
  - uuid: ac60a1d6-fd9f-46dc-bbe7-176dd8017c59
    line: 83
    col: 0
    score: 1
  - uuid: 10d98225-12e0-4212-8e15-88b57cf7bee5
    line: 1417
    col: 0
    score: 1
  - uuid: 13951643-1741-46bb-89dc-1beebb122633
    line: 2992
    col: 0
    score: 1
  - uuid: 18344cf9-0c49-4a71-b6c8-b8d84d660fca
    line: 1500
    col: 0
    score: 1
  - uuid: 03a5578f-d689-45db-95e9-11300e5eee6f
    line: 4405
    col: 0
    score: 1
  - uuid: 0b872af2-4197-46f3-b631-afb4e6135585
    line: 1201
    col: 0
    score: 1
  - uuid: 1c4046b5-742d-4004-aec6-b47251fef5d6
    line: 1385
    col: 0
    score: 1
  - uuid: 18138627-a348-4fbb-b447-410dfb400564
    line: 3692
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 289
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 278
    col: 0
    score: 1
---
Yup—here’s a tight, generic **balanced BST** (AVL) you can drop in as `shared/js/prom-lib/ds/bst.ts`. It behaves like a `Map` with extras: `floor/ceil`, `rank/select`, range iterators, and Olog n ops. ^ref-d3e7db72-1-0 ^ref-6e678cce-1-0

```ts
// shared/js/prom-lib/ds/bst.ts
// MIT. Zero deps. Node + browser safe.
// Balanced Binary Search Tree (AVL). Generic K,V with custom comparator.

export type Cmp<K> = (a: K, b: K) => number;

export function defaultCmp(a: any, b: any): number {
  return a < b ? -1 : a > b ? 1 : 0;
}

class Node<K, V> {
  key: K;
  val: V;
  h = 1;     // height
  sz = 1;    // subtree size (for rank/select)
  left: Node<K, V> | null = null;
  right: Node<K, V> | null = null;
  constructor(key: K, val: V) { this.key = key; this.val = val; }
}

export class AVLTree<K, V> implements Iterable<[K, V]> {
  private root: Node<K, V> | null = null;
  private cmp: Cmp<K>;
  constructor(cmp: Cmp<K> = defaultCmp) { this.cmp = cmp; }

  //#region public API (Map-like)
  get size(): number { return this._sz(this.root); }
  clear(): void { this.root = null; }
  isEmpty(): boolean { return this.root === null; }

  has(key: K): boolean { return this.get(key) !== undefined; }

  get(key: K): V | undefined {
    let n = this.root;
    while (n) {
      const d = this.cmp(key, n.key);
      if (d === 0) return n.val;
      n = d < 0 ? n.left : n.right;
    }
    return undefined;
  }

  /** Set (upsert). Returns previous value if key existed. */
  set(key: K, val: V): V | undefined {
    let old: V | undefined;
    const rec = (n: Node<K,V> | null): Node<K,V> => {
      if (!n) return new Node(key, val);
      const d = this.cmp(key, n.key);
      if (d === 0) { old = n.val; n.val = val; return n; }
      if (d < 0) n.left = rec(n.left); else n.right = rec(n.right);
      return this._rebalance(this._fix(n));
    };
    this.root = rec(this.root);
    return old;
  }

  /** Delete by key. Returns removed value if present. */
  delete(key: K): V | undefined {
    let removed: V | undefined;
    const rec = (n: Node<K,V> | null): Node<K,V> | null => {
      if (!n) return null;
      const d = this.cmp(key, n.key);
      if (d < 0) { n.left = rec(n.left); return this._rebalance(this._fix(n)); }
      if (d > 0) { n.right = rec(n.right); return this._rebalance(this._fix(n)); }
      // found
      removed = n.val;
      if (!n.left) return n.right;
      if (!n.right) return n.left;
      // two children: swap with successor
      const s = this._minNode(n.right);
      n.key = s.key; n.val = s.val;
      n.right = this._deleteMin(n.right);
      return this._rebalance(this._fix(n));
    };
    this.root = rec(this.root);
    return removed;
  }

  /** Minimum entry */
  firstEntry(): [K, V] | undefined {
    const n = this._minNode(this.root);
    return n ? [n.key, n.val] : undefined;
  }
  /** Maximum entry */
  lastEntry(): [K, V] | undefined {
    const n = this._maxNode(this.root);
    return n ? [n.key, n.val] : undefined;
  }

  /** Greatest key <= given key */
  floor(key: K): [K, V] | undefined {
    let n = this.root, best: Node<K,V> | null = null;
    while (n) {
      const d = this.cmp(key, n.key);
      if (d === 0) return [n.key, n.val];
      if (d < 0) n = n.left; else { best = n; n = n.right; }
    }
    return best ? [best.key, best.val] : undefined;
  }
  /** Smallest key >= given key */
  ceil(key: K): [K, V] | undefined {
    let n = this.root, best: Node<K,V> | null = null;
    while (n) {
      const d = this.cmp(key, n.key);
      if (d === 0) return [n.key, n.val];
      if (d > 0) n = n.right; else { best = n; n = n.left; }
    }
    return best ? [best.key, best.val] : undefined;
  }

  /** Number of keys < given key */
  rank(key: K): number {
    let n = this.root, r = 0;
    while (n) {
      const d = this.cmp(key, n.key);
      if (d <= 0) n = n.left;
      else { r += 1 + this._sz(n.left); n = n.right; }
    }
    return r;
  }

  /** k-th (0-based) entry by order */
  select(k: number): [K, V] | undefined {
    if (k < 0 || k >= this.size) return undefined;
    let n = this.root;
    while (n) {
      const ls = this._sz(n.left);
      if (k < ls) n = n.left;
      else if (k > ls) { k -= ls + 1; n = n.right; }
      else return [n.key, n.val];
    }
    return undefined;
  }

  /** In-order traversal (ascending) */
  forEach(fn: (val: V, key: K) => void): void { this._inOrder(this.root, fn); }

  keys(): IterableIterator<K> {
    const it = this[Symbol.iterator]();
    return (function*() { for (const [k] of it) yield k; })();
  }
  values(): IterableIterator<V> {
    const it = this[Symbol.iterator]();
    return (function*() { for (const [,v] of it) yield v; })();
  }

  /** Range iterator: lo <= key <= hi (inclusive by default) */
  *range(lo: K, hi: K, opts: { inclusiveLo?: boolean; inclusiveHi?: boolean } = {}): IterableIterator<[K,V]> {
    const inclL = opts.inclusiveLo ?? true, inclH = opts.inclusiveHi ?? true;
    function cmpIn(cmp: Cmp<K>, k: K, lo: K, hi: K) {
      const dl = cmp(k, lo), dh = cmp(k, hi);
      return (inclL ? dl >= 0 : dl > 0) && (inclH ? dh <= 0 : dh < 0);
    }
    const stack: Node<K,V>[] = [];
    let n = this.root;
    while (n) { stack.push(n); n = this.cmp(lo, n.key) <= 0 ? n.left : n.right; }
    while (stack.length) {
      const cur = stack.pop()!;
      if (this.cmp(cur.key, lo) >= 0 && cur.left) {
        let t = cur.left;
        while (t) { stack.push(t); t = t.right; }
      }
      if (cmpIn(this.cmp, cur.key, lo, hi)) yield [cur.key, cur.val];
      if (this.cmp(cur.key, hi) < 0 && cur.right) {
        let t = cur.right;
        while (t) { stack.push(t); t = t.left; }
      }
    }
  }

  /** In-order iterator (ascending) */
  *[Symbol.iterator](): IterableIterator<[K, V]> {
    const st: Node<K,V>[] = [];
    let n = this.root;
    while (n) { st.push(n); n = n.left; }
    while (st.length) {
      const x = st.pop()!;
      yield [x.key, x.val];
      let r = x.right;
      while (r) { st.push(r); r = r.left; }
    }
  }

  /** Height (0 for empty, else node.h) */
  height(): number { return this.root ? this.root.h : 0; }

  /** Sanity checks (throws on violation) */
  validate(): void {
    const dfs = (n: Node<K,V> | null, min?: K, max?: K): [number, number] => {
      if (!n) return [0, 0];
      if (min !== undefined && this.cmp(n.key, min) <= 0) throw new Error("BST invariant (min) broken");
      if (max !== undefined && this.cmp(n.key, max) >= 0) throw new Error("BST invariant (max) broken");
      const [hl, sl] = dfs(n.left, min, n.key);
      const [hr, sr] = dfs(n.right, n.key, max);
      const h = Math.max(hl, hr) + 1;
      const sz = sl + sr + 1;
      const bf = hr - hl;
      if (Math.abs(bf) > 1) throw new Error("AVL balance broken");
      if (n.h !== h || n.sz !== sz) throw new Error("metadata out-of-sync");
      return [h, sz];
    };
    dfs(this.root);
  }
  //#endregion

  //#region internals
  private _h(n: Node<K,V> | null): number { return n ? n.h : 0; }
  private _sz(n: Node<K,V> | null): number { return n ? n.sz : 0; }
  private _fix(n: Node<K,V>): Node<K,V> { n.h = Math.max(this._h(n.left), this._h(n.right)) + 1; n.sz = this._sz(n.left) + this._sz(n.right) + 1; return n; }
  private _bf(n: Node<K,V>): number { return this._h(n.right) - this._h(n.left); }

  private _rotL(a: Node<K,V>): Node<K,V> {
    const b = a.right!; a.right = b.left; b.left = this._fix(a); return this._fix(b);
  }
  private _rotR(a: Node<K,V>): Node<K,V> {
    const b = a.left!; a.left = b.right; b.right = this._fix(a); return this._fix(b);
  }
  private _rebalance(n: Node<K,V>): Node<K,V> {
    const bf = this._bf(n);
    if (bf === 2) {
      if (this._bf(n.right!) < 0) n.right = this._rotR(n.right!);
      return this._rotL(n);
    }
    if (bf === -2) {
      if (this._bf(n.left!) > 0) n.left = this._rotL(n.left!);
      return this._rotR(n);
    }
    return n;
  }

  private _minNode(n: Node<K,V> | null): Node<K,V> {
    if (!n) throw new Error("empty");
    while (n.left) n = n.left;
    return n;
  }
  private _maxNode(n: Node<K,V> | null): Node<K,V> {
    if (!n) throw new Error("empty");
    while (n.right) n = n.right;
    return n;
  }
  private _deleteMin(n: Node<K,V> | null): Node<K,V> | null {
    if (!n) return null;
    if (!n.left) return n.right;
    n.left = this._deleteMin(n.left);
    return this._rebalance(this._fix(n));
  }
  //#endregion

  //#region builders / utils
  static fromPairs<K, V>(pairs: Iterable<[K, V]>, cmp: Cmp<K> = defaultCmp): AVLTree<K, V> {
    const t = new AVLTree<K,V>(cmp);
    for (const [k, v] of pairs) t.set(k, v);
    return t;
  }
  toArray(): [K, V][] { return Array.from(this); }
  //#endregion
}

// Convenience alias if you prefer the generic name
export const BST = AVLTree;
```
```
^ref-6e678cce-3-0
```
```
^ref-d3e7db72-3-0
```
## Quick usage
```
^ref-d3e7db72-268-0
```
```ts
import { AVLTree } from "./bst";

const t = new AVLTree<number, string>();
t.set(5, "e"); t.set(2, "b"); t.set(8, "h"); t.set(3, "c"); t.set(7, "g");

console.log(t.get(3));                 // "c"
console.log(t.firstEntry());           // [2,"b"]
console.log(t.lastEntry());            // [8,"h"]
console.log(t.floor(6));               // [5,"e"]
console.log(t.ceil(6));                // [7,"g"]
console.log(t.rank(7));                // 3 (there are 3 keys < 7)
console.log(t.select(2));              // [5,"e"]
console.log([...t.range(3,7)]);        // [[3,"c"],[5,"e"],[7,"g"]]
console.log([...t]);                   // in-order entries
t.validate();                          // throws if invariants broken
^ref-d3e7db72-268-0
```

## Notes ^ref-d3e7db72-288-0
```
^ref-d3e7db72-289-0
```
* All operations are **Olog n** AVL-balanced. ^ref-d3e7db72-290-0
* `rank/select` ride on subtree sizes; great for order-statistics queries. ^ref-d3e7db72-291-0
* Keys must be comparable; pass your own `cmp` for strings, dates, custom IDs, etc. ^ref-6e678cce-293-0
* If you want **multimap** semantics (duplicate keys), easiest path is to store an array value or make the value a small list. ^ref-d3e7db72-293-0

Want a **persistent/immutable** variant (functional tree), or a **Treap** / **Red-Black** flavor? I can drop those too.
 ^ref-d3e7db72-299-0 ^ref-d3e7db72-304-0 ^ref-d3e7db72-306-0 ^ref-d3e7db72-308-0 ^ref-d3e7db72-309-0 ^ref-d3e7db72-310-0 ^ref-d3e7db72-311-0 ^ref-d3e7db72-313-0 ^ref-d3e7db72-324-0 ^ref-d3e7db72-330-0 ^ref-d3e7db72-333-0 ^ref-d3e7db72-335-0 ^ref-d3e7db72-363-0 ^ref-d3e7db72-365-0 ^ref-d3e7db72-370-0 ^ref-d3e7db72-390-0
<!-- GENERATED-SECTIONS:DO-NOT-EDIT-BELOW -->
## Related content
- [docs/unique/field-dynamics-math-blocks|field-dynamics-math-blocks]
- [docs/unique/field-interaction-equations|field-interaction-equations]
- [docs/unique/eidolon-field-math-foundations|eidolon-field-math-foundations]
- [board-walk-2025-08-11|Board Walk – 2025-08-11]
- [run-step-api]
- [heartbeat-fragment-demo]
- [ai-first-os-model-context-protocol]
- [api-gateway-versioning]
- [board-automation-improvements|Board Automation Improvements]
- [git-commit-optimization-for-code-reviews|Git Commit Optimization for Code Reviews]
- [Promethean Documentation Update]promethean-documentation-update-3.md
- [self-improving-documentation-tool|Self-Improving Documentation Tool]
- [docs/unique/aionian-circuit-math|aionian-circuit-math]
- [language-agnostic-mirror-system|Language-Agnostic Mirror System]
- [promethean-documentation-pipeline-overview|Promethean Documentation Pipeline Overview]
- [pure-typescript-search-microservice|Pure TypeScript Search Microservice]
- [schema-evolution-workflow]
- [stateful-partitions-and-rebalancing|Stateful Partitions and Rebalancing]
- [creative-moments|Creative Moments]
- [ducks-attractor-states|Duck's Attractor States]
- [promethean-chat-activity-report|Promethean Chat Activity Report]
- [promethean-dev-workflow-update|Promethean Dev Workflow Update]
- [windows-tiling-with-autohotkey]
- [typescript-patch-for-tool-calling-support|TypeScript Patch for Tool Calling Support]
- [AGENTS.md]agents-md.md
## Sources
- [language-agnostic-mirror-system#^ref-d2b3628c-504-0|Language-Agnostic Mirror System — L504] (line 504, col 0, score 1)
- [admin-dashboard-for-user-management#^ref-2901a3e9-45-0|Admin Dashboard for User Management — L45] (line 45, col 0, score 1)
- [typescript-patch-for-tool-calling-support#^ref-7b7ca860-560-0|TypeScript Patch for Tool Calling Support — L560] (line 560, col 0, score 1)
- [agent-reflections-and-prompt-evolution#^ref-bb7f0835-187-0|Agent Reflections and Prompt Evolution — L187] (line 187, col 0, score 1)
- [field-node-diagram-outline#^ref-1f32c94a-186-0|field-node-diagram-outline — L186] (line 186, col 0, score 1)
- [field-node-diagram-set#^ref-22b989d5-212-0|field-node-diagram-set — L212] (line 212, col 0, score 1)
- field-node-diagram-visualizations — L162$field-node-diagram-visualizations.md#^ref-e9b27b06-162-0 (line 162, col 0, score 1)
- [heartbeat-fragment-demo#^ref-dd00677a-191-0|heartbeat-fragment-demo — L191] (line 191, col 0, score 1)
- [homeostasis-decay-formulas#^ref-37b5d236-233-0|homeostasis-decay-formulas — L233] (line 233, col 0, score 1)
- [ice-box-reorganization#^ref-291c7d91-129-0|Ice Box Reorganization — L129] (line 129, col 0, score 1)
- [model-selection-for-lightweight-conversational-tasks#^ref-d144aa62-212-0|Model Selection for Lightweight Conversational Tasks — L212] (line 212, col 0, score 1)
- [ai-first-os-model-context-protocol#^ref-618198f4-11-0|AI-First-OS-Model-Context-Protocol — L11] (line 11, col 0, score 1)
- [docs/unique/aionian-circuit-math#^ref-f2d83a77-151-0|aionian-circuit-math — L151] (line 151, col 0, score 1)
- [docs/unique/aionian-circuit-math#^ref-f2d83a77-152-0|aionian-circuit-math — L152] (line 152, col 0, score 1)
- [api-gateway-versioning#^ref-0580dcd3-286-0|api-gateway-versioning — L286] (line 286, col 0, score 1)
- [api-gateway-versioning#^ref-0580dcd3-288-0|api-gateway-versioning — L288] (line 288, col 0, score 1)
- [board-automation-improvements#^ref-ac60a1d6-12-0|Board Automation Improvements — L12] (line 12, col 0, score 1)
- [board-walk-2025-08-11#^ref-7aa1eb92-135-0|Board Walk – 2025-08-11 — L135] (line 135, col 0, score 1)
- [board-walk-2025-08-11#^ref-7aa1eb92-138-0|Board Walk – 2025-08-11 — L138] (line 138, col 0, score 1)
- [docs/unique/aionian-circuit-math#^ref-f2d83a77-149-0|aionian-circuit-math — L149] (line 149, col 0, score 1)
- [api-gateway-versioning#^ref-0580dcd3-285-0|api-gateway-versioning — L285] (line 285, col 0, score 1)
- [board-walk-2025-08-11#^ref-7aa1eb92-134-0|Board Walk – 2025-08-11 — L134] (line 134, col 0, score 1)
- [docs/unique/field-dynamics-math-blocks#^ref-7cfc230d-193-0|field-dynamics-math-blocks — L193] (line 193, col 0, score 1)
- [field-node-diagram-set#^ref-22b989d5-203-0|field-node-diagram-set — L203] (line 203, col 0, score 1)
- field-node-diagram-visualizations — L151$field-node-diagram-visualizations.md#^ref-e9b27b06-151-0 (line 151, col 0, score 1)
- [functional-refactor-of-typescript-document-processing#^ref-1cfae310-281-0|Functional Refactor of TypeScript Document Processing — L281] (line 281, col 0, score 1)
- [heartbeat-fragment-demo#^ref-dd00677a-181-0|heartbeat-fragment-demo — L181] (line 181, col 0, score 1)
- [homeostasis-decay-formulas#^ref-37b5d236-220-0|homeostasis-decay-formulas — L220] (line 220, col 0, score 1)
- [ice-box-reorganization#^ref-291c7d91-110-0|Ice Box Reorganization — L110] (line 110, col 0, score 1)
- [docs/unique/obsidian-ignore-node-modules-regex#^ref-ffb9b2a9-118-0|obsidian-ignore-node-modules-regex — L118] (line 118, col 0, score 1)
- [ParticleSimulationWithCanvasAndFFmpeg — L329]particlesimulationwithcanvasandffmpeg.md#^ref-e018dd7a-329-0 (line 329, col 0, score 1)
- [docs/unique/aionian-circuit-math#^ref-f2d83a77-160-0|aionian-circuit-math — L160] (line 160, col 0, score 1)
- [board-automation-improvements#^ref-ac60a1d6-19-0|Board Automation Improvements — L19] (line 19, col 0, score 1)
- [board-walk-2025-08-11#^ref-7aa1eb92-160-0|Board Walk – 2025-08-11 — L160] (line 160, col 0, score 1)
- [Debugging Broker Connections and Agent Behavior — L426]debugging-broker-connections-and-agent-behavior.md#^ref-73d3dbf6-426-0 (line 426, col 0, score 1)
- [dynamic-context-model-for-web-components#^ref-f7702bf8-1534-0|Dynamic Context Model for Web Components — L1534] (line 1534, col 0, score 1)
- [promethean-copilot-intent-engine#^ref-ae24a280-610-0|Promethean-Copilot-Intent-Engine — L610] (line 610, col 0, score 1)
- [promethean-infrastructure-setup#^ref-6deed6ac-1262-0|Promethean Infrastructure Setup — L1262] (line 1262, col 0, score 1)
- [prometheus-observability-stack#^ref-e90b5a16-863-0|Prometheus Observability Stack — L863] (line 863, col 0, score 1)
- [docs/unique/aionian-circuit-math#^ref-f2d83a77-161-0|aionian-circuit-math — L161] (line 161, col 0, score 1)
- [docs/unique/aionian-circuit-math#^ref-f2d83a77-162-0|aionian-circuit-math — L162] (line 162, col 0, score 1)
- [board-walk-2025-08-11#^ref-7aa1eb92-163-0|Board Walk – 2025-08-11 — L163] (line 163, col 0, score 1)
- [docs/unique/aionian-circuit-math#^ref-f2d83a77-291-0|aionian-circuit-math — L291] (line 291, col 0, score 1)
- [board-walk-2025-08-11#^ref-7aa1eb92-164-0|Board Walk – 2025-08-11 — L164] (line 164, col 0, score 1)
- [i3-bluetooth-setup#^ref-5e408692-247-0|i3-bluetooth-setup — L247] (line 247, col 0, score 1)
- [board-automation-improvements#^ref-ac60a1d6-24-0|Board Automation Improvements — L24] (line 24, col 0, score 1)
- [board-walk-2025-08-11#^ref-7aa1eb92-165-0|Board Walk – 2025-08-11 — L165] (line 165, col 0, score 1)
- [docs/unique/aionian-circuit-math#^ref-f2d83a77-164-0|aionian-circuit-math — L164] (line 164, col 0, score 1)
- [docs/unique/aionian-circuit-math#^ref-f2d83a77-238-0|aionian-circuit-math — L238] (line 238, col 0, score 1)
- [board-automation-improvements#^ref-ac60a1d6-26-0|Board Automation Improvements — L26] (line 26, col 0, score 1)
- [board-walk-2025-08-11#^ref-7aa1eb92-167-0|Board Walk – 2025-08-11 — L167] (line 167, col 0, score 1)
- [promethean-notes#^ref-1c4046b5-1045-0|Promethean Notes — L1045] (line 1045, col 0, score 1)
- [windows-tiling-with-autohotkey#^ref-0f6f8f38-2169-0|windows-tiling-with-autohotkey — L2169] (line 2169, col 0, score 1)
- [board-walk-2025-08-11#^ref-7aa1eb92-178-0|Board Walk – 2025-08-11 — L178] (line 178, col 0, score 1)
- Canonical Org-Babel Matplotlib Animation Template — L1167$canonical-org-babel-matplotlib-animation-template.md#^ref-1b1338fc-1167-0 (line 1167, col 0, score 1)
- [creative-moments#^ref-10d98225-881-0|Creative Moments — L881] (line 881, col 0, score 1)
- [ducks-attractor-states#^ref-13951643-1621-0|Duck's Attractor States — L1621] (line 1621, col 0, score 1)
- [docs/unique/eidolon-field-math-foundations#^ref-008f2ac0-1860-0|eidolon-field-math-foundations — L1860] (line 1860, col 0, score 1)
- [functional-refactor-of-typescript-document-processing#^ref-1cfae310-924-0|Functional Refactor of TypeScript Document Processing — L924] (line 924, col 0, score 1)
- [promethean-chat-activity-report#^ref-18344cf9-873-0|Promethean Chat Activity Report — L873] (line 873, col 0, score 1)
- [promethean-dev-workflow-update#^ref-03a5578f-1656-0|Promethean Dev Workflow Update — L1656] (line 1656, col 0, score 1)
- Canonical Org-Babel Matplotlib Animation Template — L1168$canonical-org-babel-matplotlib-animation-template.md#^ref-1b1338fc-1168-0 (line 1168, col 0, score 1)
- [promethean-documentation-update.txt#^ref-0b872af2-821-0|Promethean Documentation Update — L821] (line 821, col 0, score 1)
- [windows-tiling-with-autohotkey#^ref-0f6f8f38-1736-0|windows-tiling-with-autohotkey — L1736] (line 1736, col 0, score 1)
- [api-gateway-versioning#^ref-0580dcd3-307-0|api-gateway-versioning — L307] (line 307, col 0, score 1)
- [board-automation-improvements#^ref-ac60a1d6-82-0|Board Automation Improvements — L82] (line 82, col 0, score 1)
- [docs/unique/aionian-circuit-math#^ref-f2d83a77-240-0|aionian-circuit-math — L240] (line 240, col 0, score 1)
- [docs/unique/aionian-circuit-math#^ref-f2d83a77-241-0|aionian-circuit-math — L241] (line 241, col 0, score 1)
- [api-gateway-versioning#^ref-0580dcd3-308-0|api-gateway-versioning — L308] (line 308, col 0, score 1)
- [board-automation-improvements#^ref-ac60a1d6-56-0|Board Automation Improvements — L56] (line 56, col 0, score 1)
- [docs/unique/aionian-circuit-math#^ref-f2d83a77-270-0|aionian-circuit-math — L270] (line 270, col 0, score 1)
- [api-gateway-versioning#^ref-0580dcd3-330-0|api-gateway-versioning — L330] (line 330, col 0, score 1)
- Canonical Org-Babel Matplotlib Animation Template — L2285$canonical-org-babel-matplotlib-animation-template.md#^ref-1b1338fc-2285-0 (line 2285, col 0, score 1)
- [ducks-attractor-states#^ref-13951643-1881-0|Duck's Attractor States — L1881] (line 1881, col 0, score 1)
- [docs/unique/eidolon-field-math-foundations#^ref-008f2ac0-3570-0|eidolon-field-math-foundations — L3570] (line 3570, col 0, score 1)
- [promethean-chat-activity-report#^ref-18344cf9-1918-0|Promethean Chat Activity Report — L1918] (line 1918, col 0, score 1)
- [promethean-dev-workflow-update#^ref-03a5578f-3412-0|Promethean Dev Workflow Update — L3412] (line 3412, col 0, score 1)
- [promethean-documentation-update.txt#^ref-0b872af2-1621-0|Promethean Documentation Update — L1621] (line 1621, col 0, score 1)
- [promethean-notes#^ref-1c4046b5-1817-0|Promethean Notes — L1817] (line 1817, col 0, score 1)
- [the-jar-of-echoes#^ref-18138627-2012-0|The Jar of Echoes — L2012] (line 2012, col 0, score 1)
- [creative-moments#^ref-10d98225-1553-0|Creative Moments — L1553] (line 1553, col 0, score 1)
- [ducks-attractor-states#^ref-13951643-3791-0|Duck's Attractor States — L3791] (line 3791, col 0, score 1)
- [promethean-chat-activity-report#^ref-18344cf9-1624-0|Promethean Chat Activity Report — L1624] (line 1624, col 0, score 1)
- [promethean-dev-workflow-update#^ref-03a5578f-4979-0|Promethean Dev Workflow Update — L4979] (line 4979, col 0, score 1)
- [promethean-documentation-update.txt#^ref-0b872af2-1328-0|Promethean Documentation Update — L1328] (line 1328, col 0, score 1)
- [promethean-notes#^ref-1c4046b5-1523-0|Promethean Notes — L1523] (line 1523, col 0, score 1)
- [promethean-dev-workflow-update#^ref-03a5578f-4404-0|Promethean Dev Workflow Update — L4404] (line 4404, col 0, score 1)
- [promethean-documentation-update.txt#^ref-0b872af2-1200-0|Promethean Documentation Update — L1200] (line 1200, col 0, score 1)
- [promethean-notes#^ref-1c4046b5-1384-0|Promethean Notes — L1384] (line 1384, col 0, score 1)
- [the-jar-of-echoes#^ref-18138627-3691-0|The Jar of Echoes — L3691] (line 3691, col 0, score 1)
- [board-automation-improvements#^ref-ac60a1d6-83-0|Board Automation Improvements — L83] (line 83, col 0, score 1)
- [creative-moments#^ref-10d98225-1417-0|Creative Moments — L1417] (line 1417, col 0, score 1)
- [ducks-attractor-states#^ref-13951643-2992-0|Duck's Attractor States — L2992] (line 2992, col 0, score 1)
- [promethean-chat-activity-report#^ref-18344cf9-1500-0|Promethean Chat Activity Report — L1500] (line 1500, col 0, score 1)
- [promethean-dev-workflow-update#^ref-03a5578f-4405-0|Promethean Dev Workflow Update — L4405] (line 4405, col 0, score 1)
- [promethean-documentation-update.txt#^ref-0b872af2-1201-0|Promethean Documentation Update — L1201] (line 1201, col 0, score 1)
- [promethean-notes#^ref-1c4046b5-1385-0|Promethean Notes — L1385] (line 1385, col 0, score 1)
- [the-jar-of-echoes#^ref-18138627-3692-0|The Jar of Echoes — L3692] (line 3692, col 0, score 1)
- [docs/unique/aionian-circuit-math#^ref-f2d83a77-289-0|aionian-circuit-math — L289] (line 289, col 0, score 1)
- [docs/unique/aionian-circuit-math#^ref-f2d83a77-278-0|aionian-circuit-math — L278] (line 278, col 0, score 1)
<!-- GENERATED-SECTIONS:DO-NOT-EDIT-ABOVE -->
