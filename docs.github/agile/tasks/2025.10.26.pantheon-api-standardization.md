---
uuid: "pantheon-arch-005"
title: "Standardize Pantheon API Interfaces and Error Handling"
slug: "2025.10.26.pantheon-api-standardization"
status: "incoming"
priority: "P1"
labels: ["pantheon", "architecture", "api", "error-handling", "standards"]
created_at: "2025-10-26T20:20:00.000Z"
estimates:
  complexity: "medium"
  scale: "feature"
  time_to_completion: "1 week"
---

## Context

Standardize inconsistent port/adapter interfaces and implement comprehensive error handling throughout the Pantheon framework to improve reliability and maintainability.

## Current Issues

### Interface Inconsistencies
```typescript
// packages/pantheon/src/core/ports.ts
export interface ContextPort {
  compile(sources: string[], text: string): Promise<Context>;
}

// packages/pantheon/src/cli/index.ts - Actual usage differs
await contextPort.compile({
  texts: options.text ? [options.text] : [],
  sources,
});
```

### Error Handling Problems
```typescript
// Generic error handling throughout CLI
} catch (error) {
  console.error('Error creating actor:', error);
  process.exit(1);
}
```

## Solution Required

### 1. Interface Standardization
- Consistent method signatures across all ports
- Standardized request/response objects
- Type-safe interfaces with proper generics
- Clear separation between ports and adapters

### 2. Error Handling Strategy
- Custom error types for different failure modes
- Structured error responses
- Error recovery mechanisms
- User-friendly error messages

### 3. Files to Modify
- `packages/pantheon/src/core/ports.ts` - Standardize all interfaces
- `packages/pantheon/src/core/errors.ts` - Custom error types
- `packages/pantheon/src/core/orchestrator.ts` - Update to use standardized interfaces
- `packages/pantheon/src/adapters/` - Update all adapters
- `packages/pantheon/src/cli/index.ts` - Implement proper error handling

## Acceptance Criteria

- [ ] All port interfaces standardized and consistent
- [ ] Custom error types for all failure modes
- [ ] Structured error handling in CLI
- [ ] Error recovery mechanisms implemented
- [ ] Type safety maintained throughout
- [ ] Comprehensive error logging
- [ ] User-friendly error messages

## Technical Implementation

### Standardized Port Interfaces
```typescript
// Base request/response types
export interface BaseRequest {
  id?: string;
  timestamp?: number;
  userId?: string;
}

export interface BaseResponse {
  id: string;
  success: boolean;
  data?: unknown;
  error?: ErrorInfo;
  timestamp: number;
}

export interface ErrorInfo {
  code: string;
  message: string;
  details?: unknown;
  recoverable: boolean;
}

// Standardized ContextPort
export interface ContextPort {
  compile(request: ContextCompileRequest): Promise<ContextCompileResponse>;
  get(request: ContextGetRequest): Promise<ContextGetResponse>;
  save(request: ContextSaveRequest): Promise<ContextSaveResponse>;
}

export interface ContextCompileRequest extends BaseRequest {
  texts?: string[];
  sources?: ContextSource[];
  options?: ContextCompileOptions;
}

export interface ContextCompileResponse extends BaseResponse {
  data?: CompiledContext;
}
```

### Custom Error Types
```typescript
export class PantheonError extends Error {
  constructor(
    message: string,
    public code: string,
    public details?: any,
    public recoverable: boolean = false,
    public userId?: string
  ) {
    super(message);
    this.name = 'PantheonError';
  }
}

export class ValidationError extends PantheonError {
  constructor(message: string, details?: any) {
    super(message, 'VALIDATION_ERROR', details, true);
    this.name = 'ValidationError';
  }
}

export class AuthenticationError extends PantheonError {
  constructor(message: string) {
    super(message, 'AUTHENTICATION_ERROR', undefined, false);
    this.name = 'AuthenticationError';
  }
}

export class AuthorizationError extends PantheonError {
  constructor(message: string, details?: any) {
    super(message, 'AUTHORIZATION_ERROR', details, false);
    this.name = 'AuthorizationError';
  }
}

export class ResourceNotFoundError extends PantheonError {
  constructor(resource: string, id: string) {
    super(
      `${resource} with id '${id}' not found`,
      'RESOURCE_NOT_FOUND',
      { resource, id },
      true
    );
    this.name = 'ResourceNotFoundError';
  }
}
```

### Error Handling Middleware
```typescript
export const errorHandler = (
  error: unknown,
  context: { userId?: string; operation?: string }
): BaseResponse => {
  const response: BaseResponse = {
    id: generateId(),
    success: false,
    timestamp: Date.now(),
  };

  if (error instanceof PantheonError) {
    response.error = {
      code: error.code,
      message: error.message,
      details: error.details,
      recoverable: error.recoverable,
    };
  } else if (error instanceof Error) {
    response.error = {
      code: 'UNKNOWN_ERROR',
      message: 'An unexpected error occurred',
      details: process.env.NODE_ENV === 'development' ? error.message : undefined,
      recoverable: false,
    };
  } else {
    response.error = {
      code: 'UNKNOWN_ERROR',
      message: 'An unexpected error occurred',
      recoverable: false,
    };
  }

  // Log error for debugging
  console.error('Error in operation:', context.operation, {
    userId: context.userId,
    error: response.error,
  });

  return response;
};
```

### CLI Error Handling
```typescript
const handleCliError = (error: unknown, operation: string): never => {
  if (error instanceof ValidationError) {
    console.error(`‚ùå Validation Error: ${error.message}`);
    if (error.details) {
      console.error('Details:', JSON.stringify(error.details, null, 2));
    }
    process.exit(1);
  }

  if (error instanceof AuthenticationError) {
    console.error(`üîê Authentication Error: ${error.message}`);
    console.error('Please check your credentials and try again.');
    process.exit(1);
  }

  if (error instanceof AuthorizationError) {
    console.error(`üö´ Authorization Error: ${error.message}`);
    console.error('You do not have permission to perform this action.');
    process.exit(1);
  }

  if (error instanceof ResourceNotFoundError) {
    console.error(`üîç Not Found: ${error.message}`);
    process.exit(1);
  }

  if (error instanceof PantheonError && error.recoverable) {
    console.error(`‚ö†Ô∏è  Recoverable Error: ${error.message}`);
    process.exit(2); // Different exit code for recoverable errors
  }

  // Unknown error
  console.error(`üí• Unexpected Error: ${error instanceof Error ? error.message : 'Unknown error'}`);
  if (process.env.NODE_ENV === 'development') {
    console.error('Stack trace:', error instanceof Error ? error.stack : 'No stack trace');
  }
  process.exit(1);
};
```

### Updated CLI Commands
```typescript
program
  .command('actor:create')
  .argument('<type>', 'Actor type')
  .argument('<name>', 'Actor name')
  .action(async (type, name, options) => {
    try {
      const result = await createActor({
        type,
        name,
        goal: options.goal,
        config: options.config,
      });
      
      console.log(`‚úÖ Actor created: ${result.id}`);
    } catch (error) {
      handleCliError(error, 'actor:create');
    }
  });
```

## Risk Level

**MEDIUM** - Architecture and reliability improvements

## Dependencies

- Depends on: "Add Input Validation and Sanitization to Pantheon"

## Benefits

- Improved type safety and developer experience
- Consistent error handling across all components
- Better debugging and troubleshooting
- Easier maintenance and extension
- Professional user experience
