# Migrate to Unified Storage Backend

## Overview
Consolidate storage to use MongoDB for documents and ChromaDB for vectors with proper write-ahead logging and consistent error handling.

## Context
Current storage is fragmented:
- DualStoreManager trying to be both vector and document store
- Multiple MongoDB collections with inconsistent schemas
- ChromaDB collections with different naming conventions
- No transactional consistency between stores
- Silent failures in dual write operations

## Acceptance Criteria
- [ ] MongoDB as primary document store
- [ ] ChromaDB as vector store only
- [ ] Write-ahead logging for consistency
- [ ] Transaction-like behavior where possible
- [ ] Migration utilities for existing data
- [ ] Consistent error handling and recovery

## Implementation Plan
1. **Phase 1**: Design unified storage schema
2. **Phase 2**: Implement write-ahead logging
3. **Phase 3**: Create migration utilities
4. **Phase 4**: Migrate existing data
5. **Phase 5**: Implement consistency checks

## Technical Details
### Storage Architecture
```typescript
interface UnifiedStorage {
  documents: MongoCollection; // Primary document store
  vectors: ChromaCollection;  // Vector embeddings only
  wal: WriteAheadLog;        // Consistency and recovery
}

interface DocumentRecord {
  _id: ObjectId;
  contentId: string;
  type: ContentType;
  content: string;
  metadata: Record<string, any>;
  timestamp: Date;
  vectorId?: string; // Reference to vector store
  version: number;
}

interface VectorRecord {
  id: string;
  documentId: string;
  embedding: number[];
  model: string;
  timestamp: Date;
}
```

### Write-Ahead Logging Strategy
- Log all write operations before execution
- Support rollback on failures
- Enable recovery after crashes
- Provide audit trail for debugging

### Migration Strategy
1. **Inventory**: Catalog all existing data and schemas
2. **Mapping**: Create transformation rules for each data type
3. **Validation**: Verify data integrity during migration
4. **Rollback**: Plan for migration failure recovery
5. **Testing**: Comprehensive testing of migration process

### Consistency Guarantees
- **Eventual Consistency**: Acceptable for search indexing
- **Write Consistency**: Ensure documents and vectors stay synchronized
- **Read Consistency**: Provide consistent views for recent writes
- **Recovery**: Automatic recovery from partial failures

## Dependencies
- Fix dual store consistency (prerequisite)
- Implement unified content model (prerequisite)

## Risks
- Data loss during migration
- Performance impact of write-ahead logging
- Complex rollback procedures
- Storage capacity planning
- Downtime during migration

## Tags
indexing,storage,migration,consistency

## Complexity Score
13 (MUST SPLIT - too large and complex)

## Status
incoming
