/**
 * Enhanced PM2 Ecosystem Configuration for Promethean Monorepo
 * Generated by Clojure DSL from EDN files
 * Generated at: Sun Oct 19 21:52:53 CDT 2025
 *
 * Features:
 * - Monitors file changes across all packages and services
 * - Automatically runs tests/builds on affected projects using Nx
 * - Comprehensive logging and error handling
 * - Performance optimization with debouncing and caching
 * - Support for all cacheable operations defined in nx.json
 */

import dotenv from 'dotenv';
import { fileURLToPath } from 'node:url';
import { dirname, join } from 'node:path';

// Load environment variables
try {
  dotenv.config();
} catch (error) {
  if (error?.code !== 'ERR_MODULE_NOT_FOUND') {
    throw error;
  }
}

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const PROJECT_ROOT = __dirname;

const generatedApps = {
  apps: [
    {
      killTimeout: 15000,
      minUptime: 10000,
      args: [
        '--watch-dirs',
        'packages/*/src',
        'services/*/src',
        'shared/*/src',
        '--operations',
        'build,test,test:unit,test:integration,test:e2e,lint,typecheck,coverage',
        '--debounce',
        2000,
        '--batch-delay',
        5000,
        '--max-concurrent',
        3,
        '--workspace-layout',
        '{"apps-dir":"services","libs-dir":"packages"}',
      ],
      pidFile: 'logs/nx-watcher.pid',
      watch: [
        'packages/*/src/**/*',
        'services/*/src/**/*',
        'shared/*/src/**/*',
        'tools/**/*',
        'scripts/**/*',
      ],
      cwd: '/home/err/devel/promethean',
      name: 'nx-watcher',
      script: 'scripts/nx-watcher.mjs',
      time: true,
      env: {
        NX_VERBOSE_LOGGING: 'false',
        NX_DAEMON: 'true',
        NX_PERF_LOGGING: 'false',
        PM2_PROCESS_NAME: 'nx-watcher',
        PROJECT_ROOT: '/home/err/devel/promethean',
      },
      autorestart: true,
      mergeLogs: true,
      interpreter: '/usr/bin/env',
      ignoreWatch: [
        'node_modules/**/*',
        'dist/**/*',
        'build/**/*',
        'coverage/**/*',
        'logs/**/*',
        '.git/**/*',
        '**/*.log',
        '**/*.tmp',
        '.nx/cache/**/*',
      ],
      maxRestarts: 10,
      outFile: 'logs/nx-watcher-out.log',
      maxMemoryRestart: '1G',
      logDateFormat: 'YYYY-MM-DD HH:mm:ss Z',
      instances: 1,
      errorFile: 'logs/nx-watcher-err.log',
      restartDelay: 5000,
      logFile: 'logs/nx-watcher-combined.log',
      description: 'Intelligent file watcher that triggers Nx operations on affected projects',
    },
    {
      killTimeout: 15000,
      exec_mode: 'fork',
      kill_timeout: 10000,
      merge_logs: true,
      minUptime: 10000,
      restart_delay: 10000,
      ignore_watch: ['node_modules', 'logs', 'tmp', '.git'],
      args: [],
      pidFile: 'logs/heartbeat.pid',
      watch: ['./packages/heartbeat'],
      cwd: './packages/heartbeat',
      name: 'heartbeat',
      script: 'index.js',
      time: true,
      env: {
        PM2_PROCESS_NAME: 'heartbeat',
        HEARTBEAT_PORT: '5005',
        PYTHONUNBUFFERED: '1',
        PYTHONPATH: './packages/pm2-helpers',
        CHECK_INTERVAL: '300000',
        HEARTBEAT_TIMEOUT: '600000',
        PROJECT_ROOT: '/home/err/devel/promethean',
      },
      autorestart: true,
      mergeLogs: true,
      maxRestarts: 10,
      outFile: 'logs/heartbeat-out.log',
      out_file: './logs/heartbeat-out.log',
      maxMemoryRestart: '1G',
      logDateFormat: 'YYYY-MM-DD HH:mm:ss Z',
      instances: 1,
      errorFile: 'logs/heartbeat-err.log',
      error_file: './logs/heartbeat-err.log',
      restartDelay: 5000,
      logFile: 'logs/heartbeat-combined.log',
    },
    {
      killTimeout: 15000,
      minUptime: 10000,
      args: ['packages/dualstore-http/dist/index-simple.js'],
      pidFile: 'logs/dualstore-http.pid',
      watch: false,
      cwd: '..',
      name: 'dualstore-http',
      script: 'node',
      time: true,
      env: {
        NODE_ENV: 'production',
        PORT: '3000',
        LOG_LEVEL: 'info',
        DUALSTORE_HTTP_HOST: 'localhost',
        DUALSTORE_HTTP_PORT: '3000',
        PM2_PROCESS_NAME: 'dualstore-http',
        PROJECT_ROOT: '/home/err/devel/promethean',
      },
      autorestart: true,
      mergeLogs: true,
      maxRestarts: 10,
      outFile: 'logs/dualstore-http-out.log',
      maxMemoryRestart: '1G',
      logDateFormat: 'YYYY-MM-DD HH:mm:ss Z',
      instances: 1,
      errorFile: 'logs/dualstore-http-err.log',
      restartDelay: 5000,
      logFile: 'logs/dualstore-http-combined.log',
      description: 'Dual-store HTTP API server for events and agent tasks',
    },
    {
      killTimeout: 15000,
      minUptime: 10000,
      args: ['-r', 'esbuild-register', 'packages/frontend-service/dist/index.js'],
      pidFile: 'logs/frontend-service.pid',
      watch: false,
      cwd: '..',
      name: 'frontend-service',
      script: 'node',
      time: true,
      env: {
        NODE_ENV: 'production',
        PORT: '3002',
        LOG_LEVEL: 'info',
        PM2_PROCESS_NAME: 'frontend-service',
        PROJECT_ROOT: '/home/err/devel/promethean',
      },
      autorestart: true,
      mergeLogs: true,
      maxRestarts: 10,
      outFile: 'logs/frontend-service-out.log',
      maxMemoryRestart: '1G',
      logDateFormat: 'YYYY-MM-DD HH:mm:ss Z',
      instances: 1,
      errorFile: 'logs/frontend-service-err.log',
      restartDelay: 5000,
      logFile: 'logs/frontend-service-combined.log',
      description: 'Frontend service with ClojureScript DSL and server capabilities',
    },
    {
      max_restarts: 10,
      killTimeout: 15000,
      kill_timeout: 5000,
      minUptime: 10000,
      restart_delay: 5000,
      args: [
        'autocommit',
        '--path',
        '.',
        '--debounce-ms',
        '10000',
        '--model',
        'error/qwen3:4b-instruct-100k',
      ],
      pidFile: 'logs/autocommit.pid',
      watch: false,
      cwd: '/home/err/devel/promethean',
      name: 'autocommit',
      script: 'pnpm',
      log_file: '/home/err/devel/promethean/logs/autocommit.log',
      time: true,
      env: {
        OPENAI_BASE_URL: 'http://localhost:11434',
        AUTOCOMMIT_MODEL: 'error/qwen3:4b-instruct-100k',
        NODE_ENV: 'production',
        PM2_PROCESS_NAME: 'autocommit',
        PROJECT_ROOT: '/home/err/devel/promethean',
        LOG_LEVEL: 'info',
      },
      autorestart: true,
      mergeLogs: true,
      interpreter: '/usr/bin/env',
      maxRestarts: 10,
      outFile: 'logs/autocommit-out.log',
      out_file: '/home/err/devel/promethean/logs/autocommit-out.log',
      min_uptime: 10000,
      maxMemoryRestart: '1G',
      logDateFormat: 'YYYY-MM-DD HH:mm:ss Z',
      instances: 1,
      errorFile: 'logs/autocommit-err.log',
      error_file: '/home/err/devel/promethean/logs/autocommit-error.log',
      restartDelay: 5000,
      logFile: 'logs/autocommit-combined.log',
    },
    {
      killTimeout: 15000,
      exec_mode: 'fork',
      kill_timeout: 10000,
      merge_logs: true,
      minUptime: 10000,
      restart_delay: 10000,
      ignore_watch: ['node_modules', 'logs', 'tmp', '.git'],
      args: [],
      pidFile: 'logs/broker.pid',
      watch: ['./packages/broker'],
      cwd: './packages/broker',
      name: 'broker',
      script: 'index.js',
      time: true,
      env: {
        PM2_PROCESS_NAME: 'broker',
        HEARTBEAT_PORT: '5005',
        CHECK_INTERVAL: '300000',
        HEARTBEAT_TIMEOUT: '600000',
        PROJECT_ROOT: '/home/err/devel/promethean',
      },
      autorestart: true,
      mergeLogs: true,
      maxRestarts: 10,
      outFile: 'logs/broker-out.log',
      out_file: './logs/broker-out.log',
      maxMemoryRestart: '1G',
      logDateFormat: 'YYYY-MM-DD HH:mm:ss Z',
      instances: 1,
      errorFile: 'logs/broker-err.log',
      error_file: './logs/broker-err.log',
      restartDelay: 5000,
      logFile: 'logs/broker-combined.log',
    },
    {
      killTimeout: 15000,
      exec_mode: 'fork',
      kill_timeout: 10000,
      merge_logs: true,
      minUptime: 10000,
      restart_delay: 10000,
      ignore_watch: ['node_modules', 'logs', 'tmp', '.git'],
      args: [],
      pidFile: 'logs/health.pid',
      watch: ['./packages/health'],
      cwd: './packages/health',
      name: 'health',
      script: 'index.js',
      time: true,
      env: {
        PM2_PROCESS_NAME: 'health',
        HEARTBEAT_PORT: '5005',
        PYTHONUNBUFFERED: '1',
        PYTHONPATH: './packages/pm2-helpers',
        CHECK_INTERVAL: '300000',
        HEARTBEAT_TIMEOUT: '600000',
        PROJECT_ROOT: '/home/err/devel/promethean',
      },
      autorestart: true,
      mergeLogs: true,
      maxRestarts: 10,
      outFile: 'logs/health-out.log',
      out_file: './logs/health-out.log',
      maxMemoryRestart: '1G',
      logDateFormat: 'YYYY-MM-DD HH:mm:ss Z',
      instances: 1,
      errorFile: 'logs/health-err.log',
      error_file: './logs/health-err.log',
      restartDelay: 5000,
      logFile: 'logs/health-combined.log',
    },
    {
      killTimeout: 15000,
      minUptime: 10000,
      args: ['-r', 'esbuild-register', 'packages/openai-server/dist/index.js'],
      pidFile: 'logs/openai-server.pid',
      watch: false,
      cwd: '..',
      name: 'openai-server',
      script: 'node',
      time: true,
      env: {
        NODE_ENV: 'production',
        PORT: '3001',
        LOG_LEVEL: 'info',
        PM2_PROCESS_NAME: 'openai-server',
        PROJECT_ROOT: '/home/err/devel/promethean',
      },
      autorestart: true,
      mergeLogs: true,
      maxRestarts: 10,
      outFile: 'logs/openai-server-out.log',
      maxMemoryRestart: '1G',
      logDateFormat: 'YYYY-MM-DD HH:mm:ss Z',
      instances: 1,
      errorFile: 'logs/openai-server-err.log',
      restartDelay: 5000,
      logFile: 'logs/openai-server-combined.log',
      description: 'OpenAI-compatible API server with Ollama integration and task queuing',
    },
    {
      killTimeout: 15000,
      kill_timeout: 10000,
      merge_logs: true,
      minUptime: 10000,
      restart_delay: 10000,
      args: ['--filter', '@promethean/mcp', 'dev'],
      pidFile: 'logs/promethean-mcp-dev.pid',
      cwd: '.',
      name: 'promethean-mcp-dev',
      script: 'pnpm',
      time: true,
      env: {
        PM2_PROCESS_NAME: 'promethean-mcp-dev',
        MCP_USRE_ROLE: 'developer',
        PROJECT_ROOT: '/home/err/devel/promethean',
      },
      autorestart: true,
      mergeLogs: true,
      interpreter: '/usr/bin/env',
      maxRestarts: 10,
      outFile: 'logs/promethean-mcp-dev-out.log',
      out_file: './logs/promethean-mcp-dev-out.log',
      maxMemoryRestart: '1G',
      logDateFormat: 'YYYY-MM-DD HH:mm:ss Z',
      instances: 1,
      errorFile: 'logs/promethean-mcp-dev-err.log',
      error_file: './logs/promthean-mcp-dev-err.log',
      restartDelay: 5000,
      logFile: 'logs/promethean-mcp-dev-combined.log',
    },
    {
      killTimeout: 15000,
      kill_timeout: 10000,
      merge_logs: true,
      minUptime: 10000,
      restart_delay: 10000,
      args: ['opencode-client', 'indexer', 'start', '--', 'intrevl', 2000, '--verbose'],
      pidFile: 'logs/opencode-indexer.pid',
      cwd: '.',
      name: 'opencode-indexer',
      script: 'pnpm',
      time: true,
      env: {
        PM2_PROCESS_NAME: 'opencode-indexer',
        PROJECT_ROOT: '/home/err/devel/promethean',
      },
      autorestart: true,
      mergeLogs: true,
      interpreter: '/usr/bin/env',
      maxRestarts: 10,
      outFile: 'logs/opencode-indexer-out.log',
      out_file: './logs/opencode-indexer-out.log',
      maxMemoryRestart: '1G',
      logDateFormat: 'YYYY-MM-DD HH:mm:ss Z',
      instances: 1,
      errorFile: 'logs/opencode-indexer-err.log',
      error_file: './logs/opencode-indexer-err.log',
      restartDelay: 5000,
      logFile: 'logs/opencode-indexer-combined.log',
    },
    {
      killTimeout: 15000,
      kill_timeout: 10000,
      merge_logs: true,
      minUptime: 10000,
      restart_delay: 10000,
      ignore_watch: ['node_modules', 'logs', 'tmp', '.git', 'target', '.cpcache'],
      args: ['repl', ':headless', ':port', '7888'],
      pidFile: 'logs/lein-repl.pid',
      name: 'lein-repl',
      script: 'lein',
      time: true,
      env: {
        LEIN_REPL_PORT: '7888',
        JAVA_OPTS: '-Xmx2g -XX:+UseG1GC',
        PM2_PROCESS_NAME: 'lein-repl',
        PROJECT_ROOT: '/home/err/devel/promethean',
      },
      autorestart: true,
      mergeLogs: true,
      interpreter: '/usr/bin/env',
      maxRestarts: 10,
      outFile: 'logs/lein-repl-out.log',
      out_file: './logs/lein-repl-out.log',
      maxMemoryRestart: '1G',
      logDateFormat: 'YYYY-MM-DD HH:mm:ss Z',
      instances: 1,
      errorFile: 'logs/lein-repl-err.log',
      error_file: './logs/lein-repl-err.log',
      restartDelay: 5000,
      logFile: 'logs/lein-repl-combined.log',
    },
    {
      killTimeout: 15000,
      kill_timeout: 10000,
      merge_logs: true,
      minUptime: 10000,
      restart_delay: 10000,
      args: ['--filter', '@promethean/opencode-unified', 'dev'],
      pidFile: 'logs/opencode-unified-shadow-cljs.pid',
      cwd: '.',
      name: 'opencode-unified-shadow-cljs',
      script: 'pnpm',
      time: true,
      env: {
        PM2_PROCESS_NAME: 'opencode-unified-shadow-cljs',
        PROJECT_ROOT: '/home/err/devel/promethean',
      },
      autorestart: true,
      mergeLogs: true,
      interpreter: '/usr/bin/env',
      maxRestarts: 10,
      outFile: 'logs/opencode-unified-shadow-cljs-out.log',
      out_file: './logs/promethean-opencode-unified.log',
      maxMemoryRestart: '1G',
      logDateFormat: 'YYYY-MM-DD HH:mm:ss Z',
      instances: 1,
      errorFile: 'logs/opencode-unified-shadow-cljs-err.log',
      error_file: './logs/promthean-opencode-unified.log',
      restartDelay: 5000,
      logFile: 'logs/opencode-unified-shadow-cljs-combined.log',
    },
    {
      killTimeout: 15000,
      kill_timeout: 10000,
      merge_logs: true,
      minUptime: 10000,
      restart_delay: 10000,
      ignore_watch: ['node_modules', 'logs', 'tmp', '.git'],
      args: ['serve', '--port', 4096],
      pidFile: 'logs/opencode.pid',
      watch: ['packages/opencode-client/dist/**/*'],
      cwd: '.',
      name: 'opencode',
      script: 'opencode',
      time: true,
      env: {
        PM2_PROCESS_NAME: 'opencode',
        PROJECT_ROOT: '/home/err/devel/promethean',
      },
      autorestart: true,
      mergeLogs: true,
      interpreter: '/usr/bin/env',
      maxRestarts: 10,
      outFile: 'logs/opencode-out.log',
      out_file: './logs/opencode-out.log',
      maxMemoryRestart: '1G',
      logDateFormat: 'YYYY-MM-DD HH:mm:ss Z',
      instances: 1,
      errorFile: 'logs/opencode-err.log',
      error_file: './logs/opencode-err.log',
      restartDelay: 5000,
      logFile: 'logs/opencode-combined.log',
    },
    {
      killTimeout: 15000,
      kill_timeout: 10000,
      merge_logs: true,
      minUptime: 10000,
      restart_delay: 10000,
      args: ['@playwright/mcp@latest', '--port', '8931'],
      pidFile: 'logs/playwright-mcp.pid',
      cwd: '.',
      name: 'playwright-mcp',
      script: 'npx',
      time: true,
      env: {
        PM2_PROCESS_NAME: 'playwright-mcp',
        PROJECT_ROOT: '/home/err/devel/promethean',
      },
      autorestart: true,
      mergeLogs: true,
      interpreter: '/usr/bin/env',
      maxRestarts: 10,
      outFile: 'logs/playwright-mcp-out.log',
      out_file: './logs/playwright-mcp-out.log',
      maxMemoryRestart: '1G',
      logDateFormat: 'YYYY-MM-DD HH:mm:ss Z',
      instances: 1,
      errorFile: 'logs/playwright-mcp-err.log',
      error_file: './logs/playwright-mcp-err.log',
      restartDelay: 5000,
      logFile: 'logs/playwright-mcp-combined.log',
    },
  ],
};

// Export complete ecosystem configuration
export const apps = generatedApps;

// PM2 deployment configuration
export const deploy = {
  production: {
    user: 'deploy',
    host: ['promethean.example.com'],
    ref: 'origin/main',
    repo: 'git@github.com:promethean/promethean.git',
    path: '/var/www/promethean',
    'post-deploy':
      'pnpm install && pnpm build:all && pm2 reload ecosystem.config.enhanced.mjs --env production',
  },
};

console.log(`üöÄ Enhanced PM2 ecosystem configuration loaded`);
console.log(`üìä Total processes configured: 14`);
console.log(`üìÅ Logs directory: ${join(PROJECT_ROOT, 'logs')}`);

export default {
  apps,
  deploy,
};
