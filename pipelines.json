{
  "pipelines": [
    {
      "name": "symdocs",
      "steps": [
        {
          "id": "symdocs-scan",
          "cwd": ".",
          "shell": "pnpm --filter @promethean/symdocs symdocs:01-scan --root packages --tsconfig ./config/tsconfig.base.json",
          "inputs": ["packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"],
          "outputs": [".cache/symdocs/symbols.json"]
        },
        {
          "id": "symdocs-docs",
          "deps": ["symdocs-scan"],
          "shell": "pnpm --filter @promethean/symdocs symdocs:02-docs --model qwen3:4b",
          "inputs": [".cache/symdocs/symbols.json"],
          "outputs": [".cache/symdocs/docs.json"]
        },
        {
          "id": "symdocs-write",
          "deps": ["symdocs-docs"],
          "shell": "pnpm --filter @promethean/symdocs symdocs:03-write --out docs/packages --granularity module",
          "inputs": [".cache/symdocs/docs.json"],
          "outputs": ["docs/packages/**/**/*.md"]
        },
        {
          "id": "symdocs-graph",
          "deps": ["symdocs-scan"],
          "shell": "pnpm --filter @promethean/symdocs symdocs:04-graph",
          "inputs": [
            "packages/**/package.json",
            "packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"
          ],
          "outputs": ["docs/packages/README.md", "docs/packages/**/README.md"]
        }
      ]
    },
    {
      "name": "simtasks",
      "steps": [
        {
          "id": "simtasks-scan",
          "shell": "pnpm --filter @promethean/simtasks sim:01-scan --root packages --tsconfig ./tsconfig.json",
          "inputs": ["packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"],
          "outputs": [".cache/simtasks/functions.json"]
        },
        {
          "id": "simtasks-embed",
          "deps": ["simtasks-scan"],
          "shell": "pnpm --filter @promethean/simtasks sim:02-embed --embed-model nomic-embed-text:latest",
          "inputs": [".cache/simtasks/functions.json"],
          "outputs": [".cache/simtasks/embeddings.json"]
        },
        {
          "id": "simtasks-cluster",
          "deps": ["simtasks-embed"],
          "shell": "pnpm --filter @promethean/simtasks sim:03-cluster --sim-threshold 0.86 --k 12 --min-size 2",
          "inputs": [".cache/simtasks/embeddings.json"],
          "outputs": [".cache/simtasks/clusters.json"]
        },
        {
          "id": "simtasks-plan",
          "deps": ["simtasks-cluster"],
          "shell": "pnpm --filter @promethean/simtasks sim:04-plan --model qwen3:4b --base-dir packages",
          "inputs": [".cache/simtasks/clusters.json"],
          "outputs": [".cache/simtasks/plans.json"]
        },
        {
          "id": "simtasks-write",
          "deps": ["simtasks-plan"],
          "shell": "pnpm --filter @promethean/simtasks sim:05-write --out docs/agile/tasks",
          "inputs": [".cache/simtasks/plans.json"],
          "outputs": ["docs/agile/tasks/*.md"]
        }
      ]
    },
    {
      "name": "codemods",
      "steps": [
        {
          "id": "mods-simtasks",
          "shell": "bash -lc 'if [ ! -f .cache/simtasks/functions.json ] || [ ! -f .cache/simtasks/clusters.json ] || [ ! -f .cache/simtasks/plans.json ]; then pnpm --filter @promethean/piper piper run simtasks --config pipelines.json; fi'",
          "inputs": [],
          "outputs": [
            ".cache/simtasks/functions.json",
            ".cache/simtasks/clusters.json",
            ".cache/simtasks/plans.json"
          ]
        },
        {
          "id": "mods-spec",
          "deps": ["mods-simtasks"],
          "shell": "pnpm --filter @promethean/codemods mods:01-spec --tsconfig ./tsconfig.json",
          "inputs": [
            ".cache/simtasks/functions.json",
            ".cache/simtasks/clusters.json",
            ".cache/simtasks/plans.json"
          ],
          "outputs": [".cache/codemods/specs.json"]
        },
        {
          "id": "mods-generate",
          "deps": ["mods-spec"],
          "shell": "pnpm --filter @promethean/codemods mods:02-generate",
          "inputs": [".cache/codemods/specs.json"],
          "outputs": ["codemods/**/transform.ts"]
        },
        {
          "id": "mods-dry-run",
          "deps": ["mods-generate"],
          "shell": "pnpm --filter @promethean/codemods mods:03-dry-run --root packages --report docs/agile/tasks/codemods --specs .cache/codemods/specs.json --delete-duplicates true",
          "inputs": [
            "codemods/**/transform.ts",
            "packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"
          ],
          "outputs": ["docs/agile/tasks/codemods/*.md"]
        },
        {
          "id": "mods-apply",
          "deps": ["mods-dry-run"],
          "shell": "pnpm --filter @promethean/codemods mods:03-apply --root packages --report docs/agile/tasks/codemods --specs .cache/codemods/specs.json --delete-duplicates true",
          "inputs": ["codemods/**/transform.ts"],
          "outputs": [".cache/codemods/run-apply.json"]
        },
        {
          "id": "mods-verify",
          "deps": ["mods-apply"],
          "shell": "pnpm --filter @promethean/codemods mods:04-verify:after --stage after --test \"pnpm -w -r test\"",
          "inputs": [".cache/codemods/run-apply.json"],
          "outputs": [
            "docs/agile/tasks/codemods/verify-after.md",
            "docs/agile/tasks/codemods/VERIFY.md"
          ]
        }
      ]
    },
    {
      "name": "semver-guard",
      "steps": [
        {
          "id": "sv-snapshot",
          "shell": "pnpm --filter @promethean/semverguard sv:01-snapshot --root packages --tsconfig ./tsconfig.json --out .cache/semverguard/snapshot.json",
          "inputs": [
            "packages/**/package.json",
            "packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"
          ],
          "outputs": [".cache/semverguard/snapshot.json"]
        },
        {
          "id": "sv-diff",
          "deps": ["sv-snapshot"],
          "shell": "pnpm --filter @promethean/semverguard sv:02-diff --current .cache/semverguard/snapshot.json --baseline git:origin/main:.cache/semverguard/snapshot.json --out .cache/semverguard/diff.json",
          "inputs": [".cache/semverguard/snapshot.json"],
          "outputs": [".cache/semverguard/diff.json"]
        },
        {
          "id": "sv-plan",
          "deps": ["sv-diff"],
          "shell": "pnpm --filter @promethean/semverguard sv:03-plan --diff .cache/semverguard/diff.json --out .cache/semverguard/plans.json --model qwen3:4b",
          "inputs": [".cache/semverguard/diff.json"],
          "outputs": [".cache/semverguard/plans.json"]
        },
        {
          "id": "sv-write",
          "deps": ["sv-plan"],
          "shell": "pnpm --filter @promethean/semverguard sv:04-write --plans .cache/semverguard/plans.json --out docs/agile/tasks/semver",
          "inputs": [".cache/semverguard/plans.json"],
          "outputs": ["docs/agile/tasks/semver/*.md"]
        },
        {
          "id": "sv-pr",
          "deps": ["sv-write"],
          "shell": "pnpm --filter @promethean/semverguard sv:05-pr --plans .cache/semverguard/plans.json --root packages --mode prepare --update-dependents true --dep-range preserve",
          "inputs": [
            ".cache/semverguard/plans.json",
            "packages/**/package.json"
          ],
          "outputs": [".cache/semverguard/pr/summary.json"]
        }
      ]
    },
    {
      "name": "board-review",
      "steps": [
        {
          "id": "br-fm",
          "shell": "pnpm --filter @promethean/boardrev br:01-fm",
          "inputs": ["docs/agile/tasks/**/*.md"],
          "outputs": ["docs/agile/tasks/**/*.md"]
        },
        {
          "id": "br-prompts",
          "deps": ["br-fm"],
          "shell": "pnpm --filter @promethean/boardrev br:02-prompts --process docs/agile/Process.md --out .cache/boardrev/prompts.json",
          "inputs": ["docs/agile/Process.md"],
          "outputs": [".cache/boardrev/prompts.json"]
        },
        {
          "id": "br-index",
          "deps": ["br-fm"],
          "shell": "pnpm --filter @promethean/boardrev br:03-index --globs \"{README.md,docs/**/*.md,packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}}\"",
          "inputs": [
            "README.md",
            "docs/**/*.md",
            "packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"
          ],
          "outputs": [
            ".cache/boardrev/repo-index.json",
            ".cache/boardrev/repo-embeddings.json"
          ]
        },
        {
          "id": "br-match",
          "deps": ["br-prompts", "br-index"],
          "shell": "pnpm --filter @promethean/boardrev br:04-match --tasks docs/agile/tasks --k 8",
          "inputs": [
            "docs/agile/tasks/**/*.md",
            ".cache/boardrev/repo-index.json",
            ".cache/boardrev/repo-embeddings.json"
          ],
          "outputs": [".cache/boardrev/context.json"]
        },
        {
          "id": "br-eval",
          "deps": ["br-match"],
          "shell": "pnpm --filter @promethean/boardrev br:05-eval --model qwen3:4b",
          "env": {
            "OLLAMA_URL": "${OLLAMA_URL}"
          },
          "inputs": [
            ".cache/boardrev/prompts.json",
            ".cache/boardrev/context.json"
          ],
          "outputs": [".cache/boardrev/evals.json"]
        },
        {
          "id": "br-report",
          "deps": ["br-eval"],
          "shell": "pnpm --filter @promethean/boardrev br:06-report --outDir docs/agile/reports",
          "inputs": [".cache/boardrev/evals.json"],
          "outputs": ["docs/agile/reports/*.md"]
        }
      ]
    },
    {
      "name": "sonar",
      "steps": [
        {
          "id": "sonar-scan",
          "cwd": ".",
          "shell": "sonar-scanner",
          "env": {
            "SONAR_HOST_URL": "${SONAR_HOST_URL}",
            "SONAR_TOKEN": "${SONAR_TOKEN}",
            "SONAR_PROJECT_KEY": "${SONAR_PROJECT_KEY}"
          },
          "inputs": [
            "packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}",
            "sonar-project.properties"
          ],
          "outputs": [".cache/sonar/scan.touch"]
        },
        {
          "id": "sonar-fetch",
          "deps": ["sonar-scan"],
          "env": {
            "SONAR_HOST_URL": "${SONAR_HOST_URL}",
            "SONAR_TOKEN": "${SONAR_TOKEN}",
            "SONAR_PROJECT_KEY": "${SONAR_PROJECT_KEY}"
          },
          "shell": "pnpm --filter @promethean/sonarflow sonar:fetch --project ${SONAR_PROJECT_KEY} --out .cache/sonar/issues.json",
          "inputs": [],
          "outputs": [".cache/sonar/issues.json"]
        },
        {
          "id": "sonar-plan",
          "deps": ["sonar-fetch"],
          "env": {
            "OLLAMA_URL": "${OLLAMA_URL}"
          },
          "shell": "pnpm --filter @promethean/sonarflow sonar:plan --in .cache/sonar/issues.json --out .cache/sonar/plans.json --group-by rule+prefix --prefix-depth 2 --min-group 2 --model qwen3:4b",
          "inputs": [".cache/sonar/issues.json"],
          "outputs": [".cache/sonar/plans.json"]
        },
        {
          "id": "sonar-write",
          "deps": ["sonar-plan"],
          "shell": "pnpm --filter @promethean/sonarflow sonar:write --in .cache/sonar/plans.json --out docs/agile/tasks/sonar",
          "inputs": [".cache/sonar/plans.json"],
          "outputs": ["docs/agile/tasks/sonar/*.md"]
        }
      ]
    },
    {
      "name": "readmes",
      "steps": [
        {
          "id": "rm-scan",
          "shell": "pnpm --filter @promethean/readmeflow rm:01-scan --root packages",
          "inputs": ["packages/**/package.json", "packages/**/tsconfig.json"]
        },
        {
          "id": "rm-outline",
          "deps": ["rm-scan"],
          "shell": "pnpm --filter @promethean/readmeflow rm:02-outline --model qwen3:4b",
          "env": {
            "OLLAMA_URL": "${OLLAMA_URL}"
          }
        },
        {
          "id": "rm-write",
          "deps": ["rm-outline"],
          "shell": "pnpm --filter @promethean/readmeflow rm:03-write --mermaid true",
          "outputs": ["packages/**/README.md"]
        },
        {
          "id": "rm-verify",
          "deps": ["rm-write"],
          "shell": "pnpm --filter @promethean/readmeflow rm:04-verify --root packages --out docs/agile/reports/readmes",
          "inputs": ["packages/**/README.md"],
          "outputs": ["docs/agile/reports/readmes/*.md"]
        }
      ]
    },
    {
      "name": "buildfix",
      "steps": [
        {
          "id": "bf-errors",
          "shell": "pnpm --filter @promethean/buildfix bf:01-errors --tsconfig tsconfig.json --out .cache/buildfix/errors.json",
          "inputs": [
            "tsconfig.json",
            "packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"
          ],
          "outputs": [".cache/buildfix/errors.json"]
        },
        {
          "id": "bf-iterate",
          "deps": ["bf-errors"],
          "shell": "pnpm --filter @promethean/buildfix bf:02-iterate --errors .cache/buildfix/errors.json --out .cache/buildfix --model qwen3:4b --max-cycles 5 --git per-error --commit-on always --branch-prefix buildfix --remote origin --push false --use-gh false --rollback-on-regress true\n",
          "env": {
            "OLLAMA_URL": "${OLLAMA_URL}"
          },
          "inputs": [
            ".cache/buildfix/errors.json",
            "tsconfig.json",
            "packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"
          ],
          "outputs": [
            ".cache/buildfix/summary.json",
            ".cache/buildfix/history/**",
            ".cache/buildfix/snippets/**"
          ]
        },
        {
          "id": "bf-report",
          "deps": ["bf-iterate"],
          "shell": "pnpm --filter @promethean/buildfix bf:03-report --summary .cache/buildfix/summary.json --history-root .cache/buildfix/history --out docs/agile/reports/buildfix",
          "inputs": [".cache/buildfix/summary.json"],
          "outputs": ["docs/agile/reports/buildfix/*.md"]
        }
      ]
    },
    {
      "name": "test-gap",
      "steps": [
        {
          "id": "tg-exports",
          "shell": "pnpm --filter @promethean/testgap tg:01-scan-exports --root packages --out .cache/testgap/exports.json",
          "inputs": [
            "packages/**/package.json",
            "packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"
          ],
          "outputs": [".cache/testgap/exports.json"]
        },
        {
          "id": "tg-coverage",
          "shell": "pnpm --filter @promethean/testgap tg:02-read-coverage --lcov-globs \"{coverage/lcov.info,packages/**/coverage/lcov.info}\" --out .cache/testgap/coverage.json",
          "inputs": ["coverage/lcov.info", "packages/**/coverage/lcov.info"],
          "outputs": [".cache/testgap/coverage.json"]
        },
        {
          "id": "tg-map",
          "deps": ["tg-exports", "tg-coverage"],
          "shell": "pnpm --filter @promethean/testgap tg:03-map-gaps --exports .cache/testgap/exports.json --coverage .cache/testgap/coverage.json --min-lines 3 --out .cache/testgap/gaps.json",
          "inputs": [
            ".cache/testgap/exports.json",
            ".cache/testgap/coverage.json"
          ],
          "outputs": [".cache/testgap/gaps.json"]
        },
        {
          "id": "tg-gate",
          "deps": ["tg-map"],
          "shell": "pnpm --filter @promethean/testgap tg:08-gate --gaps .cache/testgap/gaps.json --out .cache/testgap/gate.json --threshold 0.70 --metric symbols",
          "inputs": [".cache/testgap/gaps.json"],
          "outputs": [".cache/testgap/gate.json"]
        },
        {
          "id": "tg-cookbook",
          "deps": ["tg-map"],
          "shell": "pnpm --filter @promethean/testgap tg:04-cookbook-cross --recipes docs/cookbook/**/*.md --out .cache/testgap/cookbook.json",
          "inputs": ["docs/cookbook/**/*.md"],
          "outputs": [".cache/testgap/cookbook.json"]
        },
        {
          "id": "tg-plan",
          "deps": ["tg-cookbook"],
          "shell": "pnpm --filter @promethean/testgap tg:05-plan --gaps .cache/testgap/gaps.json --cookbook .cache/testgap/cookbook.json --out .cache/testgap/plans.json --model qwen3:4b --threshold 0.5 --max-per-pkg 15",
          "env": {
            "OLLAMA_URL": "${OLLAMA_URL}"
          },
          "inputs": [
            ".cache/testgap/gaps.json",
            ".cache/testgap/cookbook.json"
          ],
          "outputs": [".cache/testgap/plans.json"]
        },
        {
          "id": "tg-write",
          "deps": ["tg-plan"],
          "shell": "pnpm --filter @promethean/testgap tg:06-write --plans .cache/testgap/plans.json --out docs/agile/tasks/test-gaps",
          "inputs": [".cache/testgap/plans.json"],
          "outputs": ["docs/agile/tasks/test-gaps/*.md"]
        },
        {
          "id": "tg-report",
          "deps": ["tg-map"],
          "shell": "pnpm --filter @promethean/testgap tg:07-report --gaps .cache/testgap/gaps.json --out docs/agile/reports/test-gaps",
          "inputs": [".cache/testgap/gaps.json"],
          "outputs": ["docs/agile/reports/test-gaps/*.md"]
        }
      ]
    },
    {
      "name": "docops",
      "steps": [
        {
          "id": "doc-fm",
          "js": {
            "module": "scripts/piper-docops.mjs",
            "export": "frontmatter",
            "args": { "dir": "docs/unique", "genModel": "qwen3:4b" }
          },
          "env": { "OLLAMA_URL": "${OLLAMA_URL}" },
          "inputs": ["docs/unique/**/*.md"],
          "outputs": []
        },
        {
          "id": "doc-index",
          "deps": ["doc-fm"],
          "js": {
            "module": "scripts/piper-docops.mjs",
            "export": "embed",
            "args": {
              "dir": "docs/unique",
              "embedModel": "nomic-embed-text:latest",
              "collection": "docs"
            }
          },
          "env": { "OLLAMA_URL": "${OLLAMA_URL}" },
          "inputs": ["docs/unique/**/*.md"],
          "outputs": []
        },
        {
          "id": "doc-similarity",
          "deps": ["doc-index"],
          "js": {
            "module": "scripts/piper-docops.mjs",
            "export": "query",
            "args": {
              "embedModel": "nomic-embed-text:latest",
              "collection": "docs",
              "k": 16
            }
          },
          "env": { "OLLAMA_URL": "${OLLAMA_URL}" },
          "inputs": [],
          "outputs": []
        },
        {
          "id": "doc-related",
          "deps": ["doc-similarity"],
          "js": {
            "module": "scripts/piper-docops.mjs",
            "export": "relations",
            "args": {
              "dir": "docs/unique",
              "docThreshold": 0.78,
              "refThreshold": 0.6
            }
          },
          "inputs": ["docs/unique/**/*.md"],
          "outputs": []
        },

        {
          "id": "doc-footer",
          "deps": ["doc-related"],
          "js": {
            "module": "scripts/piper-docops.mjs",
            "export": "footers",
            "args": {
              "dir": "docs/unique",
              "anchorStyle": "block",
              "includeRelated": true,
              "includeSources": true
            }
          },
          "inputs": ["docs/unique/**/*.md"],
          "outputs": []
        },
        {
          "id": "doc-rename",
          "deps": ["doc-related"],
          "js": {
            "module": "scripts/piper-docops.mjs",
            "export": "rename",
            "args": { "dir": "docs/unique" }
          },
          "inputs": ["docs/unique/**/*.md"],
          "outputs": []
        }
      ]
    }
  ]
}
