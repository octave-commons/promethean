# .github/workflows/on-pr-to-dev.yml
name: build
on: { pull_request: { branches: ['dev/**', 'main'] } }
permissions:
  contents: read
jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [20]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Trust workspace ownership for Git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}-
            ${{ runner.os }}-pnpm-store-

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: pnpm }

      - name: Cache Clojure dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.clojure
            ~/.cpcache
          key: cljdeps-${{ runner.os }}-${{ hashFiles('**/deps.edn', '**/bb.edn') }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            cljdeps-${{ runner.os }}-${{ hashFiles('**/deps.edn', '**/bb.edn') }}-
            cljdeps-${{ runner.os }}-

      - name: Install Clojure toolchain (Unix)
        if: runner.os != 'Windows'
        run: bash run/install-clojure.sh

      - name: Install Clojure toolchain (Windows)
        if: runner.os == 'Windows'
        run: |
          powershell -Command "& {iwr -useb https://raw.githubusercontent.com/clojure/brew-install/latest/posix-install.sh | bash}"
          echo "C:\Program Files\clojure\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install Clojure toolchain
        run: bash run/install-clojure.sh
      - name: Install deps
        run: pnpm install --frozen-lockfile
        env:
          # Ensure consistent behavior across platforms
          npm_config_target_platform: ${{ runner.os }}
      - uses: nrwl/nx-set-shas@v4
      - name: Configure Nx base/head for PR
        if: github.event_name == 'pull_request'
        run: |
          echo "NX_BASE=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_ENV"
          echo "NX_HEAD=${{ github.sha }}" >> "$GITHUB_ENV"
      - name: Fetch base commit for Nx diff
        if: env.NX_BASE != ''
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          if ! git cat-file -e "${NX_BASE}^{commit}" 2>/dev/null; then
            git fetch --no-tags origin "${{ github.event.pull_request.base.ref }}"
            git fetch --no-tags origin "${NX_BASE}" || true
          fi
      - name: Run type checking
        shell: bash
        run: |
          if [ -n "${NX_BASE:-}" ] && [ -n "${NX_HEAD:-}" ]; then
            pnpm exec nx affected -t typecheck --parallel --base="$NX_BASE" --head="$NX_HEAD"
          else
            pnpm -r exec tsc --noEmit --strict
          fi
      - name: Run linting
        shell: bash
        run: |
          if [ -n "${NX_BASE:-}" ] && [ -n "${NX_HEAD:-}" ]; then
            pnpm exec nx affected -t lint --parallel --base="$NX_BASE" --head="$NX_HEAD"
          else
            pnpm -r lint
          fi
      - name: Run affected builds
        shell: bash
        run: |
          if [ -n "${NX_BASE:-}" ] && [ -n "${NX_HEAD:-}" ]; then
            pnpm exec nx affected -t build --parallel --base="$NX_BASE" --head="$NX_HEAD"
          else
            pnpm exec nx affected -t build --parallel
          fi
