name: Optimized CI Pipeline

on:
  pull_request:
    branches: ['dev/**', 'main']
  push:
    branches: ['main', 'dev/**']
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  NODE_VERSION: '20'

jobs:
  # Shared setup job that prepares dependencies for other jobs
  setup:
    name: Setup Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Trust workspace ownership for Git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.STORE_PATH }}
            node_modules/.cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/pnpm-lock.yaml', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-${{ hashFiles('**/pnpm-lock.yaml') }}-
            ${{ runner.os }}-deps-

      - name: Cache Clojure dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.clojure
            ~/.cpcache
          key: cljdeps-${{ runner.os }}-${{ hashFiles('**/deps.edn', '**/bb.edn') }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            cljdeps-${{ runner.os }}-${{ hashFiles('**/deps.edn', '**/bb.edn') }}-
            cljdeps-${{ runner.os }}-

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with: { node-version: ${{ env.NODE_VERSION }}, cache: pnpm }

      - name: Install Clojure toolchain
        run: bash run/install-clojure.sh

      - name: Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: pnpm install --frozen-lockfile

      - name: Upload dependency artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dependencies
          path: |
            node_modules
            ~/.pnpm-store
          retention-days: 1

  # Parallel type checking job
  typecheck:
    name: Type Checking
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: setup
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Trust workspace ownership for Git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with: { node-version: ${{ env.NODE_VERSION }}, cache: pnpm }

      - name: Download dependencies
        uses: actions/download-artifact@v4
        with:
          name: dependencies

      - uses: nrwl/nx-set-shas@v4

      - name: Configure Nx base/head for PR
        if: github.event_name == 'pull_request'
        run: |
          echo "NX_BASE=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_ENV"
          echo "NX_HEAD=${{ github.sha }}" >> "$GITHUB_ENV"

      - name: Fetch base commit for Nx diff
        if: env.NX_BASE != ''
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          if ! git cat-file -e "${NX_BASE}^{commit}" 2>/dev/null; then
            git fetch --no-tags origin "${{ github.event.pull_request.base.ref }}"
            git fetch --no-tags origin "${NX_BASE}" || true
          fi

      - name: Run type checking
        run: |
          if [ -n "${NX_BASE:-}" ] && [ -n "${NX_HEAD:-}" ]; then
            pnpm exec nx affected -t typecheck --parallel --base="$NX_BASE" --head="$NX_HEAD"
          else
            pnpm -r exec tsc --noEmit --strict
          fi

  # Parallel linting job
  lint:
    name: Linting
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: setup
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Trust workspace ownership for Git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with: { node-version: ${{ env.NODE_VERSION }}, cache: pnpm }

      - name: Download dependencies
        uses: actions/download-artifact@v4
        with:
          name: dependencies

      - uses: nrwl/nx-set-shas@v4

      - name: Configure Nx base/head for PR
        if: github.event_name == 'pull_request'
        run: |
          echo "NX_BASE=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_ENV"
          echo "NX_HEAD=${{ github.sha }}" >> "$GITHUB_ENV"

      - name: Fetch base commit for Nx diff
        if: env.NX_BASE != ''
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          if ! git cat-file -e "${NX_BASE}^{commit}" 2>/dev/null; then
            git fetch --no-tags origin "${{ github.event.pull_request.base.ref }}"
            git fetch --no-tags origin "${NX_BASE}" || true
          fi

      - name: Run linting (relaxed)
        run: >-
          pnpm exec nx affected -t lint --parallel --base="$NX_BASE" --head="$NX_HEAD" -- 
          --max-warnings=100000 
          --rule "@typescript-eslint/no-explicit-any:warn" 
          --rule "@typescript-eslint/no-unsafe-assignment:warn" 
          --rule "@typescript-eslint/no-unsafe-call:warn" 
          --rule "@typescript-eslint/no-unsafe-member-access:warn" 
          --rule "@typescript-eslint/no-unsafe-argument:warn" 
          --rule "@typescript-eslint/explicit-module-boundary-types:warn" 
          --rule "functional/no-let:warn" 
          --rule "sonarjs/cognitive-complexity:warn" 
          --rule "complexity:warn" 
          --rule "max-lines:warn" 
          --rule "max-lines-per-function:warn" 
          --rule "max-params:warn"

  # Parallel build job
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: setup
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Trust workspace ownership for Git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with: { node-version: ${{ env.NODE_VERSION }}, cache: pnpm }

      - name: Download dependencies
        uses: actions/download-artifact@v4
        with:
          name: dependencies

      - uses: nrwl/nx-set-shas@v4

      - name: Configure Nx base/head for PR
        if: github.event_name == 'pull_request'
        run: |
          echo "NX_BASE=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_ENV"
          echo "NX_HEAD=${{ github.sha }}" >> "$GITHUB_ENV"

      - name: Fetch base commit for Nx diff
        if: env.NX_BASE != ''
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          if ! git cat-file -e "${NX_BASE}^{commit}" 2>/dev/null; then
            git fetch --no-tags origin "${{ github.event.pull_request.base.ref }}"
            git fetch --no-tags origin "${NX_BASE}" || true
          fi

      - name: Run affected builds
        run: |
          if [ -n "${NX_BASE:-}" ] && [ -n "${NX_HEAD:-}" ]; then
            pnpm exec nx affected -t build --parallel --base="$NX_BASE" --head="$NX_HEAD"
          else
            pnpm exec nx affected -t build --parallel
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-artifacts
          path: |
            packages/*/dist
            apps/*/dist
          retention-days: 1

  # Unit tests job (depends on build)
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [setup, build]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with: { node-version: ${{ env.NODE_VERSION }}, cache: pnpm }

      - name: Download dependencies
        uses: actions/download-artifact@v4
        with:
          name: dependencies

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - uses: nrwl/nx-set-shas@v4

      - name: Configure Nx base/head for PR
        if: github.event_name == 'pull_request'
        run: |
          echo "NX_BASE=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_ENV"
          echo "NX_HEAD=${{ github.sha }}" >> "$GITHUB_ENV"

      - name: Run unit tests
        run: |
          if [ -n "${NX_BASE:-}" ] && [ -n "${NX_HEAD:-}" ]; then
            pnpm exec nx affected -t test:unit --parallel --base="$NX_BASE" --head="$NX_HEAD"
          else
            pnpm exec nx affected -t test:unit --parallel
          fi

      - name: Upload unit test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: |
            coverage/unit/
            **/test-results.xml
          retention-days: 7

  # Integration tests job (depends on build)
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [setup, build]
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with: { node-version: ${{ env.NODE_VERSION }}, cache: pnpm }

      - name: Download dependencies
        uses: actions/download-artifact@v4
        with:
          name: dependencies

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - uses: nrwl/nx-set-shas@v4

      - name: Configure Nx base/head for PR
        if: github.event_name == 'pull_request'
        run: |
          echo "NX_BASE=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_ENV"
          echo "NX_HEAD=${{ github.sha }}" >> "$GITHUB_ENV"

      - name: Wait for MongoDB
        run: |
          timeout 60 bash -c 'until mongosh --eval "db.runCommand({ping: 1})"; do sleep 2; done'

      - name: Run integration tests
        run: |
          if [ -n "${NX_BASE:-}" ] && [ -n "${NX_HEAD:-}" ]; then
            pnpm exec nx affected -t test:integration --parallel --base="$NX_BASE" --head="$NX_HEAD"
          else
            pnpm exec nx affected -t test:integration --parallel
          fi
        env:
          MONGODB_URI: mongodb://localhost:27017/test_integration
          NODE_ENV: test

      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            coverage/integration/
            **/test-results.xml
          retention-days: 7

  # Status check job that depends on all parallel jobs
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [typecheck, lint, build, test-unit, test-integration]
    if: always()
    
    steps:
      - name: Check job statuses
        run: |
          echo "Typecheck: ${{ needs.typecheck.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Unit Tests: ${{ needs.test-unit.result }}"
          echo "Integration Tests: ${{ needs.test-integration.result }}"
          
          if [[ "${{ needs.typecheck.result }}" == "failure" || 
                "${{ needs.lint.result }}" == "failure" || 
                "${{ needs.build.result }}" == "failure" || 
                "${{ needs.test-unit.result }}" == "failure" || 
                "${{ needs.test-integration.result }}" == "failure" ]]; then
            echo "❌ CI pipeline failed"
            exit 1
          else
            echo "✅ CI pipeline passed"
          fi