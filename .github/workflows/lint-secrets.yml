name: Secret Leak Guard
on:
    pull_request:
    push:
        branches: [main]

jobs:
    lint-secrets:
        permissions:
            contents: read
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
            - name: Grep for tokens outside access layer
              run: |
                  set -euo pipefail
                  MATCHES=$(grep -RInE "DISCORD_TOKEN|CLIENT_SECRET|REFRESH_TOKEN|bot_token" \
                    --exclude-dir=.git \
                    --exclude-dir=services/ts/discord-rest \
                    --exclude-dir=services/ts/discord-gateway \
                    --exclude=config/providers.yml \
                    . || true)
                  if [ -n "$MATCHES" ]; then
                    echo "Secret-like strings found outside allowed paths:" >&2
                    echo "$MATCHES" >&2
                    exit 1
                  fi
