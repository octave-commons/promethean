---
uuid: "pantheon-security-004"
title: "Add Input Validation and Sanitization to Pantheon"
slug: "2025.10.26.pantheon-input-validation-security"
status: "incoming"
priority: "P0"
labels: ["pantheon", "security", "critical", "validation", "p0"]
created_at: "2025-10-26T20:15:00.000Z"
estimates:
  complexity: "medium"
  scale: "feature"
  time_to_completion: "1 week"
---

## Context

Add comprehensive input validation and sanitization to prevent code injection, malformed data attacks, and improve error handling throughout the Pantheon framework.

## Security Vulnerabilities

**CURRENT ISSUES:**
```typescript
// packages/pantheon/src/cli/index.ts:76 - Unsafe JSON parsing
const config = JSON.parse(options.config);

// packages/pantheon/src/cli/index.ts:242 - Unsafe JSON parsing  
args = JSON.parse(argsString);

// No schema validation anywhere
// No input sanitization
// Poor error handling for malformed inputs
```

**RISKS:**
- Code injection via malicious JSON
- System crashes from malformed input
- No validation of actor configurations
- Potential security bypasses

## Solution Required

### 1. Schema Validation with Zod
- Define schemas for all input types
- Validate all JSON parsing operations
- Sanitize string inputs
- Type-safe configuration validation

### 2. Input Sanitization
- Remove dangerous characters from strings
- Validate file paths to prevent traversal
- Sanitize user messages and goals
- Validate actor names and types

### 3. Error Handling
- Structured error responses
- User-friendly error messages
- Security-safe error details
- Proper error logging

### 4. Files to Modify
- `packages/pantheon/src/cli/index.ts` - Add validation to all commands
- `packages/pantheon/src/validation/` - New validation directory
  - `schemas.ts` - Zod schema definitions
  - `sanitizers.ts` - Input sanitization functions
  - `errors.ts` - Custom error types
- `packages/pantheon/src/core/` - Add validation to core operations

## Acceptance Criteria

- [ ] All JSON parsing uses schema validation
- [ ] Input sanitization implemented for all user inputs
- [ ] Custom error types with proper handling
- [ ] Security-safe error messages
- [ ] Comprehensive test coverage for validation
- [ ] Performance impact minimal (<5% overhead)

## Technical Implementation

### Zod Schema Definitions
```typescript
import { z } from 'zod';

export const ActorConfigSchema = z.object({
  name: z.string().min(1).max(100).regex(/^[a-zA-Z0-9_-]+$/),
  type: z.enum(['llm', 'tool', 'composite']),
  goal: z.string().min(1).max(500).trim(),
  config: z.record(z.unknown()).optional(),
  model: z.object({
    provider: z.string().min(1),
    name: z.string().min(1),
    temperature: z.number().min(0).max(2).optional(),
    maxTokens: z.number().positive().optional(),
  }).optional(),
});

export const ToolExecutionSchema = z.object({
  toolName: z.string().min(1),
  args: z.record(z.unknown()).refine(
    (args) => !args.toString().includes('__proto__'),
    { message: 'Prototype pollution detected' }
  ),
});
```

### Safe JSON Parsing
```typescript
export const safeJsonParse = <T>(input: string, schema: z.ZodSchema<T>): T => {
  try {
    const parsed = JSON.parse(input);
    return schema.parse(parsed);
  } catch (error) {
    if (error instanceof SyntaxError) {
      throw new ValidationError('Invalid JSON format');
    }
    if (error instanceof z.ZodError) {
      throw new ValidationError(
        `Validation failed: ${error.errors.map(e => e.message).join(', ')}`
      );
    }
    throw new ValidationError('Input validation failed');
  }
};
```

### Input Sanitization
```typescript
export const sanitizeString = (input: string, maxLength: number = 1000): string => {
  return input
    .slice(0, maxLength)
    .replace(/[<>]/g, '') // Remove HTML tags
    .replace(/javascript:/gi, '') // Remove JS protocols
    .replace(/data:/gi, '') // Remove data URLs
    .trim();
};

export const sanitizeFilePath = (path: string): string => {
  // Prevent path traversal
  const normalized = path.replace(/\.\./g, '').replace(/^\//, '');
  return normalized;
};
```

### CLI Integration
```typescript
program
  .command('actor:create')
  .argument('<type>', 'Actor type')
  .argument('<name>', 'Actor name')
  .option('--goal <goal>', 'Initial goal')
  .option('--config <config>', 'JSON configuration')
  .action(async (type, name, options) => {
    try {
      // Validate inputs
      const validatedConfig = safeJsonParse(
        options.config || '{}', 
        ActorConfigSchema
      );
      
      const validatedGoal = sanitizeString(options.goal || 'Assist with tasks');
      
      // Continue with validated inputs
      const actor = await createActor({
        type,
        name: sanitizeString(name),
        goal: validatedGoal,
        config: validatedConfig
      });
      
    } catch (error) {
      if (error instanceof ValidationError) {
        console.error(`Validation error: ${error.message}`);
        process.exit(1);
      }
      throw error;
    }
  });
```

### Custom Error Types
```typescript
export class ValidationError extends Error {
  constructor(message: string, public details?: any) {
    super(message);
    this.name = 'ValidationError';
  }
}

export class SecurityError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'SecurityError';
  }
}
```

## Risk Level

**HIGH** - Input validation vulnerabilities can lead to system compromise

## Dependencies

- Depends on: "Critical: Implement Pantheon Authentication System"

## Testing Requirements

- Unit tests for all validation functions
- Integration tests for CLI command validation
- Security tests for injection attempts
- Performance tests for validation overhead
