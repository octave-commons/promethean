---
uuid: "ca84477b-20d4-4d49-8457-96d3e9749b6a"
title: "Implement Scar Context Builder"
slug: "20251011235168"
status: "todo"
priority: "P1"
labels: ["tool:codex", "cap:codegen", "env:no-egress", "role:engineer", "enhancement", "kanban", "heal-command", "scar-context", "context-builder", "phase-1"]
created_at: "2025-10-12T23:41:48.142Z"
estimates:
  complexity: ""
  scale: ""
  time_to_completion: ""
---





















# Implement Scar Context Builder

## ğŸ¯ Overview

Implement the core scar context builder that creates and manages the context object used throughout the heal command operations. This component is responsible for initializing context with reason, event logs, previous scars, and search results.

## ğŸ“‹ Context & Goals

### Current State

- Scar context types are defined (Task 1.1.1)
- Basic kanban task management utilities exist
- Git integration functions are available

### Target State

- Functional scar context builder with initialization capabilities
- Event logging integration for operation tracking
- Previous scar loading from scar.jsonl file
- Search result integration from kanban search commands
- Context accumulation with Markdown headers

### Success Metrics

- âœ… Scar context creation completes in <100ms
- âœ… Event logging captures all operations accurately
- âœ… Previous scars loaded correctly from file
- âœ… Search results integrated properly
- âœ… Context accumulation works with Markdown formatting

## ğŸ¯ Definition of Done

### Core Requirements

- [ ] ScarContextBuilder class implemented in `packages/kanban/src/lib/heal/context-builder.ts`
- [ ] Context initialization with reason, event log, previous scars, search results
- [ ] JSON metadata generation with Git tag name and narrative
- [ ] Context accumulation with Markdown headers for new information
- [ ] Event logging integration for all operations
- [ ] Error handling for file operations and data validation
- [ ] Unit tests with >90% coverage

### Quality Gates

- [ ] Code review approved by team lead
- [ ] Performance benchmarks meet requirements
- [ ] Error handling covers all edge cases
- [ ] Integration tests pass

## ğŸ”§ Implementation Details

### File Structure

```
packages/kanban/src/lib/heal/
â”œâ”€â”€ context-builder.ts (new)
â”œâ”€â”€ scar-context-manager.ts (new)
â””â”€â”€ utils/
    â”œâ”€â”€ file-utils.ts (new)
    â””â”€â”€ markdown-utils.ts (new)
```

### Core Classes to Implement

#### 1. ScarContextBuilder

```typescript
class ScarContextBuilder {
  private context: ScarContext;
  private eventLogger: EventLogger;

  constructor(reason: string, config: ScarConfig);

  // Initialize context with basic information
  async initialize(): Promise<ScarContext>;

  // Load previous scars from scar.jsonl
  async loadPreviousScars(): Promise<ScarRecord[]>;

  // Execute search and integrate results
  async integrateSearchResults(query: string): Promise<SearchResult[]>;

  // Generate JSON metadata
  generateMetadata(): { tag: string; narrative: string };

  // Add new information to context with Markdown headers
  addToContext(header: string, content: string): void;

  // Get the built context
  getContext(): ScarContext;
}
```

#### 2. EventLogger

```typescript
class EventLogger {
  private events: EventLogEntry[] = [];

  log(
    operation: string,
    details: Record<string, any>,
    severity: 'info' | 'warning' | 'error',
  ): void;

  getEvents(): EventLogEntry[];

  clear(): void;
}
```

#### 3. ScarContextManager

```typescript
class ScarContextManager {
  // Save context to file for persistence
  async saveContext(context: ScarContext, filePath: string): Promise<void>;

  // Load context from file
  async loadContext(filePath: string): Promise<ScarContext>;

  // Validate context integrity
  validateContext(context: ScarContext): boolean;
}
```

### Implementation Tasks

1. **Core Builder Implementation**

   - Implement ScarContextBuilder class with all methods
   - Add context initialization logic
   - Integrate event logging

2. **Metadata Generation**

   - Implement Git tag name generation
   - Add narrative generation using LLM or templates
   - Create JSON metadata structure

3. **File Operations**

   - Implement scar.jsonl reading and parsing
   - Add context persistence capabilities
   - Handle file system errors gracefully

4. **Search Integration**

   - Integrate with existing kanban search functionality
   - Parse and format search results
   - Add results to context structure

5. **Context Accumulation**
   - Implement Markdown header formatting
   - Add content accumulation logic
   - Maintain context structure integrity

## ğŸ§© Sub-tasks

### 1.1.2.1: Core Builder Class (1 hour)

- Implement ScarContextBuilder with basic initialization
- Add event logging integration
- Implement context accumulation

### 1.1.2.2: File Operations & Metadata (1 hour)

- Implement scar.jsonl loading
- Add metadata generation
- Implement context persistence

## ğŸ”— Dependencies

- **Requires**: Task 1.1.1 (Scar Context Types)
- **Blocks**: Task 1.2.1 (Git Workflow Integration)
- **Related**: Task 2.1.1 (DSL Core Engine)

## ğŸ“ Implementation Files

- `packages/kanban/src/lib/heal/context-builder.ts` (new)
- `packages/kanban/src/lib/heal/scar-context-manager.ts` (new)
- `packages/kanban/src/lib/heal/utils/file-utils.ts` (new)
- `packages/kanban/src/lib/heal/utils/markdown-utils.ts` (new)

## ğŸ§ª Testing Requirements

- Unit tests for ScarContextBuilder
- Integration tests for file operations
- Mock tests for search integration
- Performance tests for context creation

## ğŸ·ï¸ Tags & Labels

**Primary**: `tool:codex`, `cap:codegen`, `env:no-egress`, `role:engineer`
**Secondary**: `feature:heal`, `component:scar-context`, `phase:1`
**Board Views**: `enhancement`, `backend`, `context-management`

## ğŸ“ Notes

The scar context builder is a critical component that initializes the entire heal operation. Ensure robust error handling and performance optimization, as this component will be called at the start of every heal operation.

---

## ğŸ—‚ Source

- Path: docs/agile/tasks/20251011235168.md
- Created: 2025-10-11T23:51:68.000Z
- Parent Task: 20251011223651.md
- Phase: 1 - Core Infrastructure




















