---
title: 'Implement Rate Limiting & DoS Protection for OpenAI Server'
description: 'Add comprehensive rate limiting and DoS protection to prevent abuse and ensure service availability'
status: 'ready'
priority: 'P0'
storyPoints: 3
tags: ['security', 'rate-limiting', 'dos-protection', 'openai-server', 'critical']
assignee: ''
createdAt: '2025-10-19T00:00:00Z'
updatedAt: '2025-10-19T00:00:00Z'
lastCommitSha: ''
dependencies: ['2025.10.19.implement-authentication-middleware-openai-server.md']
blocking: ['2025.10.19.implement-input-validation-openai-server.md']
epic: '2025.10.19.openai-server-security-hardening-epic.md'
---

## Task Overview

Implement comprehensive rate limiting and DoS protection mechanisms to address the critical vulnerability identified in the code review where the server lacks any protection against abuse.

## Acceptance Criteria

1. **Rate Limiting Implementation**

   - [ ] Global rate limiting for all endpoints
   - [ ] Per-user rate limiting after authentication
   - [ ] Endpoint-specific rate limits (stricter for expensive operations)
   - [ ] Configurable time windows and request limits

2. **DoS Protection**

   - [ ] Request size limits to prevent payload attacks
   - [ ] Connection timeout management
   - [ ] Slowloris attack protection
   - [ ] IP-based blocking for abusive behavior

3. **Advanced Features**

   - [ ] Rate limit headers in responses (X-RateLimit-\*)
   - [ ] Sliding window rate limiting
   - [ ] Burst capacity handling
   - [ ] Rate limit bypass for admin users

4. **Monitoring & Alerting**
   - [ ] Rate limit violation logging
   - [ ] Metrics for rate limit hits
   - [ ] Alerting for sustained abuse patterns
   - [ ] Dashboard integration for rate limit monitoring

## Technical Implementation Details

### Files to Modify/Create

**New Files:**

- `src/security/rateLimiter.ts` - Rate limiting logic
- `src/security/dosProtection.ts` - DoS protection mechanisms
- `src/security/rateLimitConfig.ts` - Rate limit configuration
- `src/security/middleware.ts` - Security middleware integration

**Modified Files:**

- `src/server/createServer.ts` - Register rate limiting plugins
- `src/server/chatCompletionRoute.ts` - Add endpoint-specific limits
- `src/config/index.ts` - Add rate limit configuration
- `package.json` - Add rate limiting dependencies

### Implementation Approach

```typescript
// Rate limiting configuration
export const rateLimitConfig = {
  global: {
    max: 1000, // requests per window
    windowMs: 15 * 60 * 1000, // 15 minutes
    message: 'Too many requests from this IP',
  },
  authenticated: {
    max: 5000, // higher limit for authenticated users
    windowMs: 15 * 60 * 1000,
  },
  chatCompletion: {
    max: 100, // stricter for expensive operations
    windowMs: 60 * 1000, // 1 minute
  },
  admin: {
    max: 10000, // very high for admin users
    windowMs: 15 * 60 * 1000,
  },
};

// DoS protection configuration
export const dosProtectionConfig = {
  maxRequestSize: '10mb', // limit request payload size
  requestTimeout: 30000, // 30 seconds
  keepAliveTimeout: 65000, // 65 seconds
  headersTimeout: 66000, // 66 seconds
  bodyLimit: 10485760, // 10MB
};
```

### Dependencies to Add

```json
{
  "dependencies": {
    "@fastify/rate-limit": "^9.0.1",
    "@fastify/helmet": "^11.1.1",
    "rate-limiter-flexible": "^4.0.1"
  }
}
```

### Rate Limiting Strategy

1. **Multi-Layer Approach**

   - IP-based rate limiting (first layer)
   - User-based rate limiting (after auth)
   - Endpoint-specific limits (resource protection)
   - Global server limits (overall protection)

2. **Sliding Window Implementation**

   ```typescript
   import { RateLimiterMemory } from 'rate-limiter-flexible';

   const rateLimiter = new RateLimiterMemory({
     keyGenerator: (req) => req.ip,
     points: 1000, // Number of requests
     duration: 900, // Per 15 minutes
     blockDuration: 60, // Block for 1 minute if limit exceeded
   });
   ```

3. **Response Headers**
   ```typescript
   // Add rate limit headers to responses
   reply.header('X-RateLimit-Limit', limit);
   reply.header('X-RateLimit-Remaining', remaining);
   reply.header('X-RateLimit-Reset', resetTime);
   ```

## Testing Requirements

1. **Unit Tests**

   - [ ] Rate limit calculation accuracy
   - [ ] Sliding window behavior
   - [ ] Configuration validation
   - [ ] Header generation

2. **Integration Tests**

   - [ ] Rate limit enforcement on endpoints
   - [ ] Bypass functionality for admin users
   - [ ] DoS protection under load
   - [ ] Rate limit recovery after block period

3. **Load Tests**

   - [ ] Performance under rate limit load
   - [ ] Memory usage with many tracked IPs
   - [ ] Concurrent request handling
   - [ ] Rate limit accuracy under stress

4. **Security Tests**
   - [ ] Rate limit bypass attempts
   - [ ] DDoS simulation
   - [ ] Request size limit enforcement
   - [ ] Timeout protection validation

## Configuration Management

Add rate limiting configuration to environment:

```bash
# Rate limiting environment variables
RATE_LIMIT_GLOBAL_MAX=1000
RATE_LIMIT_GLOBAL_WINDOW=900000
RATE_LIMIT_AUTH_MAX=5000
RATE_LIMIT_CHAT_MAX=100
RATE_LIMIT_ADMIN_MAX=10000
RATE_LIMIT_REQUEST_SIZE=10485760
RATE_LIMIT_TIMEOUT=30000
```

## Monitoring & Metrics

1. **Metrics to Track**

   - Rate limit violations per endpoint
   - Blocked IPs and duration
   - Request patterns and anomalies
   - Performance impact of rate limiting

2. **Alerting Rules**
   - Sustained high rate limit violations
   - Multiple IPs hitting limits simultaneously
   - Unusual request patterns
   - Rate limiting service health

## Security Considerations

1. **Rate Limit Evasion**

   - Track multiple headers for IP detection
   - Implement IP reputation scoring
   - Use CAPTCHA for suspicious behavior
   - Coordinate with authentication system

2. **Performance Impact**

   - Use efficient data structures for tracking
   - Implement cleanup for expired entries
   - Monitor memory usage of rate limiter
   - Consider Redis for distributed rate limiting

3. **Bypass Mechanisms**
   - Secure admin bypass functionality
   - Implement API key-based exceptions
   - Document bypass procedures
   - Audit bypass usage regularly

## Rollback Plan

1. Remove rate limiting plugins from server
2. Disable rate limiting middleware
3. Remove rate limiting dependencies
4. Restore original endpoint configurations

## Success Metrics

- Zero successful DoS attacks
- Rate limit accuracy > 99.9%
- Performance impact < 5% latency increase
- False positive rate < 0.1%

## Documentation Updates

1. Rate limiting configuration guide
2. API documentation with rate limit information
3. Troubleshooting guide for rate limit issues
4. Security best practices documentation

---

**Risk Level**: High (Critical DoS vulnerability)
**Estimated Effort**: 2-3 days
**Dependencies**: Authentication middleware
**Blocked By**: Authentication implementation
