---
uuid: "9a2e9225-9cbf-4ee0-ae5f-cdc6e525bbd3"
title: "stabilize duck voice streaming pipeline"
slug: "stabilize-duck-voice-streaming-pipeline"
status: "ready"
priority: "P2"
labels: ["audio", "duck", "enso"]
created_at: "2025-10-12T19:03:19.227Z"
estimates:
  complexity: ""
  scale: ""
  time_to_completion: ""
---




































































































































































Background: Duck's revival plan calls for reliable, low-latency voice delivery through the ENSO gateway. The current web client still ships a brittle AudioWorklet, the PCM16 → 16 kHz conversion path lacks shared constants, and we have no automated validation of the throttled RTC sender before traffic hits the websocket bridge.

Goal: Finish the reliability pass so Duck's browser client can stream audio predictably into ENSO and the gateway has guardrails for malformed frames.

Scope:
- Refactor `apps/duck-web` to inject transport dependencies (`openWs`, throttled RTC sender) for easier testing and to isolate blob vs. live streaming modes.
- Repair the AudioWorklet microphone pipeline so PCM16 capture, downsampling, and clamping use the shared helpers from `@promethean/duck-audio`.
- Clamp `frameDurationMs` at the gateway boundary per the voice forwarder README task and add unit tests for out-of-range frame rejection.
- Document the full audio path (browser → ENSO → Cephalon) including feature flags (`DUCK_USE_BLOBS`, `STT_TTS_ENABLED`) so QA can rehearse manual microphone tests on macOS/Linux.

Out of Scope:
- Shipping new TTS/STT providers; this task focuses on transport stability.
- Rewriting Cephalon persona logic beyond what's required for audio ingress.

Exit Criteria:
- `apps/duck-web` exposes injectable transport factories and has green AVA coverage for the microphone/RTC sender.
- The ENSO gateway rejects or clamps invalid frame durations with tests demonstrating the boundary behavior.
- Documentation under `docs/duck` (or equivalent) explains how to start the voice pipeline, enumerate flags, and validate audio end-to-end.
- Manual QA notes capture at least one verified microphone streaming session on macOS and one on Linux.



































































































































































