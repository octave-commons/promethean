---
uuid: "a7b8c9d1-e1f2-4a5b-8c9d-0e1f2a3b4c61"
title: "Implement Git Workflow Core Implementation"
slug: "20251011235213"
status: "ready"
priority: "P1"
labels: ["tool:codex", "cap:codegen", "env:no-egress", "role:engineer", "enhancement", "kanban", "heal-command", "git-workflow", "version-control", "phase-1"]
created_at: "2025-10-12T23:41:48.142Z"
estimates:
  complexity: ""
  scale: ""
  time_to_completion: ""
---

# Implement Git Workflow Core Implementation

## ğŸ¯ Overview

Implement the core Git workflow integration for the heal command, handling pre-operation and post-operation Git operations including individual commits, tag creation, and scar file management. This ensures complete auditability and version control for all healing operations.

## ğŸ“‹ Context & Goals

### Current State

- Basic Git sync utilities exist in `packages/kanban/src/lib/git-sync.ts`
- Git operations are available through existing CLI commands
- Scar context types are defined (Task 1.1.1)

### Target State

- Complete Git workflow integration for heal operations
- Individual commits for tasks directory, kanban board, dependencies
- Commit message generation from scar context
- Pre-op and post-op tag creation with proper naming
- Scar file management with JSONL format
- Git history tracking and rollback capabilities

### Success Metrics

- âœ… All Git operations complete in <2 seconds
- âœ… Commit messages are descriptive and consistent
- âœ… Tags created with proper naming convention
- âœ… Scar file format is valid and parseable
- âœ… Rollback capability works correctly

## ğŸ¯ Definition of Done

### Core Requirements

- [ ] GitWorkflow class implemented in `packages/kanban/src/lib/heal/git-workflow.ts`
- [ ] Individual commits for tasks directory, kanban board, dependencies
- [ ] Commit message generation from scar context
- [ ] Pre-op tag creation (`<scar-tag>-pre-op`)
- [ ] Post-op individual task commits with diff-based messages
- [ ] Post-op tag creation (`<scar-tag>-post-op`)
- [ ] Final scar file commit and tag creation
- [ ] Scar file management with JSONL format
- [ ] Rollback capabilities for failed operations
- [ ] Unit tests with >90% coverage

### Quality Gates

- [ ] Code review approved by team lead
- [ ] Git operations tested in repository environment
- [ ] Error handling covers all Git failure scenarios
- [ ] Performance benchmarks meet requirements

## ğŸ”§ Implementation Details

### File Structure

```
packages/kanban/src/lib/heal/
â”œâ”€â”€ git-workflow.ts (new)
â”œâ”€â”€ scar-file-manager.ts (new)
â””â”€â”€ utils/
    â”œâ”€â”€ git-utils.ts (new)
    â””â”€â”€ commit-message-generator.ts (new)
```

### Core Classes to Implement

#### 1. GitWorkflow

```typescript
class GitWorkflow {
  private repoPath: string;
  private commitMessageGenerator: CommitMessageGenerator;
  private scarFileManager: ScarFileManager;

  constructor(repoPath: string, config: GitWorkflowConfig);

  // Pre-operation workflow
  async preOperation(context: ScarContext): Promise<string>; // Returns pre-op SHA

  // Post-operation workflow
  async postOperation(context: ScarContext, modifiedTasks: Task[]): Promise<string>; // Returns post-op SHA

  // Create individual commits
  async commitTasksDirectory(context: ScarContext): Promise<string>;
  async commitKanbanBoard(context: ScarContext): Promise<string>;
  async commitDependencies(context: ScarContext): Promise<string>;

  // Create tags
  async createPreOpTag(scarTag: string, sha: string): Promise<void>;
  async createPostOpTag(scarTag: string, sha: string): Promise<void>;
  async createFinalTag(scarTag: string, sha: string): Promise<void>;

  // Rollback operations
  async rollback(targetSha: string): Promise<void>;

  // Get current repository state
  async getCurrentState(): Promise<GitState>;
}
```

#### 2. ScarFileManager

```typescript
class ScarFileManager {
  private filePath: string;

  constructor(filePath: string);

  // Load existing scars
  async loadScars(): Promise<ScarRecord[]>;

  // Add new scar record
  async addScar(scar: ScarRecord): Promise<void>;

  // Create scar file if doesn't exist
  async ensureFile(): Promise<void>;

  // Validate scar file format
  validateFile(): boolean;

  // Get scar history
  async getScarHistory(): Promise<ScarRecord[]>;
}
```

#### 3. CommitMessageGenerator

```typescript
class CommitMessageGenerator {
  // Generate commit message from scar context
  generateFromContext(context: ScarContext, operation: string): string;

  // Generate commit message from task diff
  generateFromTaskDiff(task: Task, diff: string): string;

  // Generate scar narrative for commit
  generateScarNarrative(scar: ScarRecord): string;

  // Validate commit message format
  validateMessage(message: string): boolean;
}
```

### Implementation Tasks

1. **Core Git Workflow Implementation**

   - Implement GitWorkflow class with all methods
   - Add pre-operation and post-operation workflows
   - Integrate with existing git-sync utilities

2. **Commit Management**

   - Implement individual commit logic for different file types
   - Add commit message generation from scar context
   - Create diff-based commit messages for task changes

3. **Tag Management**

   - Implement pre-op tag creation with proper naming
   - Add post-op tag creation workflow
   - Create final tag creation with scar file

4. **Scar File Management**

   - Implement JSONL scar file format
   - Add scar record creation and management
   - Create scar history tracking

5. **Error Handling & Rollback**
   - Implement rollback capabilities for failed operations
   - Add Git operation error handling
   - Create state validation and recovery

## ğŸ§© Sub-tasks

### 1.2.1.1: Core Workflow & Commit Management (1.5 hours)

- Implement GitWorkflow class
- Add commit management logic
- Implement basic tag creation

### 1.2.1.2: Scar File Management & Rollback (1.5 hours)

- Implement ScarFileManager class
- Add scar file operations
- Implement rollback capabilities

## ğŸ”— Dependencies

- **Requires**: Task 1.1.1 (Scar Context Types), Task 1.1.2 (Scar Context Builder)
- **Blocks**: Task 1.2.2 (Git Sync Extensions)
- **Related**: Task 4.1.1 (Heal Command Implementation)

## ğŸ“ Implementation Files

- `packages/kanban/src/lib/heal/git-workflow.ts` (new)
- `packages/kanban/src/lib/heal/scar-file-manager.ts` (new)
- `packages/kanban/src/lib/heal/utils/git-utils.ts` (new)
- `packages/kanban/src/lib/heal/utils/commit-message-generator.ts` (new)

## ğŸ§ª Testing Requirements

- Unit tests for GitWorkflow class
- Integration tests with real Git repository
- Mock tests for Git operations
- Rollback functionality tests
- Scar file format validation tests

## ğŸ·ï¸ Tags & Labels

**Primary**: `tool:codex`, `cap:codegen`, `env:no-egress`, `role:engineer`
**Secondary**: `feature:heal`, `component:git-workflow`, `phase:1`
**Board Views**: `enhancement`, `backend`, `version-control`

## ğŸ“ Notes

Git workflow integration is critical for auditability and rollback capabilities. Ensure all operations are atomic and can be rolled back cleanly. Test thoroughly in various Git repository states including clean, dirty, and conflicted scenarios.

---

## ğŸ—‚ Source

- Path: docs/agile/tasks/20251011235213.md
- Created: 2025-10-11T23:52:13.000Z
- Parent Task: 20251011223651.md
- Phase: 1 - Core Infrastructure
