# Babashka + Nx Automation Reference

This note inventories the commands that replaced the deprecated Makefile
entry points. Use it as the single reference when updating workflow
instructions so the documentation stays aligned.

## Core toolchain

- **Package manager** – `pnpm` $pinned via Volta / `packageManager`$.
- **Task runner** – Babashka tasks exposed as `bb <task>` (see
$$
  [`bb.edn`](../../../bb.edn)).
$$
- **Project graph** – Nx targets invoked through `pnpm exec nx`.

## Makefile → Babashka mapping

| Legacy Make target | Current command | Notes |
$$
| ------------------ | --------------- | ----- |
$$
| `make setup` | `bb setup` (installs workspace deps with pnpm) | Falls back to `bb install` for a full run. |
| `make build` | `pnpm exec nx affected -t build` | Nx respects `NX_BASE`/`NX_HEAD`; see `.github/workflows/build.yml`. |
| `make test` | `pnpm exec nx affected -t test --parallel --base="$NX_BASE" --head="$NX_HEAD"` | Set `NX_BASE`/`NX_HEAD` locally or run `bb test` for a full sweep. |
| `make coverage` | `pnpm run coverage` $delegates to `c8` + `ava`$ | `bb coverage` wraps the same scripts across packages. |
| `make simulate-ci` | `bb simulate-ci` | Currently stubbed; see TODO below. |
| `make clean` | `bb clean` | Removes build/test artifacts using git-aware globs. |

### CI parity helpers

- `bb setup-quick` – installs pnpm workspaces and shared builds quickly.
- `bb lint` / `bb lint:tasks` – lint JS/TS and board/task metadata.
- `bb simulate-ci` – prints a stub message today; the Python driver lives
  at `scripts/simulate_ci.py` and needs implementation.

## TODO

- [ ] Flesh out `scripts/simulate_ci.py` and `bb simulate-ci` to mirror
      GitHub Actions locally. Track progress in
      $[simulate-github-actions-workflow|../../prompts/simulate-github-actions-workflow.md]$.
- [ ] Notify CI + agent owners when docs change. Use this note as the
      canonical checklist before requesting reviews.

## Updated documentation set

The following documents were realigned with this reference:

- $[ci|../../ci.md]$
- $[Agile agent guidance|../../agile/agents.md]$
- $[Board automation notes|../../agile/boards/agents.md]$
- $[Autogenerated tasks|../../agile/boards/automatically-generated-tasks.md]$
- $[Epics|../../agile/boards/epics.md]$
- $[Cephalon service agent|../../services/cephalon/agents.md]$
- $[Promethean architecture chat recap|../../notes/chats/promethean-architecture-overview.md]$
- $[CI simulation prompt|../../prompts/simulate-github-actions-workflow.md]$
- $[Hy migration checklist|../../reports/hy-migration-checklist.md]$

Request review from the CI workflow owners and the board/agent maintainers
after each batch of edits so they can validate the instructions remain
accurate.
