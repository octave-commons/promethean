

```yaml
name: defender-eicar-check
on: [push]

jobs:
  av:
    runs-on: windows-latest   # pin to windows-2025 if you want stability
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write EICAR to disk (decoded just-in-time)
        shell: pwsh
        run: |
          $b64 = 'WDVPIVAlQEFQWzRcUFo2NTZDUEkrUGhQKys3NF5QeDchJEgrQCo5US1ROy1aKj1AJVBJQF4K'
          [IO.File]::WriteAllBytes("$pwd\eicar.com", [Convert]::FromBase64String($b64))

      - name: Update Defender signatures (best-effort)
        shell: pwsh
        run: |
          $mp = "$env:ProgramData\Microsoft\Windows Defender\Platform"
          $mp = Get-ChildItem $mp | Sort-Object Name -Descending | Select-Object -First 1
          & "$($mp.FullName)\MpCmdRun.exe" -SignatureUpdate

      - name: Custom scan the workspace (Defender)
        shell: pwsh
        run: |
          $mp = "$env:ProgramData\Microsoft\Windows Defender\Platform"
          $mp = Get-ChildItem $mp | Sort-Object Name -Descending | Select-Object -First 1
          $exe = Join-Path $mp.FullName 'MpCmdRun.exe'
          # ScanType 3 = custom scan; returns 0 if clean/remediated, 2 if threats found/not remediated.
          & $exe -Scan -ScanType 3 -File "$pwd" ; $code = $LASTEXITCODE
          Write-Host "MpCmdRun exit code: $code"
          exit $code

      - name: Show Defender detections (Event Log)
        if: failure()   # run when scan found something (exit 2)
        shell: pwsh
        run: |
          Get-WinEvent -LogName 'Microsoft-Windows-Windows Defender/Operational' `
            -FilterXPath "*[System[(EventID=1116 or EventID=1117)]]" -MaxEvents 10 |
            Select-Object TimeCreated, Id, Message
```

**Why this works**

* `MpCmdRun.exe` is Defender’s official CLI. `-Scan -ScanType 3 -File <dir>` runs a custom/on-demand scan that **does not depend on RTP** being on. (Use it even when RTP is disabled.) ([Microsoft Learn][1])
* The CLI exit codes are simple: **0** = clean/remediated, **2** = threat found/not remediated or scan error. We treat non-zero as “found something” and then dump evidence. ([STRONTIC][2])
* To prove the detection, read Defender’s **Operational** log: **Event ID 1116** (malware detected) and **1117** (action taken) — they’ll include the threat name (EICAR) and path. ([Microsoft Learn][3])
* If you want a stable runner image (Windows Server version), pin to `windows-2025` instead of the moving `windows-latest`. ([GitHub Docs][4])

**Notes / gotchas**

* Don’t store the literal EICAR string in your repo; write it just-in-time from base64 (as above) so nothing triggers before the scan step.
* `MpCmdRun.exe` lives under the **Platform** versioned folder (hence the directory discovery in the snippet). Microsoft explicitly documents using that path for newer platform versions. ([Microsoft Learn][1])
* If your job *still* doesn’t “fail” when EICAR is found, ensure you `exit $LASTEXITCODE` after the scan step so the job reflects the detection state (exit `2`).

If you later move this to **self-hosted** Windows runners where RTP *is* on, the same workflow still works — the EICAR file will likely be quarantined immediately (RTP), and you’ll still see **1116/1117** in the event log.

Want me to adapt this to your exact workflow file? Paste it here and I’ll patch it.

[1]: https://learn.microsoft.com/en-us/defender-endpoint/command-line-arguments-microsoft-defender-antivirus?utm_source=chatgpt.com "Use the command line to manage Microsoft Defender Antivirus - Microsoft Defender for Endpoint | Microsoft Learn"
[2]: https://strontic.github.io/xcyclopedia/library/MpCmdRun.exe-8342BF358F6681A21B0CD38299034458.html?utm_source=chatgpt.com "MpCmdRun.exe | Microsoft Malware Protection Command Line Utility | STRONTIC"
[3]: https://learn.microsoft.com/en-us/defender-endpoint/troubleshoot-microsoft-defender-antivirus?utm_source=chatgpt.com "Microsoft Defender Antivirus event IDs and error codes - Microsoft Defender for Endpoint | Microsoft Learn"
[4]: https://docs.github.com/en/actions/reference/runners/github-hosted-runners?utm_source=chatgpt.com "GitHub-hosted runners reference - GitHub Docs"
