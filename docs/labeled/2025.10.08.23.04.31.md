---
uuid: 1d15e213-46d7-4f36-9e56-42f662d84a18
created_at: '2025-10-08T23:04:31Z'
title: 2025.10.08.23.04.31
filename: 2025.10.08.23.04.31
description: DocOps summary for 2025.10.08.23.04.31
tags:
  - 2025.10.08.23.04.31
  - docops
  - autogenerated
related_to_uuid: []
related_to_title: []
references: []
---
# Goal

Prevent MCP registration from passing **raw Zod shapes** into the SDK. Wrap `ZodRawShape` in a proper `z.object(...).strict()` before calling `registerTool`.

# Why

The error `keyValidator._parse is not a function` typically happens when code expects a **Zod schema instance** but receives a **plain object**. In this repo, we forward `ZodRawShape` directly to the MCP SDK during tool registration, which triggers that failure.

---

# Edit 1 — Wrap schemas at registration

**File:** `packages/mcp/src/core/mcp-server.ts`

**Change A (imports)**

* **Before (line 5):**

```ts
import type { ZodRawShape } from 'zod';
```

* **After (line 5):**

```ts
import { z, type ZodRawShape } from 'zod';
```

**Change B (wrap shapes when defining `def`)**

* **Before (lines 47–52):**

```ts
47     const def: ToolDef = {
48       title: t.spec.name,
49       description: t.spec.description,
50       ...(t.spec.inputSchema ? { inputSchema: t.spec.inputSchema } : {}),
51       ...(t.spec.outputSchema ? { outputSchema: t.spec.outputSchema } : {}),
52     };
```

* **After (replace lines 47–52 with):**

```ts
47     const def: ToolDef = {
48       title: t.spec.name,
49       description: t.spec.description,
50       ...(t.spec.inputSchema
51         ? { inputSchema: z.object(t.spec.inputSchema).strict() }
52         : {}),
53       ...(t.spec.outputSchema
54         ? { outputSchema: z.object(t.spec.outputSchema).strict() }
55         : {}),
56     };
```

That’s it for the code fix. The rest of the file can remain unchanged.

---

# Sanity checks (quick)

1. **Types compile**

* Run: `pnpm --filter @promethean/mcp typecheck`
* Expect no TS errors.

2. **Build**

* Run: `pnpm --filter @promethean/mcp build`
* Expect successful `dist/` emit.

3. **Smoke test MCP server registration**

* Minimal run: `pnpm --filter @promethean/mcp dev`
* Confirm the previous `_parse` error no longer occurs during tool registration.

---

# Optional hardening (follow-ups)

* In `packages/mcp/src/core/types.ts`, the comment says:

  > “the SDK expects a ZodRawShape (a flat object of fields), not a z.object(...)”

  That may be true for your **OpenAPI** path (you already wrap shapes there before converting to JSON schema), but **the SDK’s server** clearly needs an actual Zod schema at registration time. Consider clarifying that in the docstring to avoid future regressions:

  **File:** `packages/mcp/src/core/types.ts`

  * Add a note to `ToolSpec.inputSchema`/`outputSchema` JSDoc:
    “When registering with MCP server, these raw shapes are wrapped via `z.object(shape).strict()`.”

* Add an AVA test that ensures `createMcpServer` **doesn’t throw** when a tool provides a `ZodRawShape`. (You can stub or spy on SDK if needed, but even just calling `createMcpServer([{spec:{...}, invoke: async () => null}])` is a decent smoke test.)

---

# Summary for the agent

* Edit `packages/mcp/src/core/mcp-server.ts` **line 5** to import `z`.
* Replace the `def` block at **lines 47–52** with the wrapped versions shown above (final lines 47–56 after insertion).
* Rebuild and run a quick smoke test to verify the error is gone.

