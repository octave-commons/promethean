---
uuid: 3841ef7c-f41e-467f-87ae-f722d99e9e0c
created_at: per-domain-policy-system-for-js-crawler.md
filename: per-domain-policy-system-for-js-crawler
title: per-domain-policy-system-for-js-crawler
description: >-
  A YAML-based policy system for configuring JS crawlers with per-domain rules,
  throttling, authentication, and resource handling without Python or SaaS
  dependencies.
tags:
  - yaml
  - crawler
  - policy
  - throttling
  - authentication
  - resource-handling
  - domain-specific
  - extraction
related_to_uuid:
  - bd4f0976-0d5b-47f6-a20a-0601d1842dc1
  - 4330e8f0-5f46-4235-918b-39b6b93fa561
  - 008f2ac0-bfaa-4d52-9826-2d5e86c0059f
  - 5020e892-8f18-443a-b707-6d0f3efcfe22
  - 75ea4a6a-8270-488d-9d37-799c288e5f70
  - 30ec3ba6-fbca-4606-ac3e-89b747fbeb7c
  - 54382370-1931-4a19-a634-46735708a9ea
  - d8059b6a-c1ec-487d-8e0b-3ce33d6b4d06
  - 45cd25b5-ed36-49ab-82c8-10d0903e34db
  - e87bc036-1570-419e-a558-f45b9c0db698
  - c6e87433-ec5d-4ded-bb1a-fb8734a3cfd9
  - f7702bf8-f7db-473c-9a5b-8dbf66ad3b9e
  - 5e8b2388-022b-46cf-952c-36ae9b8f0037
  - 938eca9c-97e2-4bcc-8653-b0ef1a5ac7a3
  - 7cfc230d-8ec2-4cdb-b931-8aec26de2a00
  - 5e408692-0e74-400e-a617-84247c7353ad
  - 6cb4943e-8267-4e27-8618-2ce0a464d173
  - 9e8ae388-767a-4ea8-9f2e-88801291d947
  - 71726f04-eb1c-42a5-a5fe-d8209de6e159
  - 73d3dbf6-9240-46fd-ada9-cc2e7e00dc5f
  - b09141b7-544f-4c8e-8f49-bf76cecaacbb
  - 0f6f8f38-98d0-438f-9601-58f478acc0b7
  - 10d98225-12e0-4212-8e15-88b57cf7bee5
  - 13951643-1741-46bb-89dc-1beebb122633
  - 18344cf9-0c49-4a71-b6c8-b8d84d660fca
related_to_title:
  - Prompt_Folder_Bootstrap
  - Stateful Partitions and Rebalancing
  - eidolon-field-math-foundations
  - Chroma Toolkit Consolidation Plan
  - Services
  - Unique Info Dump Index
  - Migrate to Provider-Tenant Architecture
  - schema-evolution-workflow
  - Diagrams
  - DSL
  - Math Fundamentals
  - Dynamic Context Model for Web Components
  - Eidolon Field Abstract Model
  - eidolon-node-lifecycle
  - field-dynamics-math-blocks
  - i3-bluetooth-setup
  - Tooling
  - Window Management
  - Duck's Self-Referential Perceptual Loop
  - Debugging Broker Connections and Agent Behavior
  - field-interaction-equations
  - windows-tiling-with-autohotkey
  - Creative Moments
  - Duck's Attractor States
  - Promethean Chat Activity Report
references:
  - uuid: bd4f0976-0d5b-47f6-a20a-0601d1842dc1
    line: 6677
    col: 0
    score: 1
  - uuid: ac9d3ac5-9a6a-4180-a67f-1ab7e229d981
    line: 483
    col: 0
    score: 1
  - uuid: 4330e8f0-5f46-4235-918b-39b6b93fa561
    line: 1321
    col: 0
    score: 1
  - uuid: c3cd4f65-2bb3-4fca-a32e-2ac667e03f40
    line: 561
    col: 0
    score: 1
  - uuid: ba11486b-b0b0-4d9d-a0d1-1d91ae34de55
    line: 522
    col: 0
    score: 1
  - uuid: 78eeedf7-75bc-4692-a5a7-bb6857270621
    line: 1015
    col: 0
    score: 1
  - uuid: 7b7ca860-780c-44fa-8d3f-be8bd9496fba
    line: 1228
    col: 0
    score: 1
  - uuid: ed6f3fc9-5eb1-482c-8b3c-f0abc5aff2a2
    line: 173
    col: 0
    score: 1
  - uuid: 62bec6f0-4e13-4f38-aca4-72c84ba02367
    line: 1057
    col: 0
    score: 1
  - uuid: 1b1338fc-bb4d-41df-828f-e219cc9442eb
    line: 513
    col: 0
    score: 1
  - uuid: bb7f0835-c347-474f-bfad-eabd873b51ad
    line: 618
    col: 0
    score: 1
  - uuid: 930054b3-ba95-4acf-bb92-0e3ead25ed0b
    line: 187
    col: 0
    score: 1
  - uuid: 5020e892-8f18-443a-b707-6d0f3efcfe22
    line: 999
    col: 0
    score: 1
  - uuid: 45cd25b5-ed36-49ab-82c8-10d0903e34db
    line: 519
    col: 0
    score: 1
  - uuid: e87bc036-1570-419e-a558-f45b9c0db698
    line: 466
    col: 0
    score: 1
  - uuid: c1618c66-f73a-4e04-9bfa-ef38755f7acc
    line: 505
    col: 0
    score: 1
  - uuid: c6e87433-ec5d-4ded-bb1a-fb8734a3cfd9
    line: 451
    col: 0
    score: 1
  - uuid: f1add613-656e-4bec-b52b-193fd78c4642
    line: 178
    col: 0
    score: 1
  - uuid: 75ea4a6a-8270-488d-9d37-799c288e5f70
    line: 437
    col: 0
    score: 1
  - uuid: 623a55f7-685c-486b-abaf-469da1bbbb69
    line: 367
    col: 0
    score: 1
  - uuid: 557309a3-c906-4e97-8867-89ffe151790c
    line: 378
    col: 0
    score: 1
  - uuid: 78eeedf7-75bc-4692-a5a7-bb6857270621
    line: 1016
    col: 0
    score: 1
  - uuid: ed6f3fc9-5eb1-482c-8b3c-f0abc5aff2a2
    line: 175
    col: 0
    score: 1
  - uuid: 30ec3ba6-fbca-4606-ac3e-89b747fbeb7c
    line: 1221
    col: 0
    score: 1
  - uuid: 62bec6f0-4e13-4f38-aca4-72c84ba02367
    line: 1058
    col: 0
    score: 1
  - uuid: 1b1338fc-bb4d-41df-828f-e219cc9442eb
    line: 515
    col: 0
    score: 1
  - uuid: 10d98225-12e0-4212-8e15-88b57cf7bee5
    line: 251
    col: 0
    score: 1
  - uuid: 13951643-1741-46bb-89dc-1beebb122633
    line: 559
    col: 0
    score: 1
  - uuid: 008f2ac0-bfaa-4d52-9826-2d5e86c0059f
    line: 1033
    col: 0
    score: 1
  - uuid: 45cd25b5-ed36-49ab-82c8-10d0903e34db
    line: 104
    col: 0
    score: 1
  - uuid: e87bc036-1570-419e-a558-f45b9c0db698
    line: 101
    col: 0
    score: 1
  - uuid: c1618c66-f73a-4e04-9bfa-ef38755f7acc
    line: 92
    col: 0
    score: 1
  - uuid: 75ea4a6a-8270-488d-9d37-799c288e5f70
    line: 102
    col: 0
    score: 1
  - uuid: 623a55f7-685c-486b-abaf-469da1bbbb69
    line: 84
    col: 0
    score: 1
  - uuid: 6cb4943e-8267-4e27-8618-2ce0a464d173
    line: 96
    col: 0
    score: 1
  - uuid: cdbd21ee-25a0-4bfa-884c-c1b948e9b0b2
    line: 55
    col: 0
    score: 1
  - uuid: 2792d448-c3b5-4050-93dd-93768529d99c
    line: 89
    col: 0
    score: 1
  - uuid: 71726f04-eb1c-42a5-a5fe-d8209de6e159
    line: 110
    col: 0
    score: 1
  - uuid: f7702bf8-f7db-473c-9a5b-8dbf66ad3b9e
    line: 477
    col: 0
    score: 1
  - uuid: 008f2ac0-bfaa-4d52-9826-2d5e86c0059f
    line: 215
    col: 0
    score: 1
  - uuid: 938eca9c-97e2-4bcc-8653-b0ef1a5ac7a3
    line: 127
    col: 0
    score: 1
  - uuid: a4d90289-798d-44a0-a8e8-a055ae12fb52
    line: 224
    col: 0
    score: 1
  - uuid: 7cfc230d-8ec2-4cdb-b931-8aec26de2a00
    line: 233
    col: 0
    score: 1
  - uuid: e87bc036-1570-419e-a558-f45b9c0db698
    line: 16
    col: 0
    score: 1
  - uuid: c1618c66-f73a-4e04-9bfa-ef38755f7acc
    line: 67
    col: 0
    score: 1
  - uuid: c6e87433-ec5d-4ded-bb1a-fb8734a3cfd9
    line: 44
    col: 0
    score: 1
  - uuid: f1add613-656e-4bec-b52b-193fd78c4642
    line: 96
    col: 0
    score: 1
  - uuid: 75ea4a6a-8270-488d-9d37-799c288e5f70
    line: 75
    col: 0
    score: 1
  - uuid: 623a55f7-685c-486b-abaf-469da1bbbb69
    line: 71
    col: 0
    score: 1
  - uuid: 557309a3-c906-4e97-8867-89ffe151790c
    line: 76
    col: 0
    score: 1
  - uuid: 6cb4943e-8267-4e27-8618-2ce0a464d173
    line: 40
    col: 0
    score: 1
  - uuid: 9e8ae388-767a-4ea8-9f2e-88801291d947
    line: 55
    col: 0
    score: 1
  - uuid: 10d98225-12e0-4212-8e15-88b57cf7bee5
    line: 53
    col: 0
    score: 1
  - uuid: d8059b6a-c1ec-487d-8e0b-3ce33d6b4d06
    line: 578
    col: 0
    score: 1
  - uuid: 49a9a860-944c-467a-b532-4f99186a8593
    line: 93
    col: 0
    score: 1
  - uuid: c5c9a5c6-427d-4864-8084-c083cd55faa0
    line: 212
    col: 0
    score: 1
  - uuid: ac9d3ac5-9a6a-4180-a67f-1ab7e229d981
    line: 105
    col: 0
    score: 1
  - uuid: 4330e8f0-5f46-4235-918b-39b6b93fa561
    line: 653
    col: 0
    score: 1
  - uuid: 91295f3a-a2af-4050-a2b8-4777ea70c32c
    line: 84
    col: 0
    score: 1
  - uuid: c26f0044-26fe-4c43-8ab0-fc4690723e3c
    line: 30
    col: 0
    score: 1
  - uuid: 18138627-a348-4fbb-b447-410dfb400564
    line: 183
    col: 0
    score: 1
  - uuid: c3cd4f65-2bb3-4fca-a32e-2ac667e03f40
    line: 109
    col: 0
    score: 1
  - uuid: d144aa62-348c-4e5d-ae8f-38084c67ceca
    line: 209
    col: 0
    score: 1
  - uuid: 1d3d6c3a-039e-4b96-93c1-95854945e248
    line: 137
    col: 0
    score: 1
  - uuid: ca8e1399-77bf-4f77-82a3-3f703b68706d
    line: 138
    col: 0
    score: 1
  - uuid: b39dc9d4-63e2-42d4-bbcd-041ef3167bca
    line: 207
    col: 0
    score: 1
  - uuid: e2135d9f-c69d-47ee-9b17-0b05e98dc748
    line: 59
    col: 0
    score: 1
  - uuid: b22d79c6-825b-4cd3-b0d3-1cef0532bb54
    line: 1100
    col: 0
    score: 1
  - uuid: 9c79206d-4cb9-4f00-87e0-782dcea37bc7
    line: 230
    col: 0
    score: 1
  - uuid: 6bcff92c-4224-453d-9993-1be8d37d47c3
    line: 125
    col: 0
    score: 1
  - uuid: 18344cf9-0c49-4a71-b6c8-b8d84d660fca
    line: 147
    col: 0
    score: 1
  - uuid: 9e8ae388-767a-4ea8-9f2e-88801291d947
    line: 11
    col: 0
    score: 1
  - uuid: 10d98225-12e0-4212-8e15-88b57cf7bee5
    line: 47
    col: 0
    score: 1
  - uuid: 73d3dbf6-9240-46fd-ada9-cc2e7e00dc5f
    line: 105
    col: 0
    score: 1
  - uuid: cdbd21ee-25a0-4bfa-884c-c1b948e9b0b2
    line: 97
    col: 0
    score: 1
  - uuid: 2792d448-c3b5-4050-93dd-93768529d99c
    line: 128
    col: 0
    score: 1
  - uuid: e979c50f-69bb-48b0-8417-e1ee1b31c0c0
    line: 31
    col: 0
    score: 1
  - uuid: 13951643-1741-46bb-89dc-1beebb122633
    line: 90
    col: 0
    score: 1
  - uuid: 71726f04-eb1c-42a5-a5fe-d8209de6e159
    line: 33
    col: 0
    score: 1
  - uuid: f7702bf8-f7db-473c-9a5b-8dbf66ad3b9e
    line: 462
    col: 0
    score: 1
  - uuid: 623a55f7-685c-486b-abaf-469da1bbbb69
    line: 21
    col: 0
    score: 1
  - uuid: 557309a3-c906-4e97-8867-89ffe151790c
    line: 39
    col: 0
    score: 1
  - uuid: 6cb4943e-8267-4e27-8618-2ce0a464d173
    line: 28
    col: 0
    score: 1
  - uuid: 10d98225-12e0-4212-8e15-88b57cf7bee5
    line: 28
    col: 0
    score: 1
  - uuid: cdbd21ee-25a0-4bfa-884c-c1b948e9b0b2
    line: 65
    col: 0
    score: 1
  - uuid: 2792d448-c3b5-4050-93dd-93768529d99c
    line: 86
    col: 0
    score: 1
  - uuid: 71726f04-eb1c-42a5-a5fe-d8209de6e159
    line: 34
    col: 0
    score: 1
  - uuid: f7702bf8-f7db-473c-9a5b-8dbf66ad3b9e
    line: 442
    col: 0
    score: 1
  - uuid: 5e8b2388-022b-46cf-952c-36ae9b8f0037
    line: 218
    col: 0
    score: 1
  - uuid: 008f2ac0-bfaa-4d52-9826-2d5e86c0059f
    line: 176
    col: 0
    score: 1
  - uuid: 938eca9c-97e2-4bcc-8653-b0ef1a5ac7a3
    line: 70
    col: 0
    score: 1
  - uuid: 13951643-1741-46bb-89dc-1beebb122633
    line: 123
    col: 0
    score: 1
  - uuid: d17d3a96-c84d-4738-a403-6c733b874da2
    line: 587
    col: 0
    score: 1
  - uuid: 59b5670f-36d3-4d34-8985-f3144b15347a
    line: 138
    col: 0
    score: 1
  - uuid: b3555ede-324a-4d24-a885-b0721e74babf
    line: 53
    col: 0
    score: 1
  - uuid: 8430617b-80a2-4cc9-8288-9a74cb57990b
    line: 136
    col: 0
    score: 1
  - uuid: d8059b6a-c1ec-487d-8e0b-3ce33d6b4d06
    line: 613
    col: 0
    score: 1
  - uuid: 49a9a860-944c-467a-b532-4f99186a8593
    line: 59
    col: 0
    score: 1
  - uuid: c5c9a5c6-427d-4864-8084-c083cd55faa0
    line: 205
    col: 0
    score: 1
  - uuid: 4330e8f0-5f46-4235-918b-39b6b93fa561
    line: 635
    col: 0
    score: 1
---
Roger. Here’s a clean **per-domain policy system** wired into your JS crawler — no Python, no SaaS. You get a single YAML file to tune throttles, allow/deny rules, login steps, headers/cookies, extraction rules, proxy overrides (e.g., Tor via Privoxy), and per-domain limits. Drop these files in, set one env var, and go. ^ref-c03020e1-1-0

---

## 0) Compose tweak (point crawler at policies file)

Add one env var + mount (keeps your code immutable): ^ref-c03020e1-7-0

```yaml
  crawler-js:
    # ...
    environment:
      - POLICY_FILE=/workspace/policies.yaml
      # rest unchanged (PROXY_URL still works as global default)
    volumes:
      - ./infra/crawler-js:/workspace:rw
      - crawl_data:/data
      - crawl_storage:/workspace/storage
```
^ref-c03020e1-9-0 ^ref-c03020e1-20-0

---

## 1) Policy file (YAML)

`infra/crawler-js/policies.yaml` ^ref-c03020e1-26-0
 ^ref-c03020e1-27-0
```yaml
# Global defaults (used when no domain match)
defaults:
  sameDomainOnly: true
  respectRobots: true
  concurrency: 4          # per crawler (we still cap globally)
  rpm: 120                # requests per minute cap
  maxPages: 200           # global cap (crawler’s maxRequestsPerCrawl)
  maxDepth: 3             # link hop depth (0 = only seed)
  delayMs: 250            # base delay between requests
  jitterMs: 200           # random +/- added to delay
  retries: 2              # per-request retries
  dedupNormalize: true
  sitemapDiscover: true
  rssDiscover: true
  blockResources: ["image", "media", "font", "stylesheet"]  # save bandwidth
  allow: []              # regex list (case-insensitive); empty = allow all
  deny: []               # regex list; any match = block
  headers:               # sent on every request for matching domains
    Accept-Language: "en-US,en;q=0.9"
  cookies: []            # [{ name, value, domain, path, httpOnly, secure }]
  proxy: ""              # override (e.g.,  Empty = use PROXY_URL env.
  extractor:
    mode: "article"      # 'article' | 'simple' | 'raw'
    keepHtml: false

# Domain-specific overrides (first match wins). domains: list of host globs or regex.
domains:

  - name: "Hacker News"
    domains: ["news.ycombinator.com"]
    sameDomainOnly: true
    rpm: 60
    concurrency: 2
    maxPages: 500
    allow: ["^
    deny: ["\\.gif$", "\\.png$", "\\.jpg$"]
    extractor:
      mode: "simple"
      keepHtml: false

  - name: "Example Blog with login"
    domains: ["blog.example.com", "/^sub\\d+\\.example\\.com$/"]
    rpm: 30
    concurrency: 2
    maxDepth: 2
    proxy: "         # force Tor just for this domain
    headers:
      User-Agent: "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome Safari"
    cookies:
      - name: "cookie_consent"
        value: "yes"
        domain: ".example.com"
        path: "/"
        httpOnly: false
        secure: false
    login:                                # run once per origin before crawling links
      steps:
        - goto: "
        - type: { selector: "input[name='username']", text: "local_user" }
        - type: { selector: "input[name='password']", text: "local_pass" }
        - click: { selector: "button[type='submit']" }
        - waitForSelector: { selector: "nav .user-avatar", timeoutMs: 15000 }
    extractor:
      mode: "article"
      keepHtml: false

  - name: "Docs site (HTML only, no JS)"
    domains: ["docs.example.org"]
    blockResources: ["*"]  # block all non-doc requests
    sitemapDiscover: true
    rssDiscover: false
    extractor:
      mode: "raw"
      keepHtml: true

# Optional: explicit seeds (in addition to CRAWL_SEED env)
seeds:
  - "
  - "
^ref-c03020e1-27-0
``` ^ref-c03020e1-109-0

**How matching works:** `domains[].domains` accepts either host globs (e.g., `*.example.com`) or regex strings delimited with `/.../`. First match wins.

---

## 2) Add a tiny YAML dep ^ref-c03020e1-115-0

`infra/crawler-js/package.json` — add `yaml` ^ref-c03020e1-117-0

```json
{
  "name": "crawler-js",
  "private": true,
  "type": "module",
  "scripts": { "start": "node src/crawl.js" },
  "dependencies": {
    "crawlee": "^3.9.2",
    "playwright": "^1.47.2",
    "robots-parser": "^3.0.1",
    "node-fetch": "^3.3.2",
    "fast-xml-parser": "^4.5.0",
    "p-limit": "^6.2.0",
    "yaml": "^2.5.1"
  }
^ref-c03020e1-117-0
}
```

---

## 3) Wire policies into the crawler
 ^ref-c03020e1-141-0
### `infra/crawler-js/src/utils.js` (additions)

```js
import fs from 'node:fs';
import path from 'node:path';
import YAML from 'yaml';

export function loadPolicies(filePath) {
  const p = filePath || process.env.POLICY_FILE || '/workspace/policies.yaml';
  const raw = fs.readFileSync(p, 'utf8');
  const cfg = YAML.parse(raw);
  cfg.defaults ||= {};
  cfg.domains ||= [];
  cfg.seeds ||= [];
  // preprocess domain matchers
  for (const d of cfg.domains) {
    d._matchers = (d.domains || []).map(s => {
      if (s.startsWith('/') && s.endsWith('/')) return { type: 're', re: new RegExp(s.slice(1, -1), 'i') };
      // glob-ish → convert dots and * to regex
      const rx = '^' + s.replace(/[.+?^${}()|[\]\\]/g, '\\$&').replace(/\*/g, '.*') + '$';
      return { type: 'glob', re: new RegExp(rx, 'i') };
    });
  }
  return cfg;
}

export function matchPolicyFor(url, policies) {
  const host = new URL(url).hostname;
  for (const d of policies.domains) {
    if (d._matchers?.some(m => m.re.test(host))) return d;
  }
  return policies.defaults || {};
}

export function compileRegexList(csvOrList) {
  if (!csvOrList) return [];
  const items = Array.isArray(csvOrList) ? csvOrList : String(csvOrList).split(',');
^ref-c03020e1-141-0
  return items.map(s => s.trim()).filter(Boolean).map(s => new RegExp(s, 'i')); ^ref-c03020e1-180-0
}
```

(Keep your previous helpers like `sleep`, `normalizeUrlForDedup`, `buildRobotsForOrigin`, `decideUrl`—they still apply, just feed them policy-specific values.) ^ref-c03020e1-184-0

### `infra/crawler-js/src/crawl.js` (replaced core with policy-aware flow)

```js
import { PlaywrightCrawler, KeyValueStore, Dataset, log, Configuration } from 'crawlee';
import fs from 'node:fs';
import path from 'node:path';
import { Agent as HttpProxyAgent } from 'node:http';
import { Agent as HttpsProxyAgent } from 'node:https';
import { XMLParser } from 'fast-xml-parser';
import fetch from 'node-fetch';
import uaPool from './ua.json' assert { type: 'json' };
import { sleep, compileRegexList, normalizeUrlForDedup, buildRobotsForOrigin, decideUrl, loadPolicies, matchPolicyFor } from './utils.js';
import { sinkToOpenSearch, sinkToMeili } from './sinks.js';

const policies = loadPolicies();
const globalDefaults = policies.defaults || {};
const envSeed = process.env.CRAWL_SEED;
const initialSeeds = new Set([].concat(policies.seeds || [], envSeed ? [envSeed] : []));

const outputDir = process.env.OUTPUT_DIR || '/data';
fs.mkdirSync(outputDir, { recursive: true });
const outPath = path.join(outputDir, 'out.jsonl');
const appendJSONL = (o) => fs.appendFileSync(outPath, JSON.stringify(o) + '\n');

// sinks (still optional/local)
const OS_URL = process.env.SINK_OPENSEARCH_URL || '';
const OS_INDEX = process.env.SINK_OPENSEARCH_INDEX || 'documents';
const MEILI_URL = process.env.SINK_MEILI_URL || '';
const MEILI_KEY = process.env.SINK_MEILI_KEY || '';
const MEILI_INDEX = process.env.SINK_MEILI_INDEX || 'documents';

function rotateUA(i) {
  return uaPool[i % uaPool.length] || uaPool[0];
}

function buildProxyAgents(url, policy) {
  const override = policy.proxy && policy.proxy.trim() ? policy.proxy.trim() : (process.env.PROXY_URL || '').trim();
  if (!override) return { httpAgent: undefined, httpsAgent: undefined, proxyUrl: '' };
  return {
    httpAgent: new HttpProxyAgent(override),
    httpsAgent: new HttpsProxyAgent(override),
    proxyUrl: override
  };
}

async function discoverSitemaps(origin, agents, enable) {
  if (!enable) return [];
  try {
    const res = await fetch(`${origin}/sitemap.xml`, { agent: origin.startsWith('https') ? agents.httpsAgent : agents.httpAgent, timeout: 10000 });
    if (!res.ok) return [];
    const xml = await res.text();
    const parser = new XMLParser({ ignoreAttributes: false });
    const j = parser.parse(xml);
    const urls = [];
    if (j.urlset?.url) {
      const arr = Array.isArray(j.urlset.url) ? j.urlset.url : [j.urlset.url];
      for (const u of arr) if (u.loc) urls.push(u.loc);
    }
    if (j.sitemapindex?.sitemap) {
      const arr = Array.isArray(j.sitemapindex.sitemap) ? j.sitemapindex.sitemap : [j.sitemapindex.sitemap];
      for (const sm of arr) if (sm.loc) urls.push(sm.loc);
    }
    return urls;
  } catch { return []; }
}

async function discoverRSS(origin, agents, enable) {
  if (!enable) return [];
  try {
    const res = await fetch(origin, { agent: origin.startsWith('https') ? agents.httpsAgent : agents.httpAgent, timeout: 10000 });
    if (!res.ok) return [];
    const html = await res.text();
    const matches = [...html.matchAll(/<link[^>]+type=['"]application\/(rss\+xml|atom\+xml)['"][^>]*>/gi)];
    const urls = [];
    for (const m of matches) {
      const href = (m[0].match(/href='"['"]/i) || [])[1];
      if (href) urls.push(new URL(href, origin).toString());
    }
    return urls;
  } catch { return []; }
}

function extractByMode(mode, keepHtml, page) {
  return page.content().then(async html => {
    if (mode === 'raw') return keepHtml ? { html } : { text: html.replace(/\s+/g, ' ').slice(0, 500000) };
    if (mode === 'simple') {
      const title = await page.title().catch(()=> '');
      const text = await page.$eval('body', el => el.innerText).catch(()=> '');
      return keepHtml ? { title, html } : { title, text };
    }
    // 'article' heuristic (cheap)
    const title = await page.title().catch(()=> '');
    const meta = {};
    for (const n of ['og:title','og:description','description','article:author','author','og:site_name','article:published_time']) {
      try {
        meta[n] = await page.$eval(`meta[property="${n}"],meta[name="${n}"]`, el => el.content);
      } catch {}
    }
    const mainText = await page.$eval('main', el => el.innerText).catch(async () =>
      page.$eval('article', el => el.innerText).catch(async () =>
        page.$eval('body', el => el.innerText).catch(()=> '')
      )
    );
    return keepHtml ? { title, meta, html } : { title, meta, text: mainText };
  });
}

// cache: per-origin login done
const loginDone = new Set();

Configuration.set({ persistStorage: true, storageDir: './storage' });

const crawler = new PlaywrightCrawler({
  maxRequestsPerCrawl: +(process.env.CRAWL_MAX_PAGES || globalDefaults.maxPages || 200),
  maxConcurrency: +(process.env.CRAWL_CONCURRENCY || globalDefaults.concurrency || 4),
  maxRequestsPerMinute: +(process.env.CRAWL_REQS_PER_MIN || globalDefaults.rpm || 120),
  headless: true,
  requestHandlerTimeoutSecs: 90,
  launchContext: { launchOptions: { args: ['--no-sandbox', '--disable-dev-shm-usage'] } },

  async preNavigationHooks([{ request, page, session }, gotoOptions]) {
    const pol = matchPolicyFor(request.url, policies);
    const seedOrigin = new URL(request.url).origin;
    const allow = compileRegexList(pol.allow || globalDefaults.allow || []);
    const deny = compileRegexList(pol.deny || globalDefaults.deny || []);
    const sameDomainOnly = pol.sameDomainOnly ?? globalDefaults.sameDomainOnly ?? true;
    const respectRobots = pol.respectRobots ?? globalDefaults.respectRobots ?? true;
    const dedupNormalize = pol.dedupNormalize ?? globalDefaults.dedupNormalize ?? true;

    const agents = buildProxyAgents(request.url, pol);
    const urlToFetch = dedupNormalize ? normalizeUrlForDedup(request.url) : request.url;

    if (!decideUrl(urlToFetch, { sameDomainOnly, seedOrigin, allow, deny })) {
      request.noRetry = true; throw new Error('Filtered: allow/deny or cross-domain');
    }

    if (respectRobots) {
      const rb = await buildRobotsForOrigin(new URL(urlToFetch).origin, urlToFetch.startsWith('https') ? agents.httpsAgent : agents.httpAgent);
      if (!rb.isAllowed(urlToFetch, 'PrometheanCrawler')) {
        request.noRetry = true; throw new Error('Robots disallow');
      }
    }

    // headers and cookies
    const headers = { ...(globalDefaults.headers||{}), ...(pol.headers||{}) };
    request.headers = { ...(request.headers||{}), ...headers, 'User-Agent': request.headers?.['User-Agent'] || (session?.id ? rotateUA(parseInt(session.id,10)) : rotateUA(Math.floor(Math.random()*1000))) };

    if ((pol.cookies && pol.cookies.length) || (globalDefaults.cookies && globalDefaults.cookies.length)) {
      const cookies = [...(globalDefaults.cookies || []), ...(pol.cookies || [])];
      if (cookies.length) await page.context().addCookies(cookies);
    }

    // resource blocking
    const blockRules = (pol.blockResources?.length ? pol.blockResources : globalDefaults.blockResources) || [];
    if (blockRules.length) {
      await page.route('**/*', route => {
        const req = route.request();
        const type = req.resourceType();
        if (blockRules.includes('*') || blockRules.includes(type)) return route.abort();
        return route.continue();
      });
    }

    // per-domain login (once per origin)
    if (pol.login && !loginDone.has(seedOrigin)) {
      await page.context().clearCookies().catch(()=>{});
      for (const step of pol.login.steps || []) {
        if (step.goto) await page.goto(step.goto, { waitUntil: 'domcontentloaded', timeout: 30000 });
        if (step.type) await page.fill(step.type.selector, step.type.text, { timeout: 15000 });
        if (step.click) await page.click(step.click.selector, { timeout: 15000 });
        if (step.waitForSelector) await page.waitForSelector(step.waitForSelector.selector, { timeout: step.waitForSelector.timeoutMs || 15000 });
      }
      loginDone.add(seedOrigin);
    }

    // delay/jitter
    const base = +(pol.delayMs ?? globalDefaults.delayMs ?? 0);
    const jit = +(pol.jitterMs ?? globalDefaults.jitterMs ?? 0);
    if (base || jit) await new Promise(r => setTimeout(r, base + Math.floor(Math.random() * (jit + 1))));

    // proxy
    if (agents.proxyUrl) gotoOptions.proxy = { server: agents.proxyUrl };

    gotoOptions.waitUntil = 'domcontentloaded';
  },

  async requestHandler({ request, page, enqueueLinks }) {
    const pol = matchPolicyFor(request.url, policies);
    const dedupNormalize = pol.dedupNormalize ?? globalDefaults.dedupNormalize ?? true;

    const url = dedupNormalize ? normalizeUrlForDedup(request.url) : request.url;
    const title = await page.title().catch(()=>'');
    const now = new Date().toISOString();

    // extraction
    const mode = pol.extractor?.mode || globalDefaults.extractor?.mode || 'article';
    const keepHtml = pol.extractor?.keepHtml ?? globalDefaults.extractor?.keepHtml ?? false;
    const body = await extractByMode(mode, keepHtml, page);

    const doc = { url, title, fetched_at: now, ...body };

    appendJSONL(doc);
    await Dataset.pushData(doc);
    await sinkToOpenSearch([doc], { url: OS_URL, index: OS_INDEX });
    await sinkToMeili([doc], { url: MEILI_URL, index: MEILI_INDEX, apiKey: MEILI_KEY });

    // depth-aware enqueuing
    const sameDomainOnly = pol.sameDomainOnly ?? globalDefaults.sameDomainOnly ?? true;
    const allow = compileRegexList(pol.allow || globalDefaults.allow || []);
    const deny = compileRegexList(pol.deny || globalDefaults.deny || []);
    const maxDepth = +(pol.maxDepth ?? globalDefaults.maxDepth ?? 3);

    const { depth = 0 } = request.userData || {};
    if (depth < maxDepth) {
      await enqueueLinks({
        strategy: sameDomainOnly ? 'same-domain' : 'all',
        transformRequestFunction: (req) => {
          // filter by allow/deny as we queue
          if (!decideUrl(req.url, { sameDomainOnly, seedOrigin: new URL(request.url).origin, allow, deny })) return null;
          const next = dedupNormalize ? normalizeUrlForDedup(req.url) : req.url;
          return { url: next, userData: { depth: depth + 1 } };
        }
      });
    }
  },

  async failedRequestHandler({ request, error }) {
    appendJSONL({ url: request.url, error: String(error), failed_at: new Date().toISOString() });
  }
});

// bootstrap queue with policy seeds + env seed + optional sitemap/rss per domain
const rq = await KeyValueStore.open();
await rq.setValue('__meta__', { seeds: [...initialSeeds], started_at: new Date().toISOString() });

const seeds = new Set(initialSeeds);
for (const s of seeds) {
  const pol = matchPolicyFor(s, policies);
  const agents = buildProxyAgents(s, pol);
  const origin = new URL(s).origin;
  const sm = await discoverSitemaps(origin, agents, pol.sitemapDiscover ?? globalDefaults.sitemapDiscover ?? true);
  const rss = await discoverRSS(origin, agents, pol.rssDiscover ?? globalDefaults.rssDiscover ?? true);
  for (const u of sm) seeds.add(u);
  for (const u of rss) seeds.add(u);
}

^ref-c03020e1-184-0
log.setLevel(log.LEVELS.INFO);
await crawler.run([...seeds]);
console.log(`JSONL: ${outPath}`);
```
^ref-c03020e1-188-0
 ^ref-c03020e1-437-0
---
 ^ref-c03020e1-439-0
## 4) Run examples

**Local, no Tor:**
^ref-c03020e1-439-0
 ^ref-c03020e1-444-0
```bash
POLICY_FILE=./infra/crawler-js/policies.yaml \
docker compose --profile crawl-js up --build crawler-js
``` ^ref-c03020e1-449-0
^ref-c03020e1-446-0

**Through Tor/Privoxy (for matching domains only):**
^ref-c03020e1-446-0

```bash
docker compose --profile crawl-js --profile tor up -d tor privoxy
POLICY_FILE=./infra/crawler-js/policies.yaml \
docker compose --profile crawl-js up --build crawler-js
```
 ^ref-c03020e1-458-0 ^ref-c03020e1-459-0
(Any domain stanza with `proxy: " will route via Tor. Everything else follows `PROXY_URL` if set, otherwise direct.) ^ref-c03020e1-459-0 ^ref-c03020e1-460-0
 ^ref-c03020e1-460-0 ^ref-c03020e1-461-0
--- ^ref-c03020e1-461-0 ^ref-c03020e1-462-0
 ^ref-c03020e1-462-0 ^ref-c03020e1-463-0
## 5) Why this setup won’t fight you ^ref-c03020e1-463-0

* **Single source of truth**: `policies.yaml` controls throttles, RPM, depth, allow/deny, robots, headers, cookies, **login**, extract mode, and per-domain proxy.
* **Login once** per origin using deterministic steps (goto/type/click/wait). ^ref-c03020e1-467-0
* **Bandwidth sane**: resource blocking per domain (e.g., kill images/fonts on docs sites). ^ref-c03020e1-467-0
* **Extraction modes**: `article` (cheap heuristic), `simple` (title + body text), `raw` (HTML). ^ref-c03020e1-469-0
* **No surprise egress**: explicit proxy override per domain; keep the rest local. ^ref-c03020e1-469-0
* **No Python.** All Node, all the time. ^ref-c03020e1-471-0
 ^ref-c03020e1-471-0 ^ref-c03020e1-472-0
If you want, I can add a **domain-local JavaScript extractor hook** in YAML (e.g., `extractor.script: "return document.querySelector('article')?.innerText || ''"`) that we `page.evaluate()` — gives you surgical control without editing code. ^ref-c03020e1-472-0

\#webcrawling #javascript #playwright #crawlee #docker #tor #privoxy #selfhosted #opensearch #meilisearch #config-as-code #policies
