Here’s a tight, no-nonsense prompt you can drop into Codex to fix this package.

---

# Prompt for Codex (Project: `@promethean/smartgpt-bridge`)

You’re working **only** in the package `packages/smartgpt-bridge` of the monorepo at `~/devel/promethean_piper-dev-ui`. The repo is **Native ESM**, **TypeScript**, functional style, flat packages, **AVA** for tests, and all **relative imports end with `.js` in TS source** (so that emitted JS keeps `.js`).

## Current test run & failures (summarized)

Command:

```
pnpm --filter @promethean/smartgpt-bridge test
# runs build then ava on compiled dist
```

Symptoms:

1. **Path normalization unit test mismatch**

* Expected: `.../packages/smartgpt-bridge/tests/fixtures/readme.md`
* Actual:   `.../packages/smartgpt-bridge/src/tests/fixtures/readme.md`
  → Our test/fixtures live under `src/tests/...` but expectation assumes `tests/...`.

2. **Logger tests**

* “Unknown file extension .ts” when importing `src/log-stream.ts` from tests.
* ENOENT opening `/tmp/smartgpt-*.log` (file not created or dir not ensured).
  → Tests are running against **compiled `dist`**; importing TS sources in tests is wrong. Also the test doesn’t ensure the log file path exists or the write stream flushes.

3. **Sinon + ESM stubbing explodes across all integration tests**

* Error: **“ES Modules cannot be stubbed”** from `sinon-esm` in `tests/helpers/server.ts` (used by every integration test).
  → We’re attempting to `sinon.stub()` ESM module namespaces. That’s not supported. Use **dependency injection** or **test doubles for objects**, not module namespace stubs. Alternatively, factor seams and pass fakes into server factory.

4. **AVA picks up helper files as tests**

* `dist/tests/helpers/*.js` produce “No tests found… make sure to import ava at the top”.
  → AVA file globs include helpers; should include only `**/*.test.js`.

5. **Hanging/Timed out integration tests**

* Runner can’t exit; open handles (Fastify servers, SSE streams, timers, file streams) not closed in `afterEach/after.always`.
  → Need explicit `await app.close()`, cancel intervals/timeouts, end streams, restore sinon sandboxes.

6. **Symbols indexer unit test fails**

* Test expecting `true` returns `false` in `symbols.util`.
  → Likely fixture paths, index bootstrap, or the minimal TS program not including the file.

## Objectives (in order)

1. **Fix AVA config & globs**

   * Ensure AVA only runs `dist/tests/**/*\.test\.js`.
   * Exclude `helpers/` and any non-test files.
   * Keep ESM config (no CommonJS).

2. **Make tests import from `dist` consistently**

   * Unit & integration tests should import compiled modules (`../dist/...`) via paths that end with `.js`.
   * Remove any `.ts` imports from tests (or use a loader, but prefer compiled `dist`).

3. **Refactor ESM stubbing approach**

   * Stop `sinon.stub()` on ESM module namespaces.
   * Introduce **server factory** (e.g., `createServer(deps)`), where `deps` includes seams for:

     * filesystem ops (view/edit/list/tree)
     * grep/stacktrace helpers
     * symbols/indexer client
     * chroma client/search broker
     * auth provider (static token)
     * exec runner
     * logger
   * In tests, pass fakes for these deps (plain objects with functions), and use `sinon` to stub **object methods**, not modules.
   * Update `tests/helpers/server.ts` to build the app via `createServer(fakeDeps)` rather than stubbing imports.

4. **Close all resources**

   * Ensure every test using a server calls `await app.close()` in `t.teardown`.
   * Close any file streams (logger), clear timers/intervals, end SSE.
   * Use `sandbox.restore()` in `afterEach`.

5. **Fix path normalization test**

   * Either:

     * Update expected path to include `src/tests/fixtures/...`, **or**
     * Move fixtures to `tests/fixtures/...` (preferred), and update code referencing fixtures accordingly.
   * Pick one consistent fixtures location and use helpers to resolve from repo root.

6. **Logger tests**

   * Ensure the log file path exists before writing (create `/tmp` subpath if using subdirs; otherwise use `fs.mkdtemp`).
   * Flush writes (`await finished(stream)` or close the stream) before asserting file contents.
   * Avoid importing `.ts` from tests—use the built `dist/log-stream.js`.

7. **Symbols test**

   * Verify the index bootstrap includes the fixtures; if it relies on cwd, set cwd in the test tmp dir and copy fixture there or parametrize the indexer with explicit file list.
   * Assert on real found symbol names/types; avoid brittle truthy checks.

8. **Dotenv spam**

   * Silence dotenv logs during tests (set `DOTENV_CONFIG_SILENT=1` or `quiet: true` in loader path used by tests), or conditionally init only in runtime, not in test.

## Constraints & style

* TypeScript, **functional style**, no mutation, compose smaller functions.
* **Native ESM everywhere**; relative imports end with `.js` in TS.
* **AVA** for tests; prefer **fast, pure unit tests** with injected deps.
* Webcomponents/UI irrelevant here.
* All packages `"license": "GPL-3.0-only"`.
* Use `@fastify/static` where applicable (unchanged).
* Keep packages flat; don’t introduce deep nested packages.

## Deliverables

1. **Code changes**:

   * `packages/smartgpt-bridge/ava.config.mjs`: narrow `files` to `["dist/tests/**/*.test.js"]`; exclude helpers; ESM config intact.
   * `packages/smartgpt-bridge/src/server/createServer.ts`: new or refactored factory `createServer(deps)`.
   * Replace direct imports inside server routes that were being stubbed with usages of `deps` injected from factory.
   * `packages/smartgpt-bridge/src/index.ts`: wire default deps, export `createServer`.
   * Update tests under `src/tests/**` to:

     * Import `../../dist/.../*.js`
     * Use `withServer` that calls `createServer(fakeDeps)`
     * Close server & restore sandboxes
   * Logger: ensure directory creation & stream flush in tests.
   * Fixtures: pick one location (`src/tests/fixtures` or `tests/fixtures`) and fix all references and expectations.

2. **Passing tests**:

   * Unit tests pass.
   * Integration tests no longer throw “ES Modules cannot be stubbed”.
   * No timeouts; runner exits cleanly.

3. **Docs**:

   * Short `TESTING.md` in the package explaining: build-then-test flow; why we DI instead of module stubs for ESM; how to add new fakes.

## Acceptance checks (run in this order)

```
pnpm -w -r --filter @promethean/smartgpt-bridge... run --if-present build
pnpm --filter @promethean/smartgpt-bridge test
# Expect: no “ES Modules cannot be stubbed”, no “Unknown file extension .ts”,
# no AVA ‘No tests found’ for helpers, no timeouts, and green on unit + integration.
```

## Notes on approach

* **Why DI**: Node ESM forbids stubbing module namespace bindings. Seams + injected deps let us stub concrete objects safely.
* **Globs**: AVA should never pick up helper files. Only `*.test.js` in `dist/tests`.
* **Paths**: Be consistent about fixture location; normalize path assertions via `path.join(repoRoot, ...)`.
* **Streams**: Always close/file flush before assertions.

Make the minimal changes necessary to get tests green without rewriting business logic.

---
