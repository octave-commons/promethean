Alright, let’s make **one clj-kondo** the source of truth and have both editors use it—no double squiggles, consistent rules, CI-ready.

# Plan

1. Install **one global** `clj-kondo`
2. Point **Emacs** (via `clojure-lsp`) at it; **disable any extra kondo checker**
3. Point **VS Code/Calva** at it; **disable Calva’s bundled kondo**
4. Put shared rules in repo (and optionally in `$XDG_CONFIG_HOME`)
5. Wire **pre-commit**/CI so the same binary enforces it

---

## 1) Install one global clj-kondo

Pick one method (Linux examples):

* **Homebrew (Linuxbrew):**

```bash
brew install clj-kondo
which clj-kondo && clj-kondo --version
```

* **Nix:**

```bash
nix-env -iA nixpkgs.clj-kondo
```

* **Manual binary:**
  Download the release for your OS, put the binary on your `$PATH` (e.g., `~/bin/clj-kondo`), then:

```bash
chmod +x ~/bin/clj-kondo
clj-kondo --version
```

Strong opinion: use **one** path and stick to it (e.g., `/home/err/.local/bin/clj-kondo`).

---

## 2) Emacs (Spacemacs) — use LSP diagnostics, not a second kondo

**Goal:** let `clojure-lsp` surface diagnostics (which internally calls clj-kondo). Don’t enable a *separate* Flycheck checker for kondo.

In `.spacemacs`:

```elisp
dotspacemacs-configuration-layers
'(
  (lsp)                 ;; LSP backbone
  (clojure :variables
           clojure-enable-linters t)  ;; fine; clojure-lsp will provide them
  syntax-checking
)
```

Ensure Emacs shows LSP diagnostics via Flycheck (one channel only):

```elisp
(with-eval-after-load 'lsp-mode
  (setq lsp-diagnostics-provider :flycheck))
```

**Do NOT** install `flycheck-clj-kondo` or any extra checker that shells out to `clj-kondo` again. If you have it, disable/remove it.

If you need to pin the clojure-lsp server path:

```elisp
;; Optional: only if your lsp server isn’t found
(setq lsp-clojure-custom-server-command '("/path/to/clojure-lsp"))
```

You do **not** need to tell clojure-lsp where `clj-kondo` is; it reads project + user configs and runs analysis consistently. The duplication problem is caused by adding a second, parallel Flycheck checker—avoid that.

---

## 3) VS Code (Calva) — point at the same clj-kondo & disable bundled

Open **Settings (JSON)** and add:

```json
{
  // Tell Calva exactly which binary to use:
  "calva.cljKondoPath": "/home/err/.local/bin/clj-kondo",

  // Avoid double linting: do NOT also enable external shell linting extensions.
  // If Calva exposes "use bundled clj-kondo", turn it OFF.
  "calva.cljKondoUseBundled": false,

  // Optional: be explicit about the diagnostics source label
  "calva.diagnosticProvider": "clj-kondo"
}
```

(If your Calva version uses different keys, the spirit is the same: set the path, prefer external, disable bundled.)

---

## 4) Centralize rules (.clj-kondo/)

Put config **in your repo** so every tool reads the same rules:

```
your-repo/
  .clj-kondo/
    config.edn
    hooks.edn        ; optional
```

Example `config.edn` to get useful guardrails without being obnoxious:

```edn
{:linters
 {:unused-referred-var {:level :warning}
  :unused-namespace    {:level :warning}
  :redefined-var       {:level :warning}
  :unresolved-symbol   {:level :error}
  :unresolved-namespace {:level :error}
  :redundant-fn-wrapper {:level :warning}}

 ;; Tell kondo about bb namespaces if you use them a lot:
 :config-paths ["bb"]   ;; if you vendored community configs, else omit

 ;; If you have custom macros, point kondo at them:
 ;:hooks {:analyze-call {my.ns/defsomething my.kondo-hooks/defsomething}} 
}
```

Optional user-wide defaults:

```
$XDG_CONFIG_HOME/clj-kondo/config.edn
# or
~/.config/clj-kondo/config.edn
```

Repo wins over user if both exist.

---

## 5) Make it enforceable (pre-commit + CI)

### Pre-commit (staged files only)

`.git/hooks/pre-commit`:

```bash
#!/usr/bin/env bash
set -euo pipefail

KONDO="/home/err/.local/bin/clj-kondo"
CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(clj|cljs|cljc|bb)$' || true)
[ -z "$CHANGED" ] && exit 0

$KONDO --lint $CHANGED
```

```bash
chmod +x .git/hooks/pre-commit
```

### Full repo lint task (Babashka)

`bb.edn`:

```edn
{:tasks
 {:lint
  {:doc "lint the repo with clj-kondo"
   :task (shell "/home/err/.local/bin/clj-kondo --lint src test mk script bb.edn")}}}
```

Run with: `bb lint`

---

## Sanity checks

* Emacs: ensure only **one** diagnostics stream (from LSP). No separate flycheck kondo checker.
* VS Code: **no duplicates**. If you still see two messages per issue, some other extension is also firing—disable it.
* CLI: `clj-kondo --lint src` yields the same findings you see in both editors.

---

## Opinionated defaults that keep you moving

* Prefer **repo-local** `.clj-kondo/config.edn` over heavy editor-specific configs.
* Don’t chase “perfect static typing”; aim for **arity, unresolved, unused**, and a few smart linters.
* Keep **one global binary**, pin paths in tools, and call it from CI/pre-commit. Zero drift.

If you want, I’ll generate a minimal `.clj-kondo/config.edn` tailored to **bb + clj + your mcp schema code** (so it understands your custom macro shapes and quiets false positives). #clojure #clj-kondo #calva #clojure-lsp #emacs #spacemacs #linting #tooling #promethean
