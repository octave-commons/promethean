# ğŸ“ Agent Task: Refactor SmartGPT Bridge OpenAPI Spec

## ğŸ“Œ Context

The SmartGPT Bridge service (`services/ts/smartgpt-bridge/`) currently uses a hand-written OpenAPI spec in `src/spec.js`.
This spec is **incomplete and invalid** for CustomGPTs because many routes are missing `operationId`s.

This causes downstream failures when GPTs try to bind functions.

---

## ğŸ¯ Goal

Refactor the SmartGPT Bridge so that its OpenAPI spec is **auto-generated from Fastify route schemas** using `@fastify/swagger`.

This will:

* Eliminate drift between code and spec
* Ensure every route has a valid `operationId`
* Produce a stable `/openapi.json` endpoint for GPT integration

---

## âœ… Requirements

### 1. Add Swagger Setup

In the Fastify app bootstrap (e.g. `src/fastifyApp.ts` or `src/app.ts`):

```ts
import swagger from '@fastify/swagger';
import swaggerUi from '@fastify/swagger-ui';

app.register(swagger, {
  openapi: {
    info: { title: 'Promethean SmartGPT Bridge', version: '1.0.0' },
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT',
        },
      },
    },
  },
});

app.register(swaggerUi, { routePrefix: '/docs' });

// Stable GPT-compatible spec route
app.get('/openapi.json', async (_req, rep) =>
  rep.type('application/json').send(app.swagger())
);
```

---

### 2. Refactor Routes

* For each route (e.g. `/grep`, `/search`, `/files/view`, `/agent/start`), define a **schema** in the Fastify route config.
* Include at minimum:

  * `summary`
  * `operationId` (from the mapping below)
  * `tags`
  * `querystring`, `params`, or `body` validation schemas
  * `response` schemas

**Example (`routes/search.ts`):**

```ts
app.post('/search', {
  schema: {
    summary: 'Semantic search via Chroma',
    operationId: 'semanticSearch',
    tags: ['Search'],
    body: {
      type: 'object',
      required: ['q'],
      properties: {
        q: { type: 'string' },
        n: { type: 'integer', default: 8 },
      },
    },
    response: {
      200: {
        type: 'object',
        properties: {
          ok: { type: 'boolean' },
          results: { type: 'array', items: { type: 'object' } },
        },
      },
    },
  },
  handler: async (req, reply) => {
    // existing implementation
  },
});
```

---

### 3. Remove `spec.js`

* Delete `services/ts/smartgpt-bridge/src/spec.js`
* All schemas should now live inside their respective route files.

---

### 4. Operation ID Mapping

Use **exactly** these `operationId`s for each route:

#### ğŸ” Search

* `/grep` â†’ `grepFiles`
* `/search` â†’ `semanticSearch`

#### ğŸ“‚ Files

* `/files/list` â†’ `listFiles`
* `/files/view` â†’ `viewFile`
* `/stacktrace/locate` â†’ `locateStacktrace`

#### ğŸ“¦ Indexer

* `/reindex` â†’ `reindexAll`
* `/files/reindex` â†’ `reindexFiles`
* `/indexer/status` â†’ `indexerStatus`
* `/indexer/index` â†’ `indexFile`
* `/indexer/remove` â†’ `removeFileFromIndex`
* `/indexer/reset` â†’ `resetIndexer`

#### ğŸ§© Symbols

* `/symbols/index` â†’ `indexSymbols`
* `/symbols/find` â†’ `findSymbols`

#### ğŸ’» Exec

* `/exec/run` â†’ `runCommand`

#### âš™ï¸ System

* `/openapi.json` â†’ `getOpenApiSpec`

#### ğŸ¤– Agent

* `/agent/start` â†’ `startAgent`
* `/agent/status` â†’ `getAgentStatus`
* `/agent/status/{id}` â†’ `getAgentStatusById`
* `/agent/list` â†’ `listAgents`
* `/agent/logs` â†’ `getAgentLogs`
* `/agent/tail` â†’ `tailAgentLogs`
* `/agent/stream` â†’ `streamAgentLogs`
* `/agent/send` â†’ `sendAgentInput`
* `/agent/kill` â†’ `killAgent`
* `/agent/interrupt` â†’ `interruptAgent`
* `/agent/resume` â†’ `resumeAgent`

---

## ğŸ“¦ Deliverables

* Updated `fastifyApp.ts` with Swagger config
* Each route refactored with schema metadata (including `operationId`)
* Removed `spec.js`
* Working `/openapi.json` endpoint with **all routes + operationIds**
* Verified with CustomGPT integration
