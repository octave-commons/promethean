---
uuid: 92579ecd-4114-481b-b236-8820d4ef52f1
created_at: 2025.09.02.08.52.16.md
filename: vterm-prompt-tracking-solutions
description: >-
  Solutions for vterm prompt tracking and scroll management without copy mode.
  Includes directory tracking via OSC 51;A escape codes and keybindings for
  seamless prompt navigation.
tags:
  - vterm
  - prompt-tracking
  - scroll-management
  - osc-51
  - emacs
  - directory-tracking
  - keybindings
---
Got it — no copy mode. Let’s fix the two pain points directly:

# 1) Directory tracking without “injecting `cd` and hoping”

Use vterm’s **prompt/directory tracking** via escape codes. This avoids Emacs faking a `cd` and breaking when there’s junk at the prompt.

Add this to your shell (bash/zsh):

```bash
# ~/.bashrc or ~/.zshrc
vterm_printf() {
  # OSC 51;... ST
  printf "\e]51;%s\e\\" "$1"
}

# Tell vterm who/where we are whenever a prompt prints
vterm_prompt_precmd() {
  vterm_printf "A${USER}@${HOSTNAME}:$(pwd)"
}

# Bash
if [ -n "$BASH_VERSION" ]; then
  PROMPT_COMMAND="vterm_prompt_precmd${PROMPT_COMMAND:+;$PROMPT_COMMAND}"
fi

# Zsh
if [ -n "$ZSH_VERSION" ]; then
  precmd_functions+=(vterm_prompt_precmd)
fi
```

That’s exactly what the vterm README expects (OSC 51;A… payload). It enables **directory tracking** and **prompt tracking** reliably, no fake `cd` needed. ([GitHub][1], [Debian Sources][2], [Emacs Stack Exchange][3])

# 2) Scroll freely *without* getting yanked back to the prompt

Reality check: vterm auto-scrolls to the process mark by design. The official answer to “prevent auto scrolling” is *copy mode* — which you said you don’t want. ([GitHub][4])

Workable alternatives that avoid copy mode:

### A) “View-scroll” the window, then jump back to prompt on demand

Bind wheel/keys to scroll the **window** (not point), and add a single key to snap back to the prompt using vterm’s prompt-tracking commands.

```elisp
;; make wheel/page keys scroll the window without moving point
(setq scroll-preserve-screen-position t)

;; back to prompt (end of *current* prompt)
(defun err/vterm-jump-to-prompt ()
  (interactive)
  ;; move to end of next prompt; with arg -1, to previous prompt
  (vterm-next-prompt 1))

;; handy bindings in vterm
(with-eval-after-load 'vterm
  (define-key vterm-mode-map (kbd "M-]") #'err/vterm-jump-to-prompt)
  (define-key vterm-mode-map (kbd "M-[") (lambda () (interactive) (vterm-previous-prompt 1))))
```

`vterm-[previous,next]-prompt` are built-ins when prompt tracking is set up; default bindings are `C-c C-p` / `C-c C-n`. This gives you **free scroll**, then **one keystroke back to prompt** — no mode toggle. ([GitHub][5])

Tip: Emacs’s general “don’t move point when scrolling” behavior is controlled by `scroll-preserve-screen-position`; keeping it `t` helps keep the view stable while you scroll around. ([Emacs Stack Exchange][6], [Stack Overflow][7])

### B) Emergency damper: XON/XOFF (flow control)

If some runaway build keeps force-scrolling, you can pause the PTY: **`C-s` to pause, `C-q` to resume**. It’s crude, but it freezes output so you can scroll up and read — still without copy mode. Be aware it can stall the program if it expects to write. ([Super User][8])

---

## Bonus: “jump to prompt line beginning”

If you want a “go to prompt start” action (like term’s `term-bol`), you can piggyback on vterm’s prompt tracking:

```elisp
(defun err/vterm-bol ()
  (interactive)
  (vterm-previous-prompt 0) ; stay on current prompt
  (beginning-of-line)
  ;; move to first char after prompt if needed
  (when (re-search-forward "\\s-*" (line-end-position) t) (backward-char 0)))
(define-key vterm-mode-map (kbd "C-a") #'err/vterm-bol)
```

(If you’re happier with the built-ins, just use the prompt jump keys; vterm’s README documents them.) ([GitHub][1])

---

## Why this works better than “cd injection”

Because **the shell itself** pushes cwd info to Emacs (OSC 51;A …), which vterm consumes to keep `default-directory` and prompt locations in sync. No brittle command injection; no “half the time it doesn’t run” issue. ([GitHub][1], [Debian Sources][2])

---

## Quick checklist

* [x] Add OSC 51;A prompt hook to your shell for robust dir/prompt tracking. ([GitHub][1], [Debian Sources][2])
* [x] Bind a **single key** to `vterm-next-prompt` to snap back to the prompt. ([GitHub][5])
* [x] Set `scroll-preserve-screen-position` so window scrolls don’t drag point. ([Emacs Stack Exchange][6])
* [x] If output storms still yank the view, hit **`C-s` / `C-q`** to pause/resume flow. ([Super User][8])

If you want, I can wrap this into a tiny `promethean-vterm.el` with sane defaults and your keybindings.

\#emacs #vterm #i3 #dotfiles #protips

[1]: https://github.com/akermu/emacs-libvterm?utm_source=chatgpt.com "akermu/emacs-libvterm"
[2]: https://sources.debian.org/src/emacs-libvterm/0.0.2%2Bgit20250113.056ad74-1/README.md/?utm_source=chatgpt.com "File: README.md - emacs-libvterm"
[3]: https://emacs.stackexchange.com/questions/73776/opening-file-in-emacs-buffer-when-using-vterm?utm_source=chatgpt.com "Opening file in emacs buffer when using vterm"
[4]: https://github.com/akermu/emacs-libvterm/issues/397?utm_source=chatgpt.com "Prevent auto scrolling · Issue #397 · akermu/emacs-libvterm"
[5]: https://github.com/emacsmirror/vterm?utm_source=chatgpt.com "emacsmirror/vterm: Fully-featured terminal emulator"
[6]: https://emacs.stackexchange.com/questions/60995/how-to-get-scrolling-without-jumps-by-one-line-in-info-mode?utm_source=chatgpt.com "How to get scrolling without jumps (by one line) in info mode?"
[7]: https://stackoverflow.com/questions/13982486/scrolling-in-emacs-without-ever-moving-point-even-if-off-screen?utm_source=chatgpt.com "Scrolling in Emacs without ever moving point, even if off- ..."
 f wm8]: https://superuser.com/questions/1159906/how-to-set-the-linux-terminal-not-to-scroll-down-automatically-when-a-running-pr?utm_source=chatgpt.com "How to set the Linux terminal NOT to scroll down ..."
