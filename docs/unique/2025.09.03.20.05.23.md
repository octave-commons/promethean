---
uuid: a09a2867-7f5a-4864-8150-6eee881a616b
created_at: '2025-09-03T20:05:23Z'
filename: pr-688-nitpack-extract
title: pr-688-nitpack-extract
description: >-
  Extracts review nits from PR #688 into actionable repo-wide tasks via API,
  deduplication, and clustering. Generates codemod checklists and policy
  follow-ups to prevent reoccurrence.
tags:
  - pr
  - agile
  - codemod
  - dedupe
  - policy
  - task
  - repo-wide
  - api
  - deduplication
  - clustering
related_to_uuid:
  - ed2e157e-bfed-4291-ae4c-6479df975d87
  - 8792b6d3-aafd-403f-a410-e8a09ec2f8cf
  - 6420e101-2d34-45b5-bcff-d21e1c6e516b
  - 4f9a7fd9-de08-4b9c-87c4-21268bc26d54
  - 5e408692-0e74-400e-a617-84247c7353ad
  - 7a75d992-5267-4557-b464-b6c7d3f88dad
related_to_title:
  - field-interaction-equations
  - aionian-circuit-math
  - Eidolon Field Math Foundations
  - homeostasis-decay-formulas
  - i3-bluetooth-setup
  - field-dynamics-math-blocks
references:
  - uuid: ed2e157e-bfed-4291-ae4c-6479df975d87
    line: 1
    col: 0
    score: 1
  - uuid: ed2e157e-bfed-4291-ae4c-6479df975d87
    line: 3
    col: 0
    score: 1
  - uuid: ed2e157e-bfed-4291-ae4c-6479df975d87
    line: 9
    col: 0
    score: 1
  - uuid: ed2e157e-bfed-4291-ae4c-6479df975d87
    line: 11
    col: 0
    score: 1
  - uuid: ed2e157e-bfed-4291-ae4c-6479df975d87
    line: 13
    col: 0
    score: 1
  - uuid: ed2e157e-bfed-4291-ae4c-6479df975d87
    line: 17
    col: 0
    score: 1
  - uuid: ed2e157e-bfed-4291-ae4c-6479df975d87
    line: 19
    col: 0
    score: 1
  - uuid: ed2e157e-bfed-4291-ae4c-6479df975d87
    line: 62
    col: 0
    score: 0.96
  - uuid: ed2e157e-bfed-4291-ae4c-6479df975d87
    line: 82
    col: 0
    score: 0.96
  - uuid: ed2e157e-bfed-4291-ae4c-6479df975d87
    line: 37
    col: 0
    score: 0.95
  - uuid: ed2e157e-bfed-4291-ae4c-6479df975d87
    line: 121
    col: 0
    score: 0.95
  - uuid: ed2e157e-bfed-4291-ae4c-6479df975d87
    line: 102
    col: 0
    score: 0.94
  - uuid: 8792b6d3-aafd-403f-a410-e8a09ec2f8cf
    line: 17
    col: 0
    score: 0.91
  - uuid: 6420e101-2d34-45b5-bcff-d21e1c6e516b
    line: 17
    col: 0
    score: 0.91
  - uuid: 4f9a7fd9-de08-4b9c-87c4-21268bc26d54
    line: 17
    col: 0
    score: 0.9
  - uuid: 5e408692-0e74-400e-a617-84247c7353ad
    line: 2152
    col: 0
    score: 0.87
  - uuid: 5e408692-0e74-400e-a617-84247c7353ad
    line: 2128
    col: 0
    score: 0.87
  - uuid: 5e408692-0e74-400e-a617-84247c7353ad
    line: 1277
    col: 0
    score: 0.87
  - uuid: 5e408692-0e74-400e-a617-84247c7353ad
    line: 1805
    col: 0
    score: 0.87
  - uuid: 8792b6d3-aafd-403f-a410-e8a09ec2f8cf
    line: 66
    col: 0
    score: 0.87
  - uuid: 7a75d992-5267-4557-b464-b6c7d3f88dad
    line: 95
    col: 0
    score: 0.87
  - uuid: 7a75d992-5267-4557-b464-b6c7d3f88dad
    line: 59
    col: 0
    score: 0.87
  - uuid: 5e408692-0e74-400e-a617-84247c7353ad
    line: 1552
    col: 0
    score: 0.86
  - uuid: 5e408692-0e74-400e-a617-84247c7353ad
    line: 1262
    col: 0
    score: 0.86
  - uuid: 5e408692-0e74-400e-a617-84247c7353ad
    line: 1852
    col: 0
    score: 0.86
  - uuid: 5e408692-0e74-400e-a617-84247c7353ad
    line: 2143
    col: 0
    score: 0.86
  - uuid: 8792b6d3-aafd-403f-a410-e8a09ec2f8cf
    line: 85
    col: 0
    score: 0.86
  - uuid: 4f9a7fd9-de08-4b9c-87c4-21268bc26d54
    line: 61
    col: 0
    score: 0.86
  - uuid: 8792b6d3-aafd-403f-a410-e8a09ec2f8cf
    line: 105
    col: 0
    score: 0.86
  - uuid: 6420e101-2d34-45b5-bcff-d21e1c6e516b
    line: 77
    col: 0
    score: 0.86
---
### `docs/agile/tasks/pr-688-nitpack-extract.md`

**Title:** PR #688 — extract & dedupe review nits into actionable tasks
**Status:** #ready
**Actor:** #agent-mode #codex-task
**Epic:** #merge-hygiene #docops
**Priority:** P0
**Links:** PR #688

#### Intent

Pull every review comment on PR #688 via API, **normalize + deduplicate** the tiny nits, cluster them into 1–2 **repo-wide tasks** (codemods + policy), and write the tasks out as markdown checklists with exact globs and instance counts. No UI scraping, no page loads.

---

### Deliverables

1. **Task A — Codemods batch (repo-wide)**

   * A checklist of deduped rules, each with:

     * **Pattern name** (e.g., “Append `.js` to relative TS imports”)
     * **Count** of instances found
     * **Glob(s)** where they appear
     * **One-liner fix strategy** (ts-morph/jscodeshift)
   * Saved to `docs/agile/tasks/pr-688-nitpack-codemods.md`.

2. **Task B — Policy/Config follow-ups**

   * Lint/format/pre-commit rule tweaks that prevent reoccurrence (e.g., ESLint import rules, markdownlint exceptions, `.prettierignore` for dumps).
   * Saved to `docs/agile/tasks/pr-688-nitpack-policy.md`.

3. A short comment on **PR #688** linking both tasks and stating “review nits have been consolidated; follow these two tasks.”

---

### Agent playbook (how to do it without touching the UI)

1. **Fetch comments (both kinds)**

   * Review comments: `GET /repos/{owner}/{repo}/pulls/688/comments`
   * Conversation comments: `GET /repos/{owner}/{repo}/issues/688/comments`
   * If `gh` CLI available:

     * `gh api repos/{owner}/{repo}/pulls/688/comments > .cache/pr688_review.json`
     * `gh api repos/{owner}/{repo}/issues/688/comments > .cache/pr688_issue.json`

2. **Normalize**

   * Lowercase
   * Strip code fences/blocks and quoted snippets
   * Remove line/file prefixes like `packages/x/src/foo.ts:123`
   * Collapse whitespace
   * Keep **rule tokens** (e.g., “use .js suffix”, “no TS paths”, “native esm”, “no default export”, “order imports”, “prefer immutable”, “avoid mutation”, “license gpl-3.0-only”, “@fastify/static”, “don’t embed html”, “ava test”, etc.)

3. **Cluster / dedupe**

   * First pass: regex map common nits → canonical keys, e.g.:

     * `REL_JS_SUFFIX`: add `.js` to relative TS imports
     * `NO_TS_PATHS`: remove TS path aliases
     * `NATIVE_ESM`: `"type":"module"`, NodeNext, no CJS
     * `NO_DEFAULT_EXPORT`: switch to named exports
     * `IMPORT_ORDER`: consistent import grouping
     * `IMMUTABLE_FP`: no `let`, no mutation in utils
     * `GPL_ONLY`: package.json `"license":"GPL-3.0-only"`
     * `NO_EMBED_HTML`: backend must not embed HTML; serve via `@fastify/static`
     * `AVA_TESTS`: add/rename AVA tests to pattern
     * (Add more keys found in comments)
   * Second pass: fuzzy dedupe (Levenshtein/Jaccard) to merge same-meaning comments.

4. **Locate occurrences in repo**

   * For each key, compute candidate globs and counts using ripgrep:

     * e.g., `REL_JS_SUFFIX` → `rg -n "from ['\"][./]" packages/**/src/**/*.{ts,tsx}`
     * `NO_TS_PATHS` → check `tsconfig.*.json` for `paths`
     * `NO_EMBED_HTML` → `rg -n "<html|<!doctype|res.send\\(" packages/**/src/**/*.ts`
   * Record **count** and **top offending files** (cap to first 10 per key).

5. **Emit the two tasks**

   * **Task A**: for each key with `count > 0`, add a checklist item:

     * `- [ ] REL_JS_SUFFIX — 87 matches — packages/**/src/**/*.{ts,tsx} — Fix: codemod to append ".js" on relative imports`
   * **Task B**: propose minimal, enforceable config/rule changes:

     * ESLint rules (e.g., `import/extensions`, `no-restricted-imports` for TS paths)
     * `markdownlint` exceptions for dumps
     * `.prettierignore` lines to keep huge exports untouched
     * `ava` test naming/concurrency defaults
     * Pre-commit hooks ordering

6. **Save files**

   * `docs/agile/tasks/pr-688-nitpack-codemods.md`
   * `docs/agile/tasks/pr-688-nitpack-policy.md`

7. **Post summary to PR**

   * Comment with a short note and links to the two files.

---

### Acceptance criteria

* Both task files exist with **≤ 15** total checklist items, each deduped and concrete.
* Each checklist item has **counts + globs + one-line fix**.
* No lockfile or code changes made by this task—just the task files.
* A single comment posted on PR #688 linking the tasks.

---

### Guardrails (Promethean law)

* Flat `packages/` only; **no nested** package folders.
* **Native ESM** everywhere (NodeNext), **no TS paths**.
* All **relative imports end with `.js`** in TS source.
* **GPL-3.0-only** in every package.json.
* **Never** embed HTML in backend; use `@fastify/static`.

---

#### Optional: Implementation hint the agent can use (no UI)

If the agent needs to auto-fill counts/globs:

* Use `gh` + `ripgrep` only; no browser access.
* Build a tiny in-memory classifier: map regex → key, else fuzzy-hash to nearest key.
* Output markdown with sections: `## Codemods`, `## Policy`, each checklist item = one nit family.
