# Task: Fix all TypeScript import errors after file moves

**Actor:** #codex-task (automated)
**Context:** A lot of files were moved. You have two references:

* `orphan_files.txt` — files that nothing references (potentially dead or newly moved)
* `build-errors.txt` — captured TypeScript build output with errors

**Goal (non-negotiable):** Zero TS import/resolve errors with **no semantic code changes** beyond import specifiers and barrel files. Keep git diffs surgical.

---

## Definition of Done

* `pnpm -r build` succeeds across the monorepo.
* `pnpm -r -w tsc --noEmit` exits 0 (no TS2307/TS6059/etc.).
* **Zero** “Cannot find module …” and **zero** path alias resolution failures.
* Imports obey project conventions (see “Import rules”).
* Barrel files (`index.ts`) updated where applicable.
* A single PR with:

  * Summary of fixes (counts, examples)
  * Machine-generated report (see “Artifacts”)
  * Clear commit messages per package/folder.

---

## Guardrails (read this like a lawyer)

* **Do not** delete orphans automatically. Produce a plan + diff; leave deletion to humans.
* **Do not** change runtime semantics (no refactors, no API changes).
* **Do not** flip ESM/CJS, add file extensions, or touch tsconfig compiler options unless the repo’s current state **forces** it (log why if you must).
* **If ambiguous mapping (>1 candidate target)**: do **not** auto-fix; emit a “needs-human” entry with ranked candidates.

---

## Import rules (project-specific)

* Prefer **relative imports** for intra-package modules (e.g., `./foo`, `../utils/foo`).
* For shared code, use <package-name>, adding it to the package.json if it is not already there, using "file:<path-to-dep>" not deep relative paths. #critical
* Do not introduce new aliases. Use only those present in `tsconfig.json` / `tsconfig.*.json` (`baseUrl`, `paths`).
* Keep extensionless TypeScript import specifiers unless current codebase already mixes in `.js` endings for ESM; match existing local convention.

---

## Inputs

* `build-errors.txt` — raw `tsc` output. Expect lines like:

  * `error TS2307: Cannot find module 'X' or its corresponding type declarations.`
  * `error TS6059: File '…' is not under 'rootDir' '…'.`
* `orphan_files.txt` — newline-separated paths.

---

## Tools the agent may/should use

* TypeScript Language Service (via **tsserver** or **ts-morph**)
* AST utilities: **ts-morph** (preferred), `globby`, `fast-glob`
* Git plumbing (`git status`, `git diff`, `git restore`)
* Repo scripts: `pnpm -r build`, `pnpm -r -w tsc --noEmit`, `pnpm -r lint --fix`

---

## Plan of Attack (step-by-step)

### 1) Repo scan + config load

* Discover workspace packages (pnpm workspaces).
* For each package: read nearest `tsconfig.json` (merge extends) → capture `baseUrl`, `paths`, `rootDir`, `outDir`.
* Build a file index of `*.ts,*.tsx` and a symbol index (exports per file) using ts-morph.

### 2) Parse errors and normalize cases

* From `build-errors.txt`, extract:

  * **Missing module** errors (TS2307) → tuples of `(fromFile, importedSpecifier, importedBindings)`
  * **RootDir/outDir** errors (TS6059/TS6053) → misplacements to flag (don’t auto-fix by moving files; prefer fixing import roots or paths).
* Deduplicate by `(fromFile, importedSpecifier)`.

### 3) Candidate resolution for each missing specifier

For each `(fromFile, importedSpecifier)`:

**3a. Respect aliases**

* If `importedSpecifier` **matches a `paths` alias pattern**, resolve via `paths`. If target not found, check if file moved; search candidates under the alias root.

**3b. Heuristic file search**

* Build candidate list by:

  * Matching by **basename** (e.g., `UserService` → `user-service.ts`, `UserService.ts`)
  * Matching by **exported symbol names** against the imported bindings.
  * Constraining search to the same package first; then shared packages (apply rule for `@shared/ts/dist/...`).

**3c. Rank candidates**
Score = weighted sum:

* +3 same package; +2 under alias-root; +2 filename match; +2 exports match; +1 shortest relative path.
  Pick highest. If tie → mark “needs-human”.

**3d. Compute specifier**

* If target is in same package: **relative path** from `fromFile` (no extension).
* If in shared area: **`@shared/ts/dist/...`** path.
* If alias applies: prefer the alias.

**3e. Edit**

* Replace the specifier, **preserving named/default import shapes**. If imported bindings don’t exist in target, mark “needs-human”.

### 4) Barrel files (optional but recommended)

* Where `index.ts` barrels exist, ensure moved files are re-exported properly.
* If barrels are the chosen convention in a folder and many imports point at deep files, add/update re-exports to shorten import paths, but **do not** rewrite callers en masse unless trivial and safe.

### 5) Orphans triage

* Cross-reference `orphan_files.txt` with symbol index and current graph.
* Classify:

  * **Newly orphaned by moves** → propose import rewrites (list callers that likely meant to import these).
  * **Truly dead** → include in “delete plan” (no auto-delete).
  * **Tests/fixtures/bin** → likely OK to be orphaned (document and skip).
* Emit `orphans-plan.md` with recommended action per file and confidence.

### 6) Organize + lint

* Run TS “organize imports” via language service on touched files.
* `pnpm -r lint --fix` (ignore non-import rules; we’re not reformatting the world today).

### 7) Rebuild + iterate

* `pnpm -r -w tsc --noEmit` → fix any remaining edges.
* `pnpm -r build` → must pass.

### 8) Reports + PR

* Generate artifacts (below). Open a single PR with concise commits and the reports attached.

---

## Artifacts to produce

* `reports/import_fixes.json` — array of `{ file, old, new, rationale, confidence, candidates[] }`
* `reports/needs_human.json` — unresolved/ambiguous with ranked candidates
* `reports/ts_summary.md` — counts: total errors, fixed, remaining, by code (TS2307, TS6059, …)
* `reports/orphans-plan.md` — proposed actions per orphan
* `git` diff is minimal and readable (imports + barrels only)

---

## Commands (baseline)

```bash
# 0) Sanity
pnpm -r -w tsc --noEmit | tee build-errors.txt

# 1) After fixes (organize + lint included in tool)
pnpm -r -w tsc --noEmit
pnpm -r build

# 2) Optional verification
pnpm -r test -i
```

---

## Acceptance checklist

* [ ] No TS2307/TS6059/etc.
* [ ] All shared imports use `@shared/ts/dist/...` alias where applicable.
* [ ] No import cycles newly introduced.
* [ ] Barrel updates do not change export surfaces.
* [ ] `needs_human.json` is either empty or small and clearly ranked.
* [ ] Orphan deletions are **not** performed; only proposed.

---

## Failure modes to watch for (and how to not faceplant)

* **ESM vs CJS mismatches:** Don’t add `.js` extensions unless the repo already uses them. If present, follow local precedent.
* **Monorepo cross-package paths:** Never import private source via `../../..`; use the package name or the approved alias.
* **Path aliases not reflected in `tsconfig.paths`:** Don’t invent aliases; update imports to relative until humans add the alias.
* **RootDir mismatches (TS6059):** If files fell outside `rootDir`, propose moving them back; don’t change `rootDir` casually.

---

## Commit strategy

* One commit per package (or logical area), message:

  * `fix(imports): resolve moved paths and update barrels (no semantic changes)`
  * Body: counts + reference to `reports/ts_summary.md`.

---

## Stretch (only if time permits)

* Generate a `fix-imports` script (Node + ts-morph) wired to `pnpm run fix-imports`.
* Pre-commit hook to run `tsc --noEmit` on touched packages.

