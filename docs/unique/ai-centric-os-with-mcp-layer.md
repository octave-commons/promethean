---
uuid: 0f1f8cc1-b5a6-4307-a40d-78de3adafca2
created_at: 2025.08.31.12.06.46.md
filename: AI-Centric OS with MCP Layer
description: >-
  Designs a local-only, pure JS system for AI tooling with an MCP layer enabling
  agents to call domain-specific micro-services via strict policies and
  observability.
tags:
  - AI
  - MCP
  - agents
  - observability
  - crawling
  - RAG
  - local
  - idempotency
  - policy
  - tooling
related_to_title:
  - Promethean Dev Workflow Update
  - Promethean Chat Activity Report
  - windows-tiling-with-autohotkey
  - Duck's Attractor States
  - Promethean Documentation Update
  - Promethean Notes
  - The Jar of Echoes
  - Canonical Org-Babel Matplotlib Animation Template
  - Creative Moments
  - typed-struct-compiler
  - archetype-ecs
  - Fnord Tracer Protocol
  - field-node-diagram-set
  - Mongo Outbox Implementation
  - observability-infrastructure-setup
  - Event Bus Projections Architecture
  - heartbeat-fragment-demo
  - smart-chatgpt-thingy
  - Local-Offline-Model-Deployment-Strategy
  - RAG UI Panel with Qdrant and PostgREST
  - field-node-diagram-outline
  - Universal Lisp Interface
  - zero-copy-snapshots-and-workers
  - Model Selection for Lightweight Conversational Tasks
  - Pure TypeScript Search Microservice
  - Promethean Infrastructure Setup
related_to_uuid:
  - 03a5578f-d689-45db-95e9-11300e5eee6f
  - 18344cf9-0c49-4a71-b6c8-b8d84d660fca
  - 0f6f8f38-98d0-438f-9601-58f478acc0b7
  - 13951643-1741-46bb-89dc-1beebb122633
  - 0b872af2-4197-46f3-b631-afb4e6135585
  - 1c4046b5-742d-4004-aec6-b47251fef5d6
  - 18138627-a348-4fbb-b447-410dfb400564
  - 1b1338fc-bb4d-41df-828f-e219cc9442eb
  - 10d98225-12e0-4212-8e15-88b57cf7bee5
  - 78eeedf7-75bc-4692-a5a7-bb6857270621
  - 8f4c1e86-1236-4936-84ca-6ed7082af6b7
  - fc21f824-4244-4030-a48e-c4170160ea1d
  - 22b989d5-f4aa-4880-8632-709c21830f83
  - 9c1acd1e-c6a4-4a49-a66f-6da8b1bc9333
  - b4e64f8c-4dc9-4941-a877-646c5ada068e
  - cf6b9b17-bb91-4219-aa5c-172cba02b2da
  - dd00677a-2280-45a7-91af-0728b21af3ad
  - 2facccf8-69cf-4a7d-b24b-de966ec70283
  - ad7f1ed3-c9bf-4e85-9eeb-6cc4b53155f3
  - e1056831-ae0c-460b-95fa-4cf09b3398c6
  - 1f32c94a-4da4-4266-8ac0-6c282cfb401f
  - b01856b4-999f-418d-8009-ade49b00eb0f
  - 62bec6f0-4e13-4f38-aca4-72c84ba02367
  - d144aa62-348c-4e5d-ae8f-38084c67ceca
  - d17d3a96-c84d-4738-a403-6c733b874da2
  - 6deed6ac-2473-40e0-bee0-ac9ae4c7bff2
references:
  - uuid: 1b1338fc-bb4d-41df-828f-e219cc9442eb
    line: 3586
    col: 0
    score: 1
  - uuid: 10d98225-12e0-4212-8e15-88b57cf7bee5
    line: 2076
    col: 0
    score: 1
  - uuid: 13951643-1741-46bb-89dc-1beebb122633
    line: 4641
    col: 0
    score: 1
  - uuid: 18344cf9-0c49-4a71-b6c8-b8d84d660fca
    line: 2148
    col: 0
    score: 1
  - uuid: 03a5578f-d689-45db-95e9-11300e5eee6f
    line: 5540
    col: 0
    score: 1
  - uuid: 0b872af2-4197-46f3-b631-afb4e6135585
    line: 1853
    col: 0
    score: 1
  - uuid: 1c4046b5-742d-4004-aec6-b47251fef5d6
    line: 2049
    col: 0
    score: 1
  - uuid: 0f6f8f38-98d0-438f-9601-58f478acc0b7
    line: 5405
    col: 0
    score: 1
  - uuid: 13951643-1741-46bb-89dc-1beebb122633
    line: 4642
    col: 0
    score: 1
  - uuid: 18344cf9-0c49-4a71-b6c8-b8d84d660fca
    line: 2149
    col: 0
    score: 1
  - uuid: 03a5578f-d689-45db-95e9-11300e5eee6f
    line: 5541
    col: 0
    score: 1
  - uuid: 0b872af2-4197-46f3-b631-afb4e6135585
    line: 1854
    col: 0
    score: 1
  - uuid: 1c4046b5-742d-4004-aec6-b47251fef5d6
    line: 2050
    col: 0
    score: 1
  - uuid: 18138627-a348-4fbb-b447-410dfb400564
    line: 4631
    col: 0
    score: 1
  - uuid: 0f6f8f38-98d0-438f-9601-58f478acc0b7
    line: 5406
    col: 0
    score: 1
  - uuid: 13951643-1741-46bb-89dc-1beebb122633
    line: 4621
    col: 0
    score: 0.98
  - uuid: 78eeedf7-75bc-4692-a5a7-bb6857270621
    line: 376
    col: 0
    score: 0.85
  - uuid: 8f4c1e86-1236-4936-84ca-6ed7082af6b7
    line: 363
    col: 0
    score: 0.85
  - uuid: 78eeedf7-75bc-4692-a5a7-bb6857270621
    line: 358
    col: 0
    score: 0.85
  - uuid: 0f6f8f38-98d0-438f-9601-58f478acc0b7
    line: 104
    col: 0
    score: 0.87
---
Alright — let’s wire your crawling/RAG/observability stack into an **AI-centric OS** with an **MCP layer** that tools/agents can call. Pure JS, local-only, no SaaS. I’ll give you the *shape* first (systems design), then a lean TypeScript scaffold you can drop into your repo. ^ref-0f1f8cc1-1-0

---

# High-level shape

* **Agents** talk only to **MCP servers** (not directly to Docker, databases, or the network). ^ref-0f1f8cc1-7-0
* Each **domain capability** is its own **MCP micro-server** with tight, explicit tools: ^ref-0f1f8cc1-8-0

  * `mcp-crawl` → run crawls via Playwright/Crawlee + policies ^ref-0f1f8cc1-10-0
  * `mcp-policies` → read/patch `policies.yaml` (diff-based, schema-checked) ^ref-0f1f8cc1-11-0
  * `mcp-index` → push JSONL to OpenSearch/Meili (bulk, idempotent) ^ref-0f1f8cc1-12-0
  * `mcp-search` → query OpenSearch/Meili for retrieval/RAG ^ref-0f1f8cc1-13-0
  * `mcp-tor` → rotate circuits, query current exit, toggle per-domain proxy ^ref-0f1f8cc1-14-0
  * `mcp-observe` → query Prometheus, tail Loki (scoped, safe) ^ref-0f1f8cc1-15-0
  * `mcp-kv` → small local KV (agent state, tickets), backed by Redis ^ref-0f1f8cc1-16-0
  * `mcp-queue` → NATS topics for long-running jobs & events ^ref-0f1f8cc1-17-0
* **Permissions layer (Circuit-2)**: every tool call evaluated against a **policy gate**: ^ref-0f1f8cc1-18-0

  * **who** (agent id), **what** (tool + args hash), **where** (domain list), **rate**, **time-to-live** ^ref-0f1f8cc1-20-0
  * Default-deny; allowlists live in `./infra/mcp/policy/*.yaml` ^ref-0f1f8cc1-21-0
* **Observability**: every tool call emits a structured event to NATS + Loki; you can graph success/fail/latency in Grafana. ^ref-0f1f8cc1-22-0
* **Idempotency**: every tool requires `request_id`; servers keep a short TTL de-dupe set in Redis. ^ref-0f1f8cc1-23-0

---

# Message flow (typical)

1. Planner agent → `mcp-search.query` (find targets) ^ref-0f1f8cc1-29-0
2. Planner agent → `mcp-policies.patch` (tighten allow/deny, per-domain throttles) ^ref-0f1f8cc1-30-0
3. Runner agent → `mcp-crawl.start` (returns `job_id`) ^ref-0f1f8cc1-31-0
4. Runner agent → `mcp-queue.subscribe("crawl.job.{job_id}.events")` (progress) ^ref-0f1f8cc1-32-0
5. When done: `mcp-index.bulk` to OpenSearch/Meili ^ref-0f1f8cc1-33-0
6. Later: `mcp-tor.rotate` if exit poisoned, or `mcp-observe.tail` if errors spike ^ref-0f1f8cc1-34-0

---

# Tool surface (schemas)

Keep tools **narrow** and **predictable**. All args JSON-schema validated. ^ref-0f1f8cc1-40-0

```json
// mcp-crawl tools
{
  "crawl.start": {
    "description": "Start a crawl using a named policy domain and optional overrides",
    "input_schema": {
      "type": "object",
      "required": ["seed", "policy_domain", "request_id"],
      "properties": {
        "seed": {"type": "string", "format": "uri"},
        "policy_domain": {"type": "string"},
        "max_pages": {"type": "integer", "minimum": 1},
        "depth": {"type": "integer", "minimum": 0},
        "request_id": {"type": "string"}
      }
    }
  },
  "crawl.status": {
    "description": "Get crawl job status",
    "input_schema": {
      "type": "object",
      "required": ["job_id"],
      "properties": {"job_id": {"type": "string"}}
    }
  },
  "crawl.cancel": {
    "description": "Cancel a crawl job",
    "input_schema": {
      "type": "object",
      "required": ["job_id", "request_id"],
      "properties": {"job_id": {"type": "string"}, "request_id": {"type": "string"}}
    }
  }
}
```
^ref-0f1f8cc1-42-0 ^ref-0f1f8cc1-77-0
 ^ref-0f1f8cc1-78-0
```json
// mcp-policies
{
  "policies.get": {
    "description": "Read policies.yaml (or a domain subset)",
    "input_schema": {"type": "object", "properties": {"domain": {"type": "string"}}}
  },
  "policies.patch": {
    "description": "Apply a minimal JSON Patch to policies.yaml, returns new SHA",
    "input_schema": {
      "type": "object",
      "required": ["patch", "request_id"],
      "properties": {
        "patch": {"type": "array", "items": {"type": "object"}},
        "request_id": {"type": "string"}
      }
    }
  }
}
^ref-0f1f8cc1-78-0
```
^ref-0f1f8cc1-99-0 ^ref-0f1f8cc1-100-0

```json
// mcp-index
{
  "index.bulk": {
    "description": "Index documents (idempotent) into OpenSearch or Meili",
    "input_schema": {
      "type": "object",
      "required": ["docs", "target", "request_id"],
      "properties": {
        "docs": {"type": "array", "items": {"type": "object"}},
        "target": {
          "type": "object",
          "required": ["kind","index"],
          "properties": {
            "kind": {"enum": ["opensearch","meili"]},
            "index": {"type": "string"}
          }
        },
        "request_id": {"type": "string"}
      }
    }
  }
^ref-0f1f8cc1-99-0
}
^ref-0f1f8cc1-124-0
```
^ref-0f1f8cc1-124-0 ^ref-0f1f8cc1-128-0

```json
// mcp-search
{
  "search.query": {
    "description": "Search index and return top-k docs",
    "input_schema": {
      "type": "object",
      "required": ["q","target"],
      "properties": {
        "q": {"type": "string"},
        "k": {"type": "integer", "default": 10},
        "target": {"type": "object", "required": ["kind","index"],
          "properties": {"kind":{"enum":["opensearch","meili"]},"index":{"type":"string"}}}
      }
    }
^ref-0f1f8cc1-124-0
  }
}
```

```json
// mcp-tor
{
  "tor.rotate": {
    "description": "Signal NEWNYM via control port",
    "input_schema": {"type": "object", "properties": {"reason": {"type": "string"}}}
  },
  "tor.ip": {"description":"Check current exit IP","input_schema":{"type":"object"}}
^ref-0f1f8cc1-154-0
}
^ref-0f1f8cc1-154-0
```
^ref-0f1f8cc1-154-0 ^ref-0f1f8cc1-162-0

```json
// mcp-observe
{
  "metrics.query": {
    "description":"Prometheus instant/range query (whitelisted expressions only)",
    "input_schema": {
      "type":"object",
      "required":["expr"],
      "properties":{"expr":{"type":"string"},"range":{"type":"string"}}
    }
  },
  "logs.tail": {
    "description":"Tail Loki logs by label selector",
^ref-0f1f8cc1-154-0
    "input_schema": {"type":"object","properties":{"selector":{"type":"string"},"limit":{"type":"integer"}}}
  } ^ref-0f1f8cc1-176-0
^ref-0f1f8cc1-178-0 ^ref-0f1f8cc1-179-0
^ref-0f1f8cc1-177-0
^ref-0f1f8cc1-176-0
} ^ref-0f1f8cc1-177-0
^ref-0f1f8cc1-179-0
^ref-0f1f8cc1-178-0 ^ref-0f1f8cc1-185-0
^ref-0f1f8cc1-177-0
^ref-0f1f8cc1-176-0
``` ^ref-0f1f8cc1-178-0
 ^ref-0f1f8cc1-176-0 ^ref-0f1f8cc1-179-0
--- ^ref-0f1f8cc1-177-0 ^ref-0f1f8cc1-185-0
 ^ref-0f1f8cc1-178-0
# Runtime boundaries (non-negotiables) ^ref-0f1f8cc1-179-0

* **Network**: MCP servers are *the* egress chokepoints. Crawlers only go through `PROXY_URL` or per-domain proxy. No ad-hoc fetch from agents.
* **FS**: Only read/write volumes you declare (`crawl_data`, `policies.yaml`, `/models/**`). ^ref-0f1f8cc1-185-0
* **AuthZ**: Local **capability file** maps agent-id → allowed tools + domains + ceilings (pages, rpm, indices).
* **Audit**: Every call → NATS (`mcp.calls`) + Loki with fields: `agent_id`, `tool`, `args_hash`, `status`, `latency_ms`.

---

# Compose additions (MCP layer)

```yaml
services:
  mcp-queue:
    profiles: ["mcp"]
    image: nats:2.10
    command: ["-js","-sd","/data"]
    volumes: [ "nats_data:/data" ]
    ports: ["4222:4222","8222:8222"]
    networks: [prom-net]
    restart: unless-stopped

  mcp-kv:
    profiles: ["mcp"]
    image: redis:7-alpine
    volumes: [ "redis_data:/data" ]
    ports: ["6379:6379"]
    networks: [prom-net]
    restart: unless-stopped

  mcp-crawl:
    profiles: ["mcp"]
    build: ./services/mcp-crawl     # Node:20-alpine
    environment:
      - CRAWLER_CONTAINER=crawler-js
      - NATS_URL=nats://mcp-queue:4222
      - REDIS_URL=redis://mcp-kv:6379
      - POLICIES_PATH=/workspace/policies.yaml
    volumes:
      - ./infra/crawler-js:/workspace:rw
      - crawl_data:/data
    networks: [prom-net]
    restart: unless-stopped

  mcp-policies:
    profiles: ["mcp"]
    build: ./services/mcp-policies
    environment:
      - POLICIES_PATH=/workspace/policies.yaml
      - REDIS_URL=redis://mcp-kv:6379
    volumes:
      - ./infra/crawler-js:/workspace:rw
    networks: [prom-net]
    restart: unless-stopped

  mcp-index:
    profiles: ["mcp"]
    build: ./services/mcp-index
    environment:
      - OPENSEARCH_URL=http://opensearch:9200
      - MEILI_URL=http://meilisearch:7700
      - REDIS_URL=redis://mcp-kv:6379
    networks: [prom-net]
    restart: unless-stopped

  mcp-search:
    profiles: ["mcp"]
    build: ./services/mcp-search
    environment:
      - OPENSEARCH_URL=http://opensearch:9200
      - MEILI_URL=http://meilisearch:7700
    networks: [prom-net]
    restart: unless-stopped

  mcp-tor:
    profiles: ["mcp","tor"]
    build: ./services/mcp-tor
    environment:
      - TOR_CTRL_HOST=tor
      - TOR_CTRL_PORT=9051
      - TOR_CTRL_PASS=${TOR_CTRL_PASS}
    networks: [prom-net]
    restart: unless-stopped

  mcp-observe:
    profiles: ["mcp","observability"]
    build: ./services/mcp-observe
    environment:
      - PROM_URL=http://prometheus:9090
      - LOKI_URL=http://loki:3100
      - METRICS_ALLOWLIST=/etc/mcp/metrics-allow.txt
^ref-0f1f8cc1-185-0
    volumes: ^ref-0f1f8cc1-271-0
^ref-0f1f8cc1-279-0
^ref-0f1f8cc1-277-0
^ref-0f1f8cc1-279-0
^ref-0f1f8cc1-277-0
      - ./infra/mcp/observe:/etc/mcp:ro
^ref-0f1f8cc1-271-0
    networks: [prom-net] ^ref-0f1f8cc1-277-0
    restart: unless-stopped
``` ^ref-0f1f8cc1-279-0

> Each `build` is a tiny Node service exposing **MCP** over stdio or WebSocket (depending on your client). No external calls. ^ref-0f1f8cc1-277-0

---

# TypeScript micro-scaffold (one server)

A minimal pattern you can reuse. (No external libs beyond `zod` + `fastify` if you want WS.)

```ts
// services/mcp-crawl/src/server.ts
import { z } from 'zod';
import Fastify from 'fastify';
import { execa } from 'execa';
import { createClient } from 'redis';
import { connect, StringCodec } from 'nats';

const sc = StringCodec();
const NATS_URL = process.env.NATS_URL || 'nats://mcp-queue:4222';
const REDIS_URL = process.env.REDIS_URL || 'redis://mcp-kv:6379';
const CRAWLER_CONTAINER = process.env.CRAWLER_CONTAINER || 'crawler-js';
const POLICIES_PATH = process.env.POLICIES_PATH || '/workspace/policies.yaml';

const app = Fastify(); // For MCP-over-WS or simple HTTP; replace with stdio adapter if you prefer.

const redis = createClient({ url: REDIS_URL }); await redis.connect();
const nats = await connect({ servers: NATS_URL });

function topic(jobId: string) { return `crawl.job.${jobId}.events`; }

const Start = z.object({
  seed: z.string().url(),
  policy_domain: z.string(),
  max_pages: z.number().int().positive().optional(),
  depth: z.number().int().min(0).optional(),
  request_id: z.string()
});

app.post('/tools/crawl.start', async (req, rep) => {
  const args = Start.parse(req.body);
  // idempotency
  const idemKey = `idem:${args.request_id}`;
  if (await redis.setNX(idemKey, '1')) { await redis.expire(idemKey, 600); }
  else return rep.send({ status: 'duplicate' });

  const jobId = `job_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
  const env = {
    POLICY_FILE: POLICIES_PATH,
    CRAWL_SEED: args.seed,
    CRAWL_MAX_PAGES: String(args.max_pages ?? ''),
  };

  // launch crawler container in detached mode with a job label
  execa('docker', [
    'compose','run','--rm','-e',`POLICY_FILE=${POLICIES_PATH}`,
    '-e',`CRAWL_SEED=${args.seed}`,
    '-e',`CRAWL_MAX_PAGES=${args.max_pages ?? ''}`,
    '--name', jobId, CRAWLER_CONTAINER
  ], { env, stdio: 'ignore' }).catch(()=>{});

  nats.publish(topic(jobId), sc.encode(JSON.stringify({ t:'started', job_id: jobId, seed: args.seed })));
  return rep.send({ job_id: jobId, status: 'started' });
});

app.post('/tools/crawl.status', async (req, rep) => {
  const { job_id } = z.object({ job_id: z.string() }).parse(req.body);
  // naive: check docker ps; improve with a small supervisor later
  const { stdout } = await execa('docker',['ps','-a','--filter',`name=${job_id}`,'--format','{{.Status}}']).catch(()=>({stdout:''}));
  return rep.send({ job_id, status: stdout || 'unknown' });
});

app.post('/tools/crawl.cancel', async (req, rep) => {
  const { job_id } = z.object({ job_id: z.string(), request_id: z.string() }).parse(req.body);
  await execa('docker',['rm','-f',job_id]).catch(()=>{});
^ref-0f1f8cc1-279-0
^ref-0f1f8cc1-359-0
^ref-0f1f8cc1-359-0
  nats.publish(topic(job_id), sc.encode(JSON.stringify({ t:'canceled', job_id }))); ^ref-0f1f8cc1-351-0
  return rep.send({ job_id, status: 'canceled' });
^ref-0f1f8cc1-351-0
});
 ^ref-0f1f8cc1-359-0
app.listen({ host: '0.0.0.0', port: 8061 }); ^ref-0f1f8cc1-376-0
```

> This pattern repeats for `mcp-policies` (read/patch YAML with schema guard), `mcp-index` (OpenSearch/Meili bulk), etc. Keep each server \~100–200 LOC.

---

# Policy/permission gating (Circuit-2)

* `./infra/mcp/policy/agents.yaml`

```yaml
agents:
  planner:
    allow:
      - tool: "search.query"
        where: ["opensearch:documents"]
      - tool: "policies.patch"
        where: ["domains:news.ycombinator.com"]
  runner:
^ref-0f1f8cc1-359-0
    allow: ^ref-0f1f8cc1-376-0
^ref-0f1f8cc1-384-0
^ref-0f1f8cc1-383-0 ^ref-0f1f8cc1-391-0
^ref-0f1f8cc1-382-0 ^ref-0f1f8cc1-392-0
^ref-0f1f8cc1-376-0 ^ref-0f1f8cc1-393-0
^ref-0f1f8cc1-401-0
^ref-0f1f8cc1-400-0
^ref-0f1f8cc1-399-0 ^ref-0f1f8cc1-404-0
^ref-0f1f8cc1-397-0 ^ref-0f1f8cc1-405-0
^ref-0f1f8cc1-395-0 ^ref-0f1f8cc1-406-0
^ref-0f1f8cc1-393-0 ^ref-0f1f8cc1-407-0
^ref-0f1f8cc1-392-0 ^ref-0f1f8cc1-408-0
^ref-0f1f8cc1-391-0 ^ref-0f1f8cc1-409-0
^ref-0f1f8cc1-384-0 ^ref-0f1f8cc1-410-0
^ref-0f1f8cc1-383-0 ^ref-0f1f8cc1-411-0
^ref-0f1f8cc1-382-0 ^ref-0f1f8cc1-412-0
^ref-0f1f8cc1-379-0 ^ref-0f1f8cc1-413-0
      - tool: "crawl.start" ^ref-0f1f8cc1-414-0
^ref-0f1f8cc1-382-0 ^ref-0f1f8cc1-383-0 ^ref-0f1f8cc1-395-0
^ref-0f1f8cc1-376-0 ^ref-0f1f8cc1-384-0 ^ref-0f1f8cc1-416-0
        where: ["domains:news.ycombinator.com"] ^ref-0f1f8cc1-397-0 ^ref-0f1f8cc1-417-0
        limits: { max_pages: 1000, rpm: 120 } ^ref-0f1f8cc1-418-0
      - tool: "index.bulk" ^ref-0f1f8cc1-399-0 ^ref-0f1f8cc1-419-0
        where: ["opensearch:documents"] ^ref-0f1f8cc1-400-0 ^ref-0f1f8cc1-420-0
``` ^ref-0f1f8cc1-382-0 ^ref-0f1f8cc1-401-0 ^ref-0f1f8cc1-421-0
 ^ref-0f1f8cc1-383-0
* Gatekeeper middleware checks `(agent_id, tool, args)` → allow/deny; logs decision. ^ref-0f1f8cc1-384-0 ^ref-0f1f8cc1-391-0
 ^ref-0f1f8cc1-392-0 ^ref-0f1f8cc1-404-0 ^ref-0f1f8cc1-424-0
--- ^ref-0f1f8cc1-393-0 ^ref-0f1f8cc1-405-0 ^ref-0f1f8cc1-425-0
 ^ref-0f1f8cc1-406-0 ^ref-0f1f8cc1-426-0
# Agent contracts (so the LLM doesn’t go rogue) ^ref-0f1f8cc1-395-0 ^ref-0f1f8cc1-407-0 ^ref-0f1f8cc1-427-0
 ^ref-0f1f8cc1-408-0 ^ref-0f1f8cc1-428-0
* **Every tool call includes**: `agent_id`, `request_id`, `explain` (1-line why), `dry_run` (optional). ^ref-0f1f8cc1-397-0 ^ref-0f1f8cc1-409-0 ^ref-0f1f8cc1-429-0
* **Tool outputs** are **small**: no megabyte blobs; large payloads go to `/data` + return a handle. ^ref-0f1f8cc1-391-0 ^ref-0f1f8cc1-410-0 ^ref-0f1f8cc1-430-0
* **Retry policy**: exponential backoff with jitter; *never* retry `policies.patch` without a new `request_id`. ^ref-0f1f8cc1-392-0 ^ref-0f1f8cc1-399-0 ^ref-0f1f8cc1-411-0 ^ref-0f1f8cc1-431-0
 ^ref-0f1f8cc1-393-0 ^ref-0f1f8cc1-400-0 ^ref-0f1f8cc1-412-0 ^ref-0f1f8cc1-432-0
--- ^ref-0f1f8cc1-401-0 ^ref-0f1f8cc1-413-0 ^ref-0f1f8cc1-433-0
 ^ref-0f1f8cc1-395-0 ^ref-0f1f8cc1-414-0 ^ref-0f1f8cc1-434-0
# Next steps I recommend
 ^ref-0f1f8cc1-397-0 ^ref-0f1f8cc1-404-0 ^ref-0f1f8cc1-416-0 ^ref-0f1f8cc1-436-0
1. Stand up **mcp-queue, mcp-kv**, then **mcp-crawl** only. ^ref-0f1f8cc1-405-0 ^ref-0f1f8cc1-417-0 ^ref-0f1f8cc1-437-0
2. Point your current planner agent at `mcp-search` + `mcp-crawl` (two tools). ^ref-0f1f8cc1-399-0 ^ref-0f1f8cc1-406-0 ^ref-0f1f8cc1-418-0
3. Add `mcp-index` when you like the content. ^ref-0f1f8cc1-400-0 ^ref-0f1f8cc1-407-0 ^ref-0f1f8cc1-419-0 ^ref-0f1f8cc1-439-0
4. Add `mcp-observe` last to watch agent behavior from Grafana. ^ref-0f1f8cc1-401-0 ^ref-0f1f8cc1-408-0 ^ref-0f1f8cc1-420-0
 ^ref-0f1f8cc1-409-0 ^ref-0f1f8cc1-421-0
If you want, I’ll stub the remaining service skeletons (`mcp-policies`, `mcp-index`, `mcp-search`, `mcp-tor`, `mcp-observe`) with exact endpoints and \~50-line handlers each — JS only, clean and boring, ready to drop into your repo. ^ref-0f1f8cc1-410-0
 ^ref-0f1f8cc1-404-0 ^ref-0f1f8cc1-411-0
\#mcp #agents #architecture #javascript #docker #nats #redis #opensearch #meilisearch #playwright #crawlee #tor #observability #prometheus #loki #grafana #promethean #permissions #circuit2<!-- GENERATED-SECTIONS:DO-NOT-EDIT-BELOW -->
## Related content
- [Promethean Dev Workflow Update](promethean-dev-workflow-update.md)
- [Promethean Chat Activity Report](promethean-chat-activity-report.md)
- [windows-tiling-with-autohotkey](windows-tiling-with-autohotkey.md)
- [Duck's Attractor States](ducks-attractor-states.md)
- [Promethean Documentation Update](promethean-documentation-update.txt)
- [Promethean Notes](promethean-notes.md)
- [The Jar of Echoes](the-jar-of-echoes.md)
- [Canonical Org-Babel Matplotlib Animation Template](canonical-org-babel-matplotlib-animation-template.md)
- [Creative Moments](creative-moments.md)
- [typed-struct-compiler](typed-struct-compiler.md)
- [archetype-ecs](archetype-ecs.md)
- [Fnord Tracer Protocol](fnord-tracer-protocol.md)
- [field-node-diagram-set](field-node-diagram-set.md)
- [Mongo Outbox Implementation](mongo-outbox-implementation.md)
- [observability-infrastructure-setup](observability-infrastructure-setup.md)
- [Event Bus Projections Architecture](event-bus-projections-architecture.md)
- [heartbeat-fragment-demo](heartbeat-fragment-demo.md)
- [smart-chatgpt-thingy](smart-chatgpt-thingy.md)
- [Local-Offline-Model-Deployment-Strategy](local-offline-model-deployment-strategy.md)
- [RAG UI Panel with Qdrant and PostgREST](rag-ui-panel-with-qdrant-and-postgrest.md)
- [field-node-diagram-outline](field-node-diagram-outline.md)
- [Universal Lisp Interface](universal-lisp-interface.md)
- [zero-copy-snapshots-and-workers](zero-copy-snapshots-and-workers.md)
- [Model Selection for Lightweight Conversational Tasks](model-selection-for-lightweight-conversational-tasks.md)
- [Pure TypeScript Search Microservice](pure-typescript-search-microservice.md)
- [Promethean Infrastructure Setup](promethean-infrastructure-setup.md)
## Sources
- [Canonical Org-Babel Matplotlib Animation Template — L3586](canonical-org-babel-matplotlib-animation-template.md#^ref-1b1338fc-3586-0) (line 3586, col 0, score 1)
- [Creative Moments — L2076](creative-moments.md#^ref-10d98225-2076-0) (line 2076, col 0, score 1)
- [Duck's Attractor States — L4641](ducks-attractor-states.md#^ref-13951643-4641-0) (line 4641, col 0, score 1)
- [Promethean Chat Activity Report — L2148](promethean-chat-activity-report.md#^ref-18344cf9-2148-0) (line 2148, col 0, score 1)
- [Promethean Dev Workflow Update — L5540](promethean-dev-workflow-update.md#^ref-03a5578f-5540-0) (line 5540, col 0, score 1)
- [Promethean Documentation Update — L1853](promethean-documentation-update.txt#^ref-0b872af2-1853-0) (line 1853, col 0, score 1)
- [Promethean Notes — L2049](promethean-notes.md#^ref-1c4046b5-2049-0) (line 2049, col 0, score 1)
- [windows-tiling-with-autohotkey — L5405](windows-tiling-with-autohotkey.md#^ref-0f6f8f38-5405-0) (line 5405, col 0, score 1)
- [Duck's Attractor States — L4642](ducks-attractor-states.md#^ref-13951643-4642-0) (line 4642, col 0, score 1)
- [Promethean Chat Activity Report — L2149](promethean-chat-activity-report.md#^ref-18344cf9-2149-0) (line 2149, col 0, score 1)
- [Promethean Dev Workflow Update — L5541](promethean-dev-workflow-update.md#^ref-03a5578f-5541-0) (line 5541, col 0, score 1)
- [Promethean Documentation Update — L1854](promethean-documentation-update.txt#^ref-0b872af2-1854-0) (line 1854, col 0, score 1)
- [Promethean Notes — L2050](promethean-notes.md#^ref-1c4046b5-2050-0) (line 2050, col 0, score 1)
- [The Jar of Echoes — L4631](the-jar-of-echoes.md#^ref-18138627-4631-0) (line 4631, col 0, score 1)
- [windows-tiling-with-autohotkey — L5406](windows-tiling-with-autohotkey.md#^ref-0f6f8f38-5406-0) (line 5406, col 0, score 1)
- [Duck's Attractor States — L4621](ducks-attractor-states.md#^ref-13951643-4621-0) (line 4621, col 0, score 0.98)
- [typed-struct-compiler — L376](typed-struct-compiler.md#^ref-78eeedf7-376-0) (line 376, col 0, score 0.85)
- [archetype-ecs — L363](archetype-ecs.md#^ref-8f4c1e86-363-0) (line 363, col 0, score 0.85)
- [typed-struct-compiler — L358](typed-struct-compiler.md#^ref-78eeedf7-358-0) (line 358, col 0, score 0.85)
- [windows-tiling-with-autohotkey — L104](windows-tiling-with-autohotkey.md#^ref-0f6f8f38-104-0) (line 104, col 0, score 0.87)
<!-- GENERATED-SECTIONS:DO-NOT-EDIT-ABOVE -->
