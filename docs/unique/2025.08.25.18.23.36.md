# Codex Task — Migrate to Provider-Tenant Architecture (Discord now, others later)

**Goal:** Refactor Promethean’s Discord-bound services into a **provider-agnostic, tenant-scoped** architecture. Discord is the first provider; design must generalize cleanly to Reddit/Bluesky/Twitch without further structural changes.

---

## Scope

### In

* Add `provider` and `tenant` to the **message envelope** and **topics**.
* Introduce **Provider Registry** (`providers.yml`) and shared types.
* Create **access layer** for Discord: `discord-gateway` + `discord-rest` (tokened).
* Convert five “weird” services into **tokenless domain workers**:

  * `discord-message-indexer`
  * `discord-attachment-indexer`
  * `discord-message-embedder`
  * `attachment-embedder`
  * `cephalon-discord` (adapter binding only)
* Add **normalized domain events** (`SocialMessageCreated`) and **commands** (`PostMessage`).
* Partition storage & embeddings **by provider+tenant**.
* Wire **policy** so only access layer has `provider.*` capabilities.
* CI rule to **ban tokens** outside access layer.

### Out (Non-goals)

* Implementing Reddit/Bluesky/Twitch adapters (stubs optional).
* Changing STT/TTS/LLM internals.
* Replacing PM2. (Use existing process manager.)

---

## Deliverables

1. **Shared library additions** under `shared/ts` (compiled to `@shared/ts/dist/...`):

   * `agent-envelope.ts` → add `provider`, `tenant`.
   * `topic.ts` → `topic({provider,tenant,area,name})`.
   * `urn.ts` → `toUrn()/fromUrn()` helpers.
   * `events.ts` → `SocialMessageCreated`, `PostMessage` types.
   * `provider-registry.ts` → loads `providers.yml`.
   * `policy.ts` → `provider.*` caps enforced here.
   * `effects.ts` → tenant-scoped `mongo()`, `chroma()`, `http.fetch()`, `rest.request()`.

2. **New services**

   * `services/ts/discord-gateway/`
   * `services/ts/discord-rest/`

3. **Refactors (tokenless)**

   * `services/ts/discord-message-indexer/`
   * `services/ts/discord-attachment-indexer/`
   * `services/ts/discord-message-embedder/`
   * `services/ts/attachment-embedder/`
   * `services/ts/cephalon-discord/`

4. **Config**

   * `providers.yml` with `discord/duck` tenant.
   * `ecosystem.discord.js` (PM2) to boot per-tenant access layer.

5. **DB & Vector schema**

   * Unique indexes including `{ provider, tenant, foreign_id }`.
   * Chroma namespaces: `<provider>__<tenant>__messages`, `<provider>__<tenant>__attachments`.

6. **Tests**

   * Golden tests for envelopes/topics and normalized events.
   * Mocks for gateway, rest proxy, and policy.
   * CI grep rule to fail build if tokens appear outside access layer.

---

## Acceptance Criteria

* [ ] All pub/sub messages include `provider` and `tenant`.
* [ ] Topics follow: `promethean.p.<provider>.t.<tenant>.<area>.<name>`.
* [ ] Discord tokens exist **only** in `discord-gateway` and `discord-rest`.
* [ ] Workers run with **no Discord SDK** or tokens; interact via bus and shared effects.
* [ ] `SocialMessageCreated` emitted for live Discord messages and consumed by indexers/embedders.
* [ ] Replies flow through `PostMessage` → `discord-rest` (no direct SDK).
* [ ] Storage and Chroma partitioned by provider+tenant, with unique indexes.
* [ ] Policy blocks `provider.*` caps for non-access agents (tested).
* [ ] PM2 can start one or more tenants by changing `providers.yml` + env.
* [ ] CI fails if secrets are found outside access layer.

---

## Implementation Plan (sequenced, atomic commits)

### 1) Shared types & envelope

* Update `shared/ts/agent-envelope.ts`:

  * Add `provider: string`, `tenant: string`.
  * Bump **contract version**.
* Add `shared/ts/topic.ts`: `topic({provider,tenant,area,name})`.
* Add `shared/ts/events.ts`: `SocialMessageCreated`, `PostMessage`.
* Add `shared/ts/urn.ts`: URN helpers.
* Add `shared/ts/provider-registry.ts`: file-backed registry for `providers.yml`.
* Add `shared/ts/policy.ts`: capability types; enforce `provider.*` only for access agents.
* Add `shared/ts/effects.ts`: wrappers for mongo/chroma/http and **bus-based rest.request**.

**Tests:** unit tests for type guards, topic formatting, URN round-trip.

### 2) Providers config

* Create `providers.yml`:

  ```
  providers:
    - provider: discord
      tenant: duck
      credentials:
        bot_token: ${DISCORD_TOKEN_DUCK}
        app_id: "123..."
      allow:
        guilds: ["111111111111111111"]
        channels: ["*"]
      storage:
        mongo_db: "promethean_discord_duck"
        chroma_ns: "discord__duck"
  ```

* Add loader + schema validation (zod).

### 3) Discord access layer

* **discord-rest**:

  * Fastify service consuming `promethean.p.discord.t.<tenant>.rest.request`.
  * Global **bucket map** + `retry_after_ms` handling.
  * Emits `...rest.response` with `ok`, `status`, `bucket`, `retry_after_ms`.
  * Handles `PostMessage` command: map to `POST /channels/{id}/messages`.
* **discord-gateway**:

  * WS gateway with intents; normalize `MESSAGE_CREATE` into `SocialMessageCreated`.
  * Emit raw event topic **and** normalized event.
  * Health pings (seq, ping, shard).

**Tests:** simulate rate-limit, reconnect, normalized payload snapshot.

### 4) Domain workers refactor (tokenless)

* Replace Discord SDK calls with:

  * publish `rest.request` and await `rest.response` (corr id).
* Consume `SocialMessageCreated` instead of raw payloads where possible.
* Indexers upsert on `{ provider, tenant, foreign_id }`.
* Embedders write to `<provider>__<tenant>__*` collections.
* `cephalon-discord` produces `PostMessage` instead of calling SDK.

**Tests:** golden tests: event → DB upsert; text → PostMessage; attachment hashing.

### 5) Storage & embeddings

* Migrations:

  * Add compound unique indexes (`provider`,`tenant`,`foreign_id`).
  * Rename/alias existing collections & chroma namespaces.
* Backfill jobs remain; now publish to `promethean.p.discord.t.<tenant>.jobs.backfill.messages.enqueue`.

**Tests:** verify uniqueness, namespace selection from tenant registry.

### 6) PM2 & env

* `ecosystem.discord.js` to spawn per-tenant access agents using `TENANTS` env or reading `providers.yml`.
* Ensure workers start once, access layer per tenant.

### 7) CI & lint rules

* Add secret-leak guard:

  * Grep for `DISCORD_TOKEN|CLIENT_SECRET|REFRESH_TOKEN` outside `services/ts/discord-*/` and `providers.yml`.
  * Fail build on matches.
* Type-check ensures all publishes include `provider`, `tenant`.

---

## File/Dir Changes (relative to repo root)

* `shared/ts/src/agent-envelope.ts` (update)
* `shared/ts/src/topic.ts` (new)
* `shared/ts/src/events.ts` (new)
* `shared/ts/src/urn.ts` (new)
* `shared/ts/src/provider-registry.ts` (new)
* `shared/ts/src/policy.ts` (new)
* `shared/ts/src/effects.ts` (new)
* `services/ts/discord-rest/` (new)
* `services/ts/discord-gateway/` (new)
* `services/ts/discord-message-indexer/` (refactor)
* `services/ts/discord-attachment-indexer/` (refactor)
* `services/ts/discord-message-embedder/` (refactor)
* `services/ts/attachment-embedder/` (refactor)
* `services/ts/cephalon-discord/` (refactor)
* `config/providers.yml` (new)
* `ecosystem.discord.js` (new)
* DB migrations: scripts under `scripts/migrate/2025-08-provider-tenant/`

---

## Test Plan

* **Unit:** shared helpers, topic, URN, policy checks.
* **Integration (mocked):** gateway emits normalized event → indexer upserts; cephalon publishes `PostMessage` → rest proxy receives correct route/body.
* **E2E (dev env):** run gateway against Discord test guild; verify:

  * live messages appear in `messages` (provider+tenant fields)
  * embeddings land in namespaced collections
  * replying via `PostMessage` posts in channel
* **Performance:** ensure rest proxy honors buckets; no 429 storm under backfill.

---

## Risks & Mitigations

* **Token leak** → CI grep + codeowners review on `providers.yml`.
* **Rate-limit regressions** → Bucket map with circuit breaker; exponential backoff.
* **Schema drift** → Versioned envelope; golden tests for normalized events.
* **Backfill overload** → Queue with max concurrency per tenant; sleep on `retry_after_ms`.

---

## Rollback Plan

* Keep old Discord worker processes & direct SDK code behind a feature flag `DISCORD_LEGACY=true`.
* Migration is reversible by switching topics back and disabling access layer.
* DB migrations add **new indexes and collections**; do **not** drop old until cutover verified.

---

## Milestones (suggested commits)

1. **M1:** Shared types + envelope + topics (+ tests).
2. **M2:** Provider registry + providers.yml + policy gate.
3. **M3:** discord-rest proxy (green tests).
4. **M4:** discord-gateway normalizer (green tests).
5. **M5:** Refactor indexers/embedders → tokenless (unit + integration tests).
6. **M6:** cephalon-discord → PostMessage path (integration test).
7. **M7:** Schema migrations + embeddings namespaces.
8. **M8:** PM2 wiring + E2E on dev guild.
9. **M9:** CI secret guard + docs.

---

## Definition of Done (DoD)

* No service outside `discord-*` has access to Discord tokens nor imports Discord SDK.
* **All** Discord traffic (in/out) flows via the bus topics with `provider` and `tenant`.
* Normalized event & command types are documented and enforced in code.
* One additional tenant can be added by editing `providers.yml` and starting access layer—**no worker code changes**.
* Docs updated: `docs/agents.md`, `docs/providers.md`, `docs/topics.md`.

---

If Codex needs stubs, generate them; keep imports on **@shared/ts/dist/**. Prefer Zod for runtime validation. Keep tests deterministic; record sample Discord payloads as fixtures.

\#hashtags
\#promethean #codex-task #migration #multi-provider #multi-tenant #discord #access-layer #event-driven #policy #observability #typescript #broker #refactor
