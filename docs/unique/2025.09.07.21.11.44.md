In packages/piper/src/fsutils.ts around lines 176 to 186 (and also update at
line 183), the helper runJSModuleWorker currently takes a filesystem path and
converts it to a file URL; change the API to accept modUrl: string instead of
modPath so it matches the runner that passes a fingerprinted file URL, remove
the pathToFileURL conversion and any references to modPath, and use the incoming
modUrl directly when constructing the Worker; update any local calls to pass the
precomputed modUrl rather than a path.

In packages/piper/src/fsutils.ts around lines 235 to 280, update runJSModule so
its API and semantics match the runner: either always invoke the JS step in a
worker using a file:// URL (so console capture, consistent exit codes, and add a
?v=<timestamp|hash> cache-busting query to the module URL) or, if you keep the
in-process fast path, make these changes: validate that the resolved export is a
function and throw/reject if not; ensure timeouts return code 124 (not 1) and
clear timers properly; and append a ?v= cache-busting query to the module path
when converting to a file URL so imports aren’t cached. Ensure env is still
restored and mutex is released in all cases.

In packages/piper/src/fsutils.ts around lines 310-334 (also apply to 330-332),
the timeout killTimer created when opts.timeoutMs is set isn’t cleared if the
spawn fails or emits an "error", which can later attempt to kill a non-existent
child; update the error handler (and any early spawn-failure branches) to
clearTimeout(killTimer) before resolving, and ensure killTimer is declared with
the correct Timeout type so clearTimeout is safe to call.

In packages/piper/src/js-worker.ts around lines 11-13 (and similarly lines
50-53), do not replace process.env wholesale; instead record only the keys you
will change and whether they previously existed, then apply the overrides by
assigning each key individually, and on restore revert each recorded key to its
previous value or delete it if it did not exist. Concretely: before applying
env, build a map of previousValues for every key in env capturing value and
existence, set process.env[key] = env[key] for each key, and when cleaning up
iterate that map to restore previous values or delete keys that were newly added
so you preserve other references and unrelated mutations to process.env.
