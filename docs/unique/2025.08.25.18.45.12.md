Got it — I was naming the **files** under `@shared/ts/dist/...` instead of the **imports**. Let’s fix the plan to match your repo reality:

* **Source lives in** `shared/ts/src/**`
* **`dist/` is build output**, not checked in
* **Consumers must import from** `@shared/ts/dist/...` (your rule)

Here’s the concrete layout + package wiring so this works cleanly.

# Shared package layout (source vs dist)

```
shared/
  ts/
    package.json
    tsconfig.json
    tsconfig.build.json
    src/
      agent-envelope.ts
      topic.ts
      events.ts
      urn.ts
      provider-registry.ts
      policy.ts
      effects.ts
      index.ts       # re-exports everything
    dist/            # build output (gitignored)
```

## `shared/ts/src/index.ts`

Re-export symbols so consumers can import either the barrel or subpaths:

```ts
export * from "./agent-envelope.js";
export * from "./topic.js";
export * from "./events.js";
export * from "./urn.js";
export * from "./provider-registry.js";
export * from "./policy.js";
export * from "./effects.js";
```

## `shared/ts/package.json`

Make **runtime imports** resolve to `dist/` while letting **subpath imports** also work:

```json
{
  "name": "@shared/ts",
  "version": "0.1.0",
  "type": "module",
  "private": true,
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    },
    "./dist/*": "./dist/*"
  },
  "files": ["dist"],
  "scripts": {
    "build": "tsc -p tsconfig.build.json",
    "clean": "rimraf dist",
    "prepublishOnly": "npm run clean && npm run build"
  },
  "dependencies": {
    "zod": "^3.23.8"
  },
  "devDependencies": {
    "typescript": "^5.4.0",
    "rimraf": "^5.0.0"
  }
}
```

> Key bit: the `exports` map includes **`"./dist/*": "./dist/*"`** so consumers can do `@shared/ts/dist/agent-envelope.js` if you insist on the dist-subpath style.

## `shared/ts/tsconfig.build.json`

Strict ESM build into `dist/` with `.js` extensions:

```json
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "outDir": "dist",
    "declaration": true,
    "declarationMap": true,
    "emitDeclarationOnly": false,
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "target": "ES2022",
    "rootDir": "src",
    "resolveJsonModule": true,
    "verbatimModuleSyntax": true,
    "stripInternal": false
  },
  "include": ["src"]
}
```

## `.gitignore` (repo root or `shared/ts/.gitignore`)

```
shared/ts/dist/
```

# How consumers should import (matches your rule)

* **Barrel import (preferred for stability):**

  ```ts
  import { AgentEnvelope, topic, SocialMessageCreated } from "@shared/ts";
  ```

* **Explicit dist subpath (your stated rule):**

  ```ts
  import { AgentEnvelope } from "@shared/ts/dist/agent-envelope.js";
  import { topic } from "@shared/ts/dist/topic.js";
  import { SocialMessageCreated } from "@shared/ts/dist/events.js";
  ```

  This works because of the `exports: { "./dist/*": "./dist/*" }` entry.

> Don’t import from `src/` outside the shared package. Everything outside should see **only** `@shared/ts` or `@shared/ts/dist/...`.

# Minimal new files (in **src/**, not dist)

Create these **under `shared/ts/src/`**:

* `agent-envelope.ts`
* `topic.ts`
* `events.ts`
* `urn.ts`
* `provider-registry.ts`
* `policy.ts`
* `effects.ts`
* `index.ts` (barrel)

Then run:

```bash
pnpm --filter @shared/ts build   # or npm/yarn equivalent
```

All consumers keep (or switch to) imports like `@shared/ts/dist/<module>.js`, while you, as a developer, only touch `shared/ts/src/**`.

# Sanity checks

* [ ] `shared/ts/src/**` contains the real code.
* [ ] `shared/ts/dist/**` is generated, **gitignored**, and contains `.js/.d.ts`.
* [ ] `services/*` import from `@shared/ts/dist/...` (or `@shared/ts`).
* [ ] No consumer ever imports `shared/ts/src/**`.
* [ ] CI builds `@shared/ts` before building the services.

If you want, I’ll spit out the exact `src/*.ts` content for the envelope, topics, events, etc., under this structure—**all placed in `src/`**, imports set to `@shared/ts/dist/...`, zero churn to your VCS rules.

\#hashtags
\#promethean #shared-lib #typescript #esm #package-exports #distlayout #monorepo #build-system
