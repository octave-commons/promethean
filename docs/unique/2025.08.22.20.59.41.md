# Make tests resilient 

Native modules shouldn’t be a test gate. Add an optional import + env flag:

**`src/lib/pty.ts`**

```ts
let ptyMod: null | typeof import('node-pty') = null;
export function getPty() {
  if (process.env.NODE_PTY_DISABLED === '1') return null;
  if (ptyMod) return ptyMod;
  try { ptyMod = require('node-pty'); return ptyMod; }
  catch { return null; }
}
```

Guard usage:

```ts
import { getPty } from './lib/pty';
const pty = getPty();
if (!pty) { const err = new Error('PTY_UNAVAILABLE'); err.name = 'PTY_UNAVAILABLE'; throw err; }
```

Map `PTY_UNAVAILABLE` → 501/503 in your route handler.

In test helper:

```js
process.env.NODE_PTY_DISABLED = '1';
```

---

# Fix the Mongo 500s in tests

Use an in-memory server under `NODE_ENV=test`:

```bash
pnpm -F services/ts/smartgpt-bridge add -D mongodb-memory-server
```

Bootstrap:

```ts
// createMongoFromEnv()
if (process.env.NODE_ENV === 'test' && (!process.env.MONGO_URI || process.env.MONGO_URI === 'memory')) {
  const { MongoMemoryServer } = await import('mongodb-memory-server');
  const mms = await MongoMemoryServer.create();
  const client = new MongoClient(mms.getUri());
  await client.connect();
  return { client, cleanup: async () => { await client.close(); await mms.stop(); } };
}
```

Test helper:

```js
process.env.NODE_ENV = 'test';
process.env.MONGO_URI = 'memory';
```

---

# CI / repo hygiene with Volta

* Keep this at repo root so contributors get the same runtime:

  ```json
  {
    "volta": { "node": "20.19.4", "pnpm": "9.0.0" },
    "engines": { "node": "20.x" }
  }
  ```
* Add a quick health script:

  ```bash
  node -p "process.versions.node + ' ABI ' + process.versions.modules"
  ```

---

# Quick checklist

* [ ] `volta pin node@20.19.4 pnpm@9`
* [ ] `rm -rf node_modules && pnpm store prune`
* [ ] `npm_config_build_from_source=true pnpm i && pnpm rebuild node-pty`
* [ ] `node -e "require('node-pty')"` → should print `pty ok`
* [ ] Add `NODE_PTY_DISABLED=1` test guard + route mapping
* [ ] Use `mongodb-memory-server` in tests

Roger. Here are concrete patches to (1) null-out `node-pty` in tests and (2) give tests a real Mongo via `mongodb-memory-server`—plus (3) a small wrapper you can migrate your PTY imports to. I’m guessing common paths; if a filename differs in your tree, tell me which one and I’ll re-spin the patch.

---

# Add a safe PTY wrapper (lazy import + flag)

Create `services/ts/smartgpt-bridge/src/lib/pty.ts`:

```diff
+++ b/services/ts/smartgpt-bridge/src/lib/pty.ts
@@
+// Lazy/optional node-pty wrapper so tests and unsupported runtimes don't explode.
+// If NODE_PTY_DISABLED=1, this returns null.
+// In prod, returns the real node-pty module (or null if missing).
+let _pty: null | typeof import('node-pty') | undefined;
+
+export function getPty() {
+  if (process.env.NODE_PTY_DISABLED === '1') return null;
+  if (_pty !== undefined) return _pty;
+  try {
+    // eslint-disable-next-line @typescript-eslint/no-var-requires
+    _pty = require('node-pty');
+  } catch {
+    _pty = null;
+  }
+  return _pty;
+}
+
+export type PtyModule = NonNullable<ReturnType<typeof getPty>>;
+
+export class PtyUnavailableError extends Error {
+  constructor() {
+    super('PTY_UNAVAILABLE');
+    this.name = 'PTY_UNAVAILABLE';
+  }
+}
+
+// Convenience spawn that throws a typed error if PTY is unavailable.
+export function spawnPty(file: string, args: string[], opts: Record<string, any> = {}) {
+  const pty = getPty();
+  if (!pty) throw new PtyUnavailableError();
+  return pty.spawn(file, args, opts);
+}
```

> Migration note (do this gradually): wherever you currently do `import pty from 'node-pty'` or `require('node-pty')`, switch to:
>
> ```ts
> import { spawnPty, PtyUnavailableError } from '../lib/pty';
> // …
> try {
>   const term = spawnPty('/bin/bash', ['-lc', 'echo ok'], { cols: 120, rows: 30 });
> } catch (e) {
>   if (e instanceof PtyUnavailableError) {
>     // map to 501/503 (or a soft fallback) instead of crashing
>   } else {
>     throw e;
>   }
> }
> ```

If you show me the exact PTY import sites (route/agent filenames), I’ll hand you precise diffs for those too.

---

# Make tests resilient: disable PTY + run Mongo in-memory

Install the dev dep once (in the bridge package):

```bash
volta pin node@20.19.4 pnpm@9
cd services/ts/smartgpt-bridge
pnpm add -D mongodb-memory-server
```

Patch your **test helper** `services/ts/smartgpt-bridge/tests/helpers/server.js`:

```diff
--- a/services/ts/smartgpt-bridge/tests/helpers/server.js
+++ b/services/ts/smartgpt-bridge/tests/helpers/server.js
@@
-// existing imports...
+import { MongoMemoryServer } from 'mongodb-memory-server';
+
+// Ensure deterministic test environment
+process.env.NODE_ENV = 'test';
+// Avoid native addon crashes in CI/local when ABI mismatches
+process.env.NODE_PTY_DISABLED = process.env.NODE_PTY_DISABLED || '1';
+
+let __mms;   // singleton memory mongo
+let __mongoUri;
+
+export async function ensureMemoryMongo() {
+  if (__mms) return __mongoUri;
+  __mms = await MongoMemoryServer.create();
+  __mongoUri = __mms.getUri();
+  // Make app see a valid URI
+  process.env.MONGO_URI = process.env.MONGO_URI || __mongoUri;
+  return __mongoUri;
+}
+
+export async function shutdownMemoryMongo() {
+  if (!__mms) return;
+  await __mms.stop();
+  __mms = undefined;
+  __mongoUri = undefined;
+}
@@
-// wherever you spin up the server for tests, before doing so:
+// BEFORE starting the app server in tests:
+await ensureMemoryMongo();
@@
-// and in your test suite/global teardown:
+// In global teardown (you already have a "global.teardown" test file):
+await shutdownMemoryMongo();
```

If your helper exports a `withServer(fn)` wrapper, drop `await ensureMemoryMongo()` at the top of that function so every test gets a live URI before booting Fastify.

This alone eliminates the “No mongo URI provided” 500s and the PTY explosions during tests.
`

---

# 5) Re-run tests

```bash
cd services/ts/smartgpt-bridge
pnpm test
```

You should no longer see:

* `Module did not self-register … pty.node`
* `No mongo URI provided`

---

## Why this approach

* You keep **Node 20** (Volta-pinned) as the target runtime.
* Tests become **robust**: they don’t depend on native addons or external Mongo.
* Prod code stays sane: PTY is used when available; otherwise you return 501 instead of detonating the process.

If you paste me the exact files that import `node-pty` (paths/lines), I’ll produce precise diffs to swap them to `spawnPty()` and add the 501 mapping right where it matters.

\#tags
\#promethean #smartgpt-bridge #testing #volta #node-pty #mongodb-memory-server #ABI #fastify
