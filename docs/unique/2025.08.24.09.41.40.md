
### âœ… Recommended Consolidation Plan

centralize around a **single shared Chroma toolkit**:

1.  **Create `shared/ts/chroma/`**

*   Export one `getChromaClient()` singleton with lazy init.

*   Standardize env config (`CHROMA_URL`, `CHROMA_DB_IMPL`, `CHROMA_PERSIST_DIR`).

*   Provide helpers:

        *   `getOrCreateCollection(name, embeddingFn?, metadata?)`

        *   `listCollections()`

        *   `cleanupCollection(name, policy)`


        â†’ All TS services (`discord-embedder`, `cephalon`, `smartgpt-bridge`) import from here.

        2.  **Unify Embedding Functions**

        *   Consolidate `RemoteEmbeddingFunction` + `embedding/versioning` into this toolkit.

        *   Guarantee every collection has consistent naming (`family__version__driver__fn`).

        3.  **Shared Retention Policy**

        *   Move `chromaCleanup` (currently only in SmartGPT Bridge) into shared.

        *   Support TTL (delete older than X days) + capped size (`LOG_MAX_CHROMA`).

        4.  **Cross-language consistency**

        *   Align `scripts/index_project_files.py` with TS API:

        *   Same env vars.

        *   Same collection family naming.

        *   Option: wrap Python indexer behind a service, so you donâ€™t need direct Chroma Python calls in production.

        5.  **Docs & Migration**

        *   Update `docs/notes` and `docs/file-structure.md` to point to the **single Chroma toolkit**.

        *   Mark local `services/ts/chroma/` as deprecated once everything points to `shared/ts/chroma/`.


* * *

âš¡ This gives us:

*   One **source of truth** for Chroma configuration + lifecycle.

*   No more duplicated clients sprinkled across services.

*   Predictable **cleanup & retention** policies.

*   Cleaner service code: `const client = getChromaClient()` everywhere.



Hereâ€™s the **Mongo usage inside `services/ts/`**. Itâ€™s widespread and parallels what we saw for Chroma:

* * *

### ðŸ“¦ **services/ts/discord-embedder/**

*   `src/index.ts`:

    ```ts
    import { MongoClient, ObjectId, Collection } from 'mongodb';
    const MONGO_CONNECTION_STRING = process.env.MONGODB_URI || `mongodb://localhost`;
    const mongoClient = new MongoClient(MONGO_CONNECTION_STRING);
    await mongoClient.connect();
    const db = mongoClient.db('database');
    ```
    *   Stores Discord messages in **Mongo** alongside embeddings in **Chroma**.


* * *

### ðŸ“¦ **services/ts/cephalon/**

*   `src/collectionManager.ts`:

    ```ts
    import { Collection, MongoClient, ObjectId } from 'mongodb';
    const mongoClient = new MongoClient(process.env.MONGODB_URI || 'mongodb://localhost:27017');
    const db = mongoClient.db('database');
    const mongoCollection = db.collection<CollectionEntry>(family);
    ```
    *   Implements a **dual persistence layer**:

    *   `chromaCollection.add(...)`

    *   `mongoCollection.insertOne(...)`


* * *

### ðŸ“¦ **services/ts/kanban-processor/**

*   `src/index.ts`:

    ```ts
    import { MongoClient, Collection } from 'mongodb';
    const mongoClient = new MongoClient(process.env.MONGODB_URI || 'mongodb://localhost:27017');
    mongoClient.connect();
    const mongoCollection = mongoClient.db('database').collection(`${agentName}_kanban`);
    ```
    *   Tracks kanban card state in Mongo.


* * *

### ðŸ“¦ **services/ts/markdown-graph/**

*   `src/index.ts` + `src/graph.ts`:

    ```ts
    import { MongoClient, Collection } from 'mongodb';
    const client = new MongoClient(mongoUrl);
    await client.connect();
    const db = new GraphDB(client, repoPath);
    ```
    *   Backs the **markdown graph database** with Mongo.


* * *

### ðŸ“¦ **services/ts/smartgpt-bridge/**

*   `src/mongo.js`: central connection logic with `mongoose`.

    ```ts
    import mongoose from 'mongoose';
    export async function initMongo() { ... }
    export async function cleanupMongo() { ... }
    ```
    *   Used in:

    *   `fastifyAuth.js`, `rbac.js` (auth/user models in Mongo).

    *   `utils/DualSink.js`:

        ```ts
        this.mongoModel = mongoose.model(name, schema);
        await this.mongoModel.create(entry);
        ```

        Mirrors everything into **Chroma** as well.

        *   `logging/index.js`: `mongoChromaLogger(app)`.

        *   `routes/v0/sinks.js`: query sinks from Mongo.


* * *
