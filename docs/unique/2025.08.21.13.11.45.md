---
project: Promethean
service: codex-context
tags: [agents, codex-context, openai-spec, api-compliance]
---

# Agent Task Plan: Codex Context → OpenAI API Spec

## Objective
Bring `services/ts/codex-context` into full **OpenAI API compliance**, so that standard OpenAI SDKs (Python, Node, etc.) can interact with it transparently.

## Tasks

- [ ] **Add `/v1/models` endpoint**
  - Implement an Express route:
    - `GET /v1/models`
    - Returns available models (from env/config).
    - Schema:
      ```json
      {
        "object": "list",
        "data": [
          {
            "id": "gemma3:latest",
            "object": "model",
            "created": 1724102345,
            "owned_by": "system"
          }
        ]
      }
      ```

- [ ] **Implement streaming for chat + completions**
  - Support `stream=true` parameter.
  - Use **Server-Sent Events (SSE)** to send chunks:
    ```txt
    data: { "id": ..., "choices": [ ... ] }
    ```
  - Terminate with `data: [DONE]`.

- [ ] **Expand request schema**
  - Parse + honor:
    - `temperature`
    - `top_p`
    - `max_tokens`
    - `stop`
  - Forward params into backend (`OllamaBackend` or other drivers).

- [ ] **Standardize error schema**
  - Wrap errors in OpenAI format:
    ```json
    {
      "error": {
        "message": "Invalid request",
        "type": "invalid_request_error",
        "param": null,
        "code": "400"
      }
    }
    ```

- [ ] **Validate chat message roles**
  - Ensure `messages[].role` ∈ {`system`, `user`, `assistant`, `tool`}.
  - Return structured error if invalid.

- [ ] **Improve `choices` output**
  - `finish_reason`: support `"stop"`, `"length"`, `"content_filter"`.
  - Add optional `logprobs` field for completions (even if null).

- [ ] **Add unit tests for compliance**
  - Test `/v1/chat/completions` against OpenAI schema.
  - Test `/v1/models` listing.
  - Test streaming SSE.

## Deliverables
- Updated `index.ts` with new endpoints & streaming.
- Updated `backend.ts` to support extra params.
- Test suite in `tests/services/ts/codex-context/`.
- Compliance verified by running OpenAI Python SDK against Codex Context.

## Dependencies
- `express-sse` or manual `res.write` streaming.
- Schema validation lib (`zod` or `ajv`) for request/response validation.

---
