---
uuid: 3374774e-1350-41d1-9487-14759f74a0fc
created_at: chroma-toolkit-consolidation-plan.md
filename: chroma-toolkit-consolidation-plan
title: chroma-toolkit-consolidation-plan
description: >-
  This document outlines a plan to centralize Chroma database management across
  multiple services by creating a single shared toolkit. It includes
  standardizing environment configurations, embedding functions, retention
  policies, and ensuring cross-language consistency. The consolidation aims to
  eliminate duplicated clients and improve maintainability through a unified
  source of truth.
tags:
  - chroma
  - consolidation
  - shared-toolkit
  - environment-config
  - embedding-functions
  - retention-policy
  - cross-language
  - service-migration
related_to_uuid:
  - 4330e8f0-5f46-4235-918b-39b6b93fa561
  - c03020e1-e3e7-48bf-aa7e-aa740c601b63
  - 54382370-1931-4a19-a634-46735708a9ea
  - 008f2ac0-bfaa-4d52-9826-2d5e86c0059f
  - 30ec3ba6-fbca-4606-ac3e-89b747fbeb7c
  - d8059b6a-c1ec-487d-8e0b-3ce33d6b4d06
  - bd4f0976-0d5b-47f6-a20a-0601d1842dc1
  - 78eeedf7-75bc-4692-a5a7-bb6857270621
  - 62bec6f0-4e13-4f38-aca4-72c84ba02367
  - f5579967-762d-4cfd-851e-4f71b4cb77a1
  - a4a25141-6380-40b9-9cd7-b554b246b303
  - f7702bf8-f7db-473c-9a5b-8dbf66ad3b9e
  - 0f6f8f38-98d0-438f-9601-58f478acc0b7
  - 6bcff92c-4224-453d-9993-1be8d37d47c3
  - 73d3dbf6-9240-46fd-ada9-cc2e7e00dc5f
  - 7b7ca860-780c-44fa-8d3f-be8bd9496fba
  - d144aa62-348c-4e5d-ae8f-38084c67ceca
  - 5e8b2388-022b-46cf-952c-36ae9b8f0037
  - 9c79206d-4cb9-4f00-87e0-782dcea37bc7
  - 71726f04-eb1c-42a5-a5fe-d8209de6e159
  - 938eca9c-97e2-4bcc-8653-b0ef1a5ac7a3
  - 7cfc230d-8ec2-4cdb-b931-8aec26de2a00
  - b09141b7-544f-4c8e-8f49-bf76cecaacbb
  - b22d79c6-825b-4cd3-b0d3-1cef0532bb54
  - 13951643-1741-46bb-89dc-1beebb122633
related_to_title:
  - Stateful Partitions and Rebalancing
  - Per-Domain Policy System for JS Crawler
  - Migrate to Provider-Tenant Architecture
  - eidolon-field-math-foundations
  - Unique Info Dump Index
  - schema-evolution-workflow
  - Prompt_Folder_Bootstrap
  - typed-struct-compiler
  - zero-copy-snapshots-and-workers
  - Performance-Optimized-Polyglot-Bridge
  - Functional Embedding Pipeline Refactor
  - Dynamic Context Model for Web Components
  - windows-tiling-with-autohotkey
  - Post-Linguistic Transhuman Design Frameworks
  - Debugging Broker Connections and Agent Behavior
  - TypeScript Patch for Tool Calling Support
  - Model Selection for Lightweight Conversational Tasks
  - Eidolon Field Abstract Model
  - polyglot-repl-interface-layer
  - Duck's Self-Referential Perceptual Loop
  - eidolon-node-lifecycle
  - field-dynamics-math-blocks
  - field-interaction-equations
  - plan-update-confirmation
  - Duck's Attractor States
references:
  - uuid: 4c951657-755b-4f42-b211-88d7620fd3ae
    line: 1
    col: 0
    score: 1
  - uuid: 7b7ca860-780c-44fa-8d3f-be8bd9496fba
    line: 541
    col: 0
    score: 1
  - uuid: 62bec6f0-4e13-4f38-aca4-72c84ba02367
    line: 375
    col: 0
    score: 1
  - uuid: 71726f04-eb1c-42a5-a5fe-d8209de6e159
    line: 78
    col: 0
    score: 1
  - uuid: a4d90289-798d-44a0-a8e8-a055ae12fb52
    line: 176
    col: 0
    score: 1
  - uuid: 1f32c94a-4da4-4266-8ac0-6c282cfb401f
    line: 154
    col: 0
    score: 1
  - uuid: 22b989d5-f4aa-4880-8632-709c21830f83
    line: 175
    col: 0
    score: 1
  - uuid: e9b27b06-f608-4734-ae6c-f03a8b1fcf5f
    line: 123
    col: 0
    score: 1
  - uuid: fc21f824-4244-4030-a48e-c4170160ea1d
    line: 274
    col: 0
    score: 1
  - uuid: a4a25141-6380-40b9-9cd7-b554b246b303
    line: 327
    col: 0
    score: 1
  - uuid: 6620e2f2-de6d-45d8-a722-5d26e160b370
    line: 412
    col: 0
    score: 1
  - uuid: dd00677a-2280-45a7-91af-0728b21af3ad
    line: 159
    col: 0
    score: 1
  - uuid: 291c7d91-da8c-486c-9bc0-bd2254536e2d
    line: 95
    col: 0
    score: 1
  - uuid: f7702bf8-f7db-473c-9a5b-8dbf66ad3b9e
    line: 396
    col: 0
    score: 1
  - uuid: 10d98225-12e0-4212-8e15-88b57cf7bee5
    line: 43
    col: 0
    score: 1
  - uuid: 73d3dbf6-9240-46fd-ada9-cc2e7e00dc5f
    line: 104
    col: 0
    score: 1
  - uuid: cdbd21ee-25a0-4bfa-884c-c1b948e9b0b2
    line: 44
    col: 0
    score: 1
  - uuid: 2792d448-c3b5-4050-93dd-93768529d99c
    line: 75
    col: 0
    score: 1
  - uuid: e979c50f-69bb-48b0-8417-e1ee1b31c0c0
    line: 48
    col: 0
    score: 1
  - uuid: 13951643-1741-46bb-89dc-1beebb122633
    line: 127
    col: 0
    score: 1
  - uuid: d17d3a96-c84d-4738-a403-6c733b874da2
    line: 594
    col: 0
    score: 1
  - uuid: d8059b6a-c1ec-487d-8e0b-3ce33d6b4d06
    line: 578
    col: 0
    score: 1
  - uuid: 4330e8f0-5f46-4235-918b-39b6b93fa561
    line: 616
    col: 0
    score: 1
  - uuid: 7b7ca860-780c-44fa-8d3f-be8bd9496fba
    line: 571
    col: 0
    score: 1
  - uuid: 62bec6f0-4e13-4f38-aca4-72c84ba02367
    line: 385
    col: 0
    score: 1
  - uuid: 22b989d5-f4aa-4880-8632-709c21830f83
    line: 176
    col: 0
    score: 1
  - uuid: 37b5d236-2b3e-4a95-a4e8-31655c3023ef
    line: 195
    col: 0
    score: 1
  - uuid: 64a9f9f9-58ee-4996-bdaf-9373845c6b29
    line: 198
    col: 0
    score: 1
  - uuid: ca8e1399-77bf-4f77-82a3-3f703b68706d
    line: 65
    col: 0
    score: 1
  - uuid: b22d79c6-825b-4cd3-b0d3-1cef0532bb54
    line: 1028
    col: 0
    score: 1
  - uuid: 9c79206d-4cb9-4f00-87e0-782dcea37bc7
    line: 208
    col: 0
    score: 1
  - uuid: 6bcff92c-4224-453d-9993-1be8d37d47c3
    line: 127
    col: 0
    score: 1
  - uuid: d17d3a96-c84d-4738-a403-6c733b874da2
    line: 590
    col: 0
    score: 1
  - uuid: d8059b6a-c1ec-487d-8e0b-3ce33d6b4d06
    line: 574
    col: 0
    score: 1
  - uuid: 4330e8f0-5f46-4235-918b-39b6b93fa561
    line: 604
    col: 0
    score: 1
  - uuid: 18138627-a348-4fbb-b447-410dfb400564
    line: 131
    col: 0
    score: 1
  - uuid: c3cd4f65-2bb3-4fca-a32e-2ac667e03f40
    line: 107
    col: 0
    score: 1
  - uuid: ba11486b-b0b0-4d9d-a0d1-1d91ae34de55
    line: 38
    col: 0
    score: 1
  - uuid: 78eeedf7-75bc-4692-a5a7-bb6857270621
    line: 407
    col: 0
    score: 1
  - uuid: 7b7ca860-780c-44fa-8d3f-be8bd9496fba
    line: 538
    col: 0
    score: 1
  - uuid: ed6f3fc9-5eb1-482c-8b3c-f0abc5aff2a2
    line: 11
    col: 0
    score: 1
  - uuid: d8059b6a-c1ec-487d-8e0b-3ce33d6b4d06
    line: 566
    col: 0
    score: 1
  - uuid: d17d3a96-c84d-4738-a403-6c733b874da2
    line: 641
    col: 0
    score: 1
  - uuid: 7b7ca860-780c-44fa-8d3f-be8bd9496fba
    line: 656
    col: 0
    score: 1
  - uuid: fc21f824-4244-4030-a48e-c4170160ea1d
    line: 684
    col: 0
    score: 1
  - uuid: 7b7ca860-780c-44fa-8d3f-be8bd9496fba
    line: 547
    col: 0
    score: 1
  - uuid: 0b872af2-4197-46f3-b631-afb4e6135585
    line: 21
    col: 0
    score: 1
  - uuid: 2d6e5553-8dc4-497f-bf45-96f8ca00a6f6
    line: 87
    col: 0
    score: 1
  - uuid: 1c4046b5-742d-4004-aec6-b47251fef5d6
    line: 24
    col: 0
    score: 1
  - uuid: 8b8e6103-30a4-4d66-b5f2-87db1612b587
    line: 128
    col: 0
    score: 1
  - uuid: 95205cd3-c3d5-4047-9c33-9c5ca2b49597
    line: 35
    col: 0
    score: 1
  - uuid: 23df6ddb-05cf-4639-8201-f8291f8a6026
    line: 131
    col: 0
    score: 1
  - uuid: d614d983-7795-491f-9437-09f3a43f72cf
    line: 33
    col: 0
    score: 1
  - uuid: 43bfe9dd-d433-42ca-9777-f4c40eaba791
    line: 268
    col: 0
    score: 1
  - uuid: d144aa62-348c-4e5d-ae8f-38084c67ceca
    line: 209
    col: 0
    score: 1
  - uuid: 1d3d6c3a-039e-4b96-93c1-95854945e248
    line: 137
    col: 0
    score: 1
  - uuid: ca8e1399-77bf-4f77-82a3-3f703b68706d
    line: 138
    col: 0
    score: 1
  - uuid: b39dc9d4-63e2-42d4-bbcd-041ef3167bca
    line: 207
    col: 0
    score: 1
  - uuid: e2135d9f-c69d-47ee-9b17-0b05e98dc748
    line: 59
    col: 0
    score: 1
  - uuid: b22d79c6-825b-4cd3-b0d3-1cef0532bb54
    line: 1100
    col: 0
    score: 1
  - uuid: 9c79206d-4cb9-4f00-87e0-782dcea37bc7
    line: 230
    col: 0
    score: 1
  - uuid: 6bcff92c-4224-453d-9993-1be8d37d47c3
    line: 125
    col: 0
    score: 1
  - uuid: 18344cf9-0c49-4a71-b6c8-b8d84d660fca
    line: 147
    col: 0
    score: 1
  - uuid: f5579967-762d-4cfd-851e-4f71b4cb77a1
    line: 483
    col: 0
    score: 1
  - uuid: e2135d9f-c69d-47ee-9b17-0b05e98dc748
    line: 11
    col: 0
    score: 1
  - uuid: b22d79c6-825b-4cd3-b0d3-1cef0532bb54
    line: 1026
    col: 0
    score: 1
  - uuid: 9c79206d-4cb9-4f00-87e0-782dcea37bc7
    line: 219
    col: 0
    score: 1
  - uuid: 6bcff92c-4224-453d-9993-1be8d37d47c3
    line: 126
    col: 0
    score: 1
  - uuid: 18344cf9-0c49-4a71-b6c8-b8d84d660fca
    line: 33
    col: 0
    score: 1
  - uuid: ae24a280-678e-4c0b-8cc4-56667fa04172
    line: 100
    col: 0
    score: 1
  - uuid: 9fab9e76-e283-4c9d-a8cd-cb76892ea7ac
    line: 15
    col: 0
    score: 1
  - uuid: 03a5578f-d689-45db-95e9-11300e5eee6f
    line: 107
    col: 0
    score: 1
  - uuid: 9413237f-2537-4bbf-8768-db6180970e36
    line: 9
    col: 0
    score: 1
  - uuid: 1c4046b5-742d-4004-aec6-b47251fef5d6
    line: 96
    col: 0
    score: 1
  - uuid: 8b8e6103-30a4-4d66-b5f2-87db1612b587
    line: 215
    col: 0
    score: 1
  - uuid: 23df6ddb-05cf-4639-8201-f8291f8a6026
    line: 199
    col: 0
    score: 1
  - uuid: bd4f0976-0d5b-47f6-a20a-0601d1842dc1
    line: 280
    col: 0
    score: 1
  - uuid: 43bfe9dd-d433-42ca-9777-f4c40eaba791
    line: 291
    col: 0
    score: 1
  - uuid: 59b5670f-36d3-4d34-8985-f3144b15347a
    line: 208
    col: 0
    score: 1
  - uuid: 8430617b-80a2-4cc9-8288-9a74cb57990b
    line: 192
    col: 0
    score: 1
  - uuid: d8059b6a-c1ec-487d-8e0b-3ce33d6b4d06
    line: 620
    col: 0
    score: 1
  - uuid: c5c9a5c6-427d-4864-8084-c083cd55faa0
    line: 244
    col: 0
    score: 1
  - uuid: 73d3dbf6-9240-46fd-ada9-cc2e7e00dc5f
    line: 87
    col: 0
    score: 1
  - uuid: 71726f04-eb1c-42a5-a5fe-d8209de6e159
    line: 82
    col: 0
    score: 1
  - uuid: f7702bf8-f7db-473c-9a5b-8dbf66ad3b9e
    line: 467
    col: 0
    score: 1
  - uuid: 7cfc230d-8ec2-4cdb-b931-8aec26de2a00
    line: 205
    col: 0
    score: 1
  - uuid: 4330e8f0-5f46-4235-918b-39b6b93fa561
    line: 669
    col: 0
    score: 1
  - uuid: 7b7ca860-780c-44fa-8d3f-be8bd9496fba
    line: 628
    col: 0
    score: 1
  - uuid: 930054b3-ba95-4acf-bb92-0e3ead25ed0b
    line: 18
    col: 0
    score: 1
  - uuid: 18138627-a348-4fbb-b447-410dfb400564
    line: 139
    col: 0
    score: 1
  - uuid: c3cd4f65-2bb3-4fca-a32e-2ac667e03f40
    line: 104
    col: 0
    score: 1
  - uuid: ba11486b-b0b0-4d9d-a0d1-1d91ae34de55
    line: 45
    col: 0
    score: 1
  - uuid: 78eeedf7-75bc-4692-a5a7-bb6857270621
    line: 411
    col: 0
    score: 1
  - uuid: 7b7ca860-780c-44fa-8d3f-be8bd9496fba
    line: 566
    col: 0
    score: 1
  - uuid: ed6f3fc9-5eb1-482c-8b3c-f0abc5aff2a2
    line: 10
    col: 0
    score: 1
  - uuid: 30ec3ba6-fbca-4606-ac3e-89b747fbeb7c
    line: 144
    col: 0
    score: 1
  - uuid: 10d98225-12e0-4212-8e15-88b57cf7bee5
    line: 121
    col: 0
    score: 1
  - uuid: 1c4046b5-742d-4004-aec6-b47251fef5d6
    line: 120
    col: 0
    score: 1
  - uuid: 8b8e6103-30a4-4d66-b5f2-87db1612b587
    line: 121
    col: 0
    score: 1
  - uuid: e90b5a16-d58f-424d-bd36-70e9bd2861ad
    line: 575
    col: 0
    score: 1
---

### âœ… Recommended Consolidation Plan

centralize around a **single shared Chroma toolkit**: ^ref-5020e892-4-0

1.  **Create `shared/ts/chroma/`** ^ref-5020e892-6-0

*   Export one `getChromaClient()` singleton with lazy init.

*   Standardize env config (`CHROMA_URL`, `CHROMA_DB_IMPL`, `CHROMA_PERSIST_DIR`). ^ref-5020e892-10-0

*   Provide helpers: ^ref-5020e892-12-0

        *   `getOrCreateCollection(name, embeddingFn?, metadata?)` ^ref-5020e892-14-0 ^ref-e2955491-14-0

        *   `listCollections()`

        *   `cleanupCollection(name, policy)`


        â†’ All TS services (`discord-embedder`, `cephalon`, `smartgpt-bridge`) import from here.

        2.  **Unify Embedding Functions**

        *   Consolidate `RemoteEmbeddingFunction` + `embedding/versioning` into this toolkit.

        *   Guarantee every collection has consistent naming (`family__version__driver__fn`).

        3.  **Shared Retention Policy**

        *   Move `chromaCleanup` (currently only in SmartGPT Bridge) into shared.

        *   Support TTL (delete older than X days) + capped size (`LOG_MAX_CHROMA`).

        4.  **Cross-language consistency**

        *   Align `scripts/index_project_files.py` with TS API:

        *   Same env vars.

        *   Same collection family naming.

        *   Option: wrap Python indexer behind a service, so you donâ€™t need direct Chroma Python calls in production.

        5.  **Docs & Migration**

        *   Update `docs/notes` and `docs/file-structure.md` to point to the **single Chroma toolkit**.

        *   Mark local `services/ts/chroma/` as deprecated once everything points to `shared/ts/chroma/`.


* * *

âš¡ This gives us: ^ref-5020e892-54-0

*   One **source of truth** for Chroma configuration + lifecycle. ^ref-5020e892-56-0

*   No more duplicated clients sprinkled across services. ^ref-5020e892-58-0

*   Predictable **cleanup & retention** policies. ^ref-5020e892-60-0

*   Cleaner service code: `const client = getChromaClient()` everywhere. ^ref-5020e892-62-0



Hereâ€™s the **Mongo usage inside `services/ts/`**. Itâ€™s widespread and parallels what we saw for Chroma: ^ref-5020e892-66-0

* * *

### ðŸ“¦ **services/ts/discord-embedder/**

*   `src/index.ts`: ^ref-5020e892-72-0 ^ref-e2955491-72-0

    ```ts
    import { MongoClient, ObjectId, Collection } from 'mongodb';
    const MONGO_CONNECTION_STRING = process.env.MONGODB_URI || `mongodb://localhost`;
    const mongoClient = new MongoClient(MONGO_CONNECTION_STRING);
    await mongoClient.connect();
    const db = mongoClient.db('database');
    ```
^ref-5020e892-74-0 ^ref-5020e892-81-0 ^ref-e2955491-81-0
    *   Stores Discord messages in **Mongo** alongside embeddings in **Chroma**.


* * *

### ðŸ“¦ **services/ts/cephalon/**
 ^ref-5020e892-88-0 ^ref-e2955491-88-0
*   `src/collectionManager.ts`: ^ref-5020e892-89-0 ^ref-e2955491-89-0
 ^ref-5020e892-90-0
    ```ts
    import { Collection, MongoClient, ObjectId } from 'mongodb';
    const mongoClient = new MongoClient(process.env.MONGODB_URI || 'mongodb://localhost:27017');
    const db = mongoClient.db('database');
    const mongoCollection = db.collection<CollectionEntry>(family);
^ref-5020e892-90-0 ^ref-5020e892-96-0
    ```
    *   Implements a **dual persistence layer**:

    *   `chromaCollection.add(...)`

    *   `mongoCollection.insertOne(...)`


* * *

### ðŸ“¦ **services/ts/kanban-processor/** ^ref-5020e892-107-0

*   `src/index.ts`: ^ref-5020e892-109-0 ^ref-e2955491-109-0

    ```ts
    import { MongoClient, Collection } from 'mongodb';
    const mongoClient = new MongoClient(process.env.MONGODB_URI || 'mongodb://localhost:27017');
    mongoClient.connect();
^ref-5020e892-109-0 ^ref-5020e892-115-0
    const mongoCollection = mongoClient.db('database').collection(`${agentName}_kanban`);
    ```
    *   Tracks kanban card state in Mongo.


* * *
 ^ref-5020e892-122-0 ^ref-e2955491-122-0
### ðŸ“¦ **services/ts/markdown-graph/**
 ^ref-5020e892-124-0 ^ref-e2955491-124-0
*   `src/index.ts` + `src/graph.ts`:

    ```ts
    import { MongoClient, Collection } from 'mongodb';
    const client = new MongoClient(mongoUrl);
^ref-5020e892-124-0 ^ref-5020e892-130-0
    await client.connect();
    const db = new GraphDB(client, repoPath);
    ```
    *   Backs the **markdown graph database** with Mongo.


* * * ^ref-5020e892-137-0 ^ref-e2955491-137-0

### ðŸ“¦ **services/ts/smartgpt-bridge/** ^ref-5020e892-139-0

*   `src/mongo.js`: central connection logic with `mongoose`.

    ```ts
^ref-5020e892-139-0 ^ref-5020e892-144-0
    import mongoose from 'mongoose';
    export async function initMongo() { ... } ^ref-5020e892-146-0
    export async function cleanupMongo() { ... }
    ``` ^ref-5020e892-148-0
    *   Used in:

    *   `fastifyAuth.js`, `rbac.js` (auth/user models in Mongo).

    *   `utils/DualSink.js`:

        ```ts ^ref-5020e892-155-0
        this.mongoModel = mongoose.model(name, schema);
        await this.mongoModel.create(entry); ^ref-5020e892-157-0
        ```
 ^ref-5020e892-159-0
        Mirrors everything into **Chroma** as well.

        *   `logging/index.js`: `mongoChromaLogger(app)`. ^ref-5020e892-162-0 ^ref-e2955491-162-0

        *   `routes/v0/sinks.js`: query sinks from Mongo. ^ref-5020e892-164-0
 ^ref-5020e892-165-0 ^ref-e2955491-165-0
 ^ref-5020e892-166-0
* * *
d1-aca9-51b74f2b33d2
    line: 197
    col: 0
    score: 1
  - uuid: 43bfe9dd-d433-42ca-9777-f4c40eaba791
    line: 270
    col: 0
    score: 1
  - uuid: d8059b6a-c1ec-487d-8e0b-3ce33d6b4d06
    line: 566
    col: 0
    score: 1
  - uuid: d17d3a96-c84d-4738-a403-6c733b874da2
    line: 641
    col: 0
    score: 1
  - uuid: 7b7ca860-780c-44fa-8d3f-be8bd9496fba
    line: 656
    col: 0
    score: 1
  - uuid: fc21f824-4244-4030-a48e-c4170160ea1d
    line: 684
    col: 0
    score: 1
  - uuid: 18344cf9-0c49-4a71-b6c8-b8d84d660fca
    line: 151
    col: 0
    score: 1
  - uuid: 8b8e6103-30a4-4d66-b5f2-87db1612b587
    line: 105
    col: 0
    score: 1
  - uuid: 23df6ddb-05cf-4639-8201-f8291f8a6026
    line: 150
    col: 0
    score: 1
---

### âœ… Recommended Consolidation Plan

centralize around a **single shared Chroma toolkit**: ^ref-5020e892-4-0

1.  **Create `shared/ts/chroma/`** ^ref-5020e892-6-0

*   Export one `getChromaClient()` singleton with lazy init.

*   Standardize env config (`CHROMA_URL`, `CHROMA_DB_IMPL`, `CHROMA_PERSIST_DIR`). ^ref-5020e892-10-0

*   Provide helpers: ^ref-5020e892-12-0

        *   `getOrCreateCollection(name, embeddingFn?, metadata?)` ^ref-5020e892-14-0

        *   `listCollections()`

        *   `cleanupCollection(name, policy)`


        â†’ All TS services (`discord-embedder`, `cephalon`, `smartgpt-bridge`) import from here.

        2.  **Unify Embedding Functions**

        *   Consolidate `RemoteEmbeddingFunction` + `embedding/versioning` into this toolkit.

        *   Guarantee every collection has consistent naming (`family__version__driver__fn`).
 ^ref-5020e892-232-0
        3.  **Shared Retention Policy**

        *   Move `chromaCleanup` (currently only in SmartGPT Bridge) into shared.

        *   Support TTL (delete older than X days) + capped size (`LOG_MAX_CHROMA`).

        4.  **Cross-language consistency**

        *   Align `scripts/index_project_files.py` with TS API:

        *   Same env vars.

        *   Same collection family naming.

        *   Option: wrap Python indexer behind a service, so you donâ€™t need direct Chroma Python calls in production.

        5.  **Docs & Migration**

        *   Update `docs/notes` and `docs/file-structure.md` to point to the **single Chroma toolkit**.

        *   Mark local `services/ts/chroma/` as deprecated once everything points to `shared/ts/chroma/`.


* * *

âš¡ This gives us: ^ref-5020e892-54-0

*   One **source of truth** for Chroma configuration + lifecycle. ^ref-5020e892-56-0

*   No more duplicated clients sprinkled across services. ^ref-5020e892-58-0

*   Predictable **cleanup & retention** policies. ^ref-5020e892-60-0

*   Cleaner service code: `const client = getChromaClient()` everywhere. ^ref-5020e892-62-0



Hereâ€™s the **Mongo usage inside `services/ts/`**. Itâ€™s widespread and parallels what we saw for Chroma: ^ref-5020e892-66-0

* * *

### ðŸ“¦ **services/ts/discord-embedder/**

*   `src/index.ts`: ^ref-5020e892-72-0

    ```ts
    import { MongoClient, ObjectId, Collection } from 'mongodb';
    const MONGO_CONNECTION_STRING = process.env.MONGODB_URI || `mongodb://localhost`;
    const mongoClient = new MongoClient(MONGO_CONNECTION_STRING);
    await mongoClient.connect();
    const db = mongoClient.db('database');
    ```
^ref-5020e892-280-0
^ref-5020e892-74-0 ^ref-5020e892-81-0
    *   Stores Discord messages in **Mongo** alongside embeddings in **Chroma**.


* * *

### ðŸ“¦ **services/ts/cephalon/**
 ^ref-5020e892-88-0
*   `src/collectionManager.ts`: ^ref-5020e892-89-0
 ^ref-5020e892-90-0
    ```ts
    import { Collection, MongoClient, ObjectId } from 'mongodb';
    const mongoClient = new MongoClient(process.env.MONGODB_URI || 'mongodb://localhost:27017');
    const db = mongoClient.db('database');
    const mongoCollection = db.collection<CollectionEntry>(family);
^ref-5020e892-90-0 ^ref-5020e892-96-0
^ref-5020e892-295-0
    ```
    *   Implements a **dual persistence layer**:

    *   `chromaCollection.add(...)`

    *   `mongoCollection.insertOne(...)`


* * *

### ðŸ“¦ **services/ts/kanban-processor/** ^ref-5020e892-107-0

*   `src/index.ts`: ^ref-5020e892-109-0

    ```ts
    import { MongoClient, Collection } from 'mongodb';
    const mongoClient = new MongoClient(process.env.MONGODB_URI || 'mongodb://localhost:27017');
    mongoClient.connect();
^ref-5020e892-109-0 ^ref-5020e892-115-0
    const mongoCollection = mongoClient.db('database').collection(`${agentName}_kanban`);
    ```
    *   Tracks kanban card state in Mongo.


* * *
 ^ref-5020e892-122-0
### ðŸ“¦ **services/ts/markdown-graph/**
 ^ref-5020e892-124-0
*   `src/index.ts` + `src/graph.ts`:

    ```ts
    import { MongoClient, Collection } from 'mongodb';
    const client = new MongoClient(mongoUrl);
^ref-5020e892-124-0 ^ref-5020e892-130-0
    await client.connect();
    const db = new GraphDB(client, repoPath);
    ```
    *   Backs the **markdown graph database** with Mongo.


* * * ^ref-5020e892-137-0

### ðŸ“¦ **services/ts/smartgpt-bridge/** ^ref-5020e892-139-0

*   `src/mongo.js`: central connection logic with `mongoose`.

    ```ts
^ref-5020e892-139-0 ^ref-5020e892-144-0
    import mongoose from 'mongoose';
    export async function initMongo() { ... } ^ref-5020e892-146-0
    export async function cleanupMongo() { ... }
    ``` ^ref-5020e892-148-0
    *   Used in:

    *   `fastifyAuth.js`, `rbac.js` (auth/user models in Mongo).

    *   `utils/DualSink.js`:

        ```ts ^ref-5020e892-155-0
        this.mongoModel = mongoose.model(name, schema);
        await this.mongoModel.create(entry); ^ref-5020e892-157-0
        ```
 ^ref-5020e892-159-0
        Mirrors everything into **Chroma** as well.

        *   `logging/index.js`: `mongoChromaLogger(app)`. ^ref-5020e892-162-0

        *   `routes/v0/sinks.js`: query sinks from Mongo. ^ref-5020e892-164-0
 ^ref-5020e892-165-0
 ^ref-5020e892-166-0
* * *
 ^ref-5020e892-465-0 ^ref-5020e892-466-0 ^ref-5020e892-597-0 ^ref-5020e892-660-0 ^ref-5020e892-762-0 ^ref-5020e892-779-0 ^ref-5020e892-999-0 ^ref-5020e892-1749-0 ^ref-5020e892-3800-0 ^ref-5020e892-3980-0 ^ref-5020e892-4929-0 ^ref-5020e892-5565-0 ^ref-5020e892-5599-0 ^ref-5020e892-6581-0 ^ref-5020e892-6620-0 ^ref-5020e892-6745-0 ^ref-5020e892-6763-0
<!-- GENERATED-SECTIONS:DO-NOT-EDIT-BELOW -->
## Related content
- [Stateful Partitions and Rebalancing](stateful-partitions-and-rebalancing.md)
- [Per-Domain Policy System for JS Crawler](per-domain-policy-system-for-js-crawler.md)
- [Migrate to Provider-Tenant Architecture](migrate-to-provider-tenant-architecture.md)
- [eidolon-field-math-foundations](eidolon-field-math-foundations.md)
- [Unique Info Dump Index](unique-info-dump-index.md)
- [schema-evolution-workflow](schema-evolution-workflow.md)
- [Prompt_Folder_Bootstrap](prompt-folder-bootstrap.md)
- [typed-struct-compiler](typed-struct-compiler.md)
- [zero-copy-snapshots-and-workers](zero-copy-snapshots-and-workers.md)
- [Performance-Optimized-Polyglot-Bridge](performance-optimized-polyglot-bridge.md)
- [Functional Embedding Pipeline Refactor](functional-embedding-pipeline-refactor.md)
- [Dynamic Context Model for Web Components](dynamic-context-model-for-web-components.md)
- [windows-tiling-with-autohotkey](windows-tiling-with-autohotkey.md)
- [Post-Linguistic Transhuman Design Frameworks](post-linguistic-transhuman-design-frameworks.md)
- [Debugging Broker Connections and Agent Behavior](debugging-broker-connections-and-agent-behavior.md)
- [TypeScript Patch for Tool Calling Support](typescript-patch-for-tool-calling-support.md)
- [Model Selection for Lightweight Conversational Tasks](model-selection-for-lightweight-conversational-tasks.md)
- [Eidolon Field Abstract Model](eidolon-field-abstract-model.md)
- [polyglot-repl-interface-layer](polyglot-repl-interface-layer.md)
- [Duck's Self-Referential Perceptual Loop](ducks-self-referential-perceptual-loop.md)
- [eidolon-node-lifecycle](eidolon-node-lifecycle.md)
- [field-dynamics-math-blocks](field-dynamics-math-blocks.md)
- [field-interaction-equations](field-interaction-equations.md)
- [plan-update-confirmation](plan-update-confirmation.md)
- [Duck's Attractor States](ducks-attractor-states.md)
## Sources
- [Python Services CI â€” L1](python-services-ci.md#^ref-4c951657-1-0) (line 1, col 0, score 1)
- [TypeScript Patch for Tool Calling Support â€” L541](typescript-patch-for-tool-calling-support.md#^ref-7b7ca860-541-0) (line 541, col 0, score 1)
- [zero-copy-snapshots-and-workers â€” L375](zero-copy-snapshots-and-workers.md#^ref-62bec6f0-375-0) (line 375, col 0, score 1)
- [Duck's Self-Referential Perceptual Loop â€” L78](ducks-self-referential-perceptual-loop.md#^ref-71726f04-78-0) (line 78, col 0, score 1)
- [Factorio AI with External Agents â€” L176](factorio-ai-with-external-agents.md#^ref-a4d90289-176-0) (line 176, col 0, score 1)
- [field-node-diagram-outline â€” L154](field-node-diagram-outline.md#^ref-1f32c94a-154-0) (line 154, col 0, score 1)
- [field-node-diagram-set â€” L175](field-node-diagram-set.md#^ref-22b989d5-175-0) (line 175, col 0, score 1)
- [field-node-diagram-visualizations â€” L123](field-node-diagram-visualizations.md#^ref-e9b27b06-123-0) (line 123, col 0, score 1)
- [Fnord Tracer Protocol â€” L274](fnord-tracer-protocol.md#^ref-fc21f824-274-0) (line 274, col 0, score 1)
- [Functional Embedding Pipeline Refactor â€” L327](functional-embedding-pipeline-refactor.md#^ref-a4a25141-327-0) (line 327, col 0, score 1)
- [graph-ds â€” L412](graph-ds.md#^ref-6620e2f2-412-0) (line 412, col 0, score 1)
- [heartbeat-fragment-demo â€” L159](heartbeat-fragment-demo.md#^ref-dd00677a-159-0) (line 159, col 0, score 1)
- [Ice Box Reorganization â€” L95](ice-box-reorganization.md#^ref-291c7d91-95-0) (line 95, col 0, score 1)
- [Dynamic Context Model for Web Components â€” L396](dynamic-context-model-for-web-components.md#^ref-f7702bf8-396-0) (line 396, col 0, score 1)
- [Creative Moments â€” L43](creative-moments.md#^ref-10d98225-43-0) (line 43, col 0, score 1)
- [Debugging Broker Connections and Agent Behavior â€” L104](debugging-broker-connections-and-agent-behavior.md#^ref-73d3dbf6-104-0) (line 104, col 0, score 1)
- [Docops Feature Updates â€” L44](docops-feature-updates-3.md#^ref-cdbd21ee-44-0) (line 44, col 0, score 1)
- [Docops Feature Updates â€” L75](docops-feature-updates.md#^ref-2792d448-75-0) (line 75, col 0, score 1)
- [DuckDuckGoSearchPipeline â€” L48](duckduckgosearchpipeline.md#^ref-e979c50f-48-0) (line 48, col 0, score 1)
- [Duck's Attractor States â€” L127](ducks-attractor-states.md#^ref-13951643-127-0) (line 127, col 0, score 1)
- [Pure TypeScript Search Microservice â€” L594](pure-typescript-search-microservice.md#^ref-d17d3a96-594-0) (line 594, col 0, score 1)
- [schema-evolution-workflow â€” L578](schema-evolution-workflow.md#^ref-d8059b6a-578-0) (line 578, col 0, score 1)
- [Stateful Partitions and Rebalancing â€” L616](stateful-partitions-and-rebalancing.md#^ref-4330e8f0-616-0) (line 616, col 0, score 1)
- [TypeScript Patch for Tool Calling Support â€” L571](typescript-patch-for-tool-calling-support.md#^ref-7b7ca860-571-0) (line 571, col 0, score 1)
- [zero-copy-snapshots-and-workers â€” L385](zero-copy-snapshots-and-workers.md#^ref-62bec6f0-385-0) (line 385, col 0, score 1)
- [field-node-diagram-set â€” L176](field-node-diagram-set.md#^ref-22b989d5-176-0) (line 176, col 0, score 1)
- [homeostasis-decay-formulas â€” L195](homeostasis-decay-formulas.md#^ref-37b5d236-195-0) (line 195, col 0, score 1)
- [Layer1SurvivabilityEnvelope â€” L198](layer1survivabilityenvelope.md#^ref-64a9f9f9-198-0) (line 198, col 0, score 1)
- [Obsidian ChatGPT Plugin Integration â€” L65](obsidian-chatgpt-plugin-integration.md#^ref-ca8e1399-65-0) (line 65, col 0, score 1)
- [plan-update-confirmation â€” L1028](plan-update-confirmation.md#^ref-b22d79c6-1028-0) (line 1028, col 0, score 1)
- [polyglot-repl-interface-layer â€” L208](polyglot-repl-interface-layer.md#^ref-9c79206d-208-0) (line 208, col 0, score 1)
- [Post-Linguistic Transhuman Design Frameworks â€” L127](post-linguistic-transhuman-design-frameworks.md#^ref-6bcff92c-127-0) (line 127, col 0, score 1)
- [Pure TypeScript Search Microservice â€” L590](pure-typescript-search-microservice.md#^ref-d17d3a96-590-0) (line 590, col 0, score 1)
- [schema-evolution-workflow â€” L574](schema-evolution-workflow.md#^ref-d8059b6a-574-0) (line 574, col 0, score 1)
- [Stateful Partitions and Rebalancing â€” L604](stateful-partitions-and-rebalancing.md#^ref-4330e8f0-604-0) (line 604, col 0, score 1)
- [The Jar of Echoes â€” L131](the-jar-of-echoes.md#^ref-18138627-131-0) (line 131, col 0, score 1)
- [Tracing the Signal â€” L107](tracing-the-signal.md#^ref-c3cd4f65-107-0) (line 107, col 0, score 1)
- [ts-to-lisp-transpiler â€” L38](ts-to-lisp-transpiler.md#^ref-ba11486b-38-0) (line 38, col 0, score 1)
- [typed-struct-compiler â€” L407](typed-struct-compiler.md#^ref-78eeedf7-407-0) (line 407, col 0, score 1)
- [TypeScript Patch for Tool Calling Support â€” L538](typescript-patch-for-tool-calling-support.md#^ref-7b7ca860-538-0) (line 538, col 0, score 1)
- [Unique Concepts â€” L11](unique-concepts.md#^ref-ed6f3fc9-11-0) (line 11, col 0, score 1)
- [schema-evolution-workflow â€” L566](schema-evolution-workflow.md#^ref-d8059b6a-566-0) (line 566, col 0, score 1)
- [Pure TypeScript Search Microservice â€” L641](pure-typescript-search-microservice.md#^ref-d17d3a96-641-0) (line 641, col 0, score 1)
- [TypeScript Patch for Tool Calling Support â€” L656](typescript-patch-for-tool-calling-support.md#^ref-7b7ca860-656-0) (line 656, col 0, score 1)
- [Fnord Tracer Protocol â€” L684](fnord-tracer-protocol.md#^ref-fc21f824-684-0) (line 684, col 0, score 1)
- [TypeScript Patch for Tool Calling Support â€” L547](typescript-patch-for-tool-calling-support.md#^ref-7b7ca860-547-0) (line 547, col 0, score 1)
- [Promethean Documentation Update â€” L21](promethean-documentation-update.txt#^ref-0b872af2-21-0) (line 21, col 0, score 1)
- [Promethean_Eidolon_Synchronicity_Model â€” L87](promethean-eidolon-synchronicity-model.md#^ref-2d6e5553-87-0) (line 87, col 0, score 1)
- [Promethean Notes â€” L24](promethean-notes.md#^ref-1c4046b5-24-0) (line 24, col 0, score 1)
- [Promethean Pipelines â€” L128](promethean-pipelines.md#^ref-8b8e6103-128-0) (line 128, col 0, score 1)
- [promethean-requirements â€” L35](promethean-requirements.md#^ref-95205cd3-35-0) (line 35, col 0, score 1)
- [Promethean State Format â€” L131](promethean-state-format.md#^ref-23df6ddb-131-0) (line 131, col 0, score 1)
- [Promethean Workflow Optimization â€” L33](promethean-workflow-optimization.md#^ref-d614d983-33-0) (line 33, col 0, score 1)
- [Provider-Agnostic Chat Panel Implementation â€” L268](provider-agnostic-chat-panel-implementation.md#^ref-43bfe9dd-268-0) (line 268, col 0, score 1)
- [Model Selection for Lightweight Conversational Tasks â€” L209](model-selection-for-lightweight-conversational-tasks.md#^ref-d144aa62-209-0) (line 209, col 0, score 1)
- [Obsidian ChatGPT Plugin Integration Guide â€” L137](obsidian-chatgpt-plugin-integration-guide.md#^ref-1d3d6c3a-137-0) (line 137, col 0, score 1)
- [Obsidian ChatGPT Plugin Integration â€” L138](obsidian-chatgpt-plugin-integration.md#^ref-ca8e1399-138-0) (line 138, col 0, score 1)
- [Obsidian Templating Plugins Integration Guide â€” L207](obsidian-templating-plugins-integration-guide.md#^ref-b39dc9d4-207-0) (line 207, col 0, score 1)
- [Pipeline Enhancements â€” L59](pipeline-enhancements.md#^ref-e2135d9f-59-0) (line 59, col 0, score 1)
- [plan-update-confirmation â€” L1100](plan-update-confirmation.md#^ref-b22d79c6-1100-0) (line 1100, col 0, score 1)
- [polyglot-repl-interface-layer â€” L230](polyglot-repl-interface-layer.md#^ref-9c79206d-230-0) (line 230, col 0, score 1)
- [Post-Linguistic Transhuman Design Frameworks â€” L125](post-linguistic-transhuman-design-frameworks.md#^ref-6bcff92c-125-0) (line 125, col 0, score 1)
- [Promethean Chat Activity Report â€” L147](promethean-chat-activity-report.md#^ref-18344cf9-147-0) (line 147, col 0, score 1)
- [Performance-Optimized-Polyglot-Bridge â€” L483](performance-optimized-polyglot-bridge.md#^ref-f5579967-483-0) (line 483, col 0, score 1)
- [Pipeline Enhancements â€” L11](pipeline-enhancements.md#^ref-e2135d9f-11-0) (line 11, col 0, score 1)
- [plan-update-confirmation â€” L1026](plan-update-confirmation.md#^ref-b22d79c6-1026-0) (line 1026, col 0, score 1)
- [polyglot-repl-interface-layer â€” L219](polyglot-repl-interface-layer.md#^ref-9c79206d-219-0) (line 219, col 0, score 1)
- [Post-Linguistic Transhuman Design Frameworks â€” L126](post-linguistic-transhuman-design-frameworks.md#^ref-6bcff92c-126-0) (line 126, col 0, score 1)
- [Promethean Chat Activity Report â€” L33](promethean-chat-activity-report.md#^ref-18344cf9-33-0) (line 33, col 0, score 1)
- [Promethean-Copilot-Intent-Engine â€” L100](promethean-copilot-intent-engine.md#^ref-ae24a280-100-0) (line 100, col 0, score 1)
- [Promethean Data Sync Protocol â€” L15](promethean-data-sync-protocol.md#^ref-9fab9e76-15-0) (line 15, col 0, score 1)
- [Promethean Dev Workflow Update â€” L107](promethean-dev-workflow-update.md#^ref-03a5578f-107-0) (line 107, col 0, score 1)
- [Promethean Documentation Overview â€” L9](promethean-documentation-overview.md#^ref-9413237f-9-0) (line 9, col 0, score 1)
- [Promethean Notes â€” L96](promethean-notes.md#^ref-1c4046b5-96-0) (line 96, col 0, score 1)
- [Promethean Pipelines â€” L215](promethean-pipelines.md#^ref-8b8e6103-215-0) (line 215, col 0, score 1)
- [Promethean State Format â€” L199](promethean-state-format.md#^ref-23df6ddb-199-0) (line 199, col 0, score 1)
- [Prompt_Folder_Bootstrap â€” L280](prompt-folder-bootstrap.md#^ref-bd4f0976-280-0) (line 280, col 0, score 1)
- [Provider-Agnostic Chat Panel Implementation â€” L291](provider-agnostic-chat-panel-implementation.md#^ref-43bfe9dd-291-0) (line 291, col 0, score 1)
- [Reawakening Duck â€” L208](reawakening-duck.md#^ref-59b5670f-208-0) (line 208, col 0, score 1)
- [ripple-propagation-demo â€” L192](ripple-propagation-demo.md#^ref-8430617b-192-0) (line 192, col 0, score 1)
- [schema-evolution-workflow â€” L620](schema-evolution-workflow.md#^ref-d8059b6a-620-0) (line 620, col 0, score 1)
- [sibilant-macro-targets â€” L244](sibilant-macro-targets.md#^ref-c5c9a5c6-244-0) (line 244, col 0, score 1)
- [Debugging Broker Connections and Agent Behavior â€” L87](debugging-broker-connections-and-agent-behavior.md#^ref-73d3dbf6-87-0) (line 87, col 0, score 1)
- [Duck's Self-Referential Perceptual Loop â€” L82](ducks-self-referential-perceptual-loop.md#^ref-71726f04-82-0) (line 82, col 0, score 1)
- [Dynamic Context Model for Web Components â€” L467](dynamic-context-model-for-web-components.md#^ref-f7702bf8-467-0) (line 467, col 0, score 1)
- [field-dynamics-math-blocks â€” L205](field-dynamics-math-blocks.md#^ref-7cfc230d-205-0) (line 205, col 0, score 1)
- [Stateful Partitions and Rebalancing â€” L669](stateful-partitions-and-rebalancing.md#^ref-4330e8f0-669-0) (line 669, col 0, score 1)
- [TypeScript Patch for Tool Calling Support â€” L628](typescript-patch-for-tool-calling-support.md#^ref-7b7ca860-628-0) (line 628, col 0, score 1)
- [ChatGPT Custom Prompts â€” L18](chatgpt-custom-prompts.md#^ref-930054b3-18-0) (line 18, col 0, score 1)
- [The Jar of Echoes â€” L139](the-jar-of-echoes.md#^ref-18138627-139-0) (line 139, col 0, score 1)
- [Tracing the Signal â€” L104](tracing-the-signal.md#^ref-c3cd4f65-104-0) (line 104, col 0, score 1)
- [ts-to-lisp-transpiler â€” L45](ts-to-lisp-transpiler.md#^ref-ba11486b-45-0) (line 45, col 0, score 1)
- [typed-struct-compiler â€” L411](typed-struct-compiler.md#^ref-78eeedf7-411-0) (line 411, col 0, score 1)
- [TypeScript Patch for Tool Calling Support â€” L566](typescript-patch-for-tool-calling-support.md#^ref-7b7ca860-566-0) (line 566, col 0, score 1)
- [Unique Concepts â€” L10](unique-concepts.md#^ref-ed6f3fc9-10-0) (line 10, col 0, score 1)
- [Unique Info Dump Index â€” L144](unique-info-dump-index.md#^ref-30ec3ba6-144-0) (line 144, col 0, score 1)
- [Creative Moments â€” L121](creative-moments.md#^ref-10d98225-121-0) (line 121, col 0, score 1)
- [Promethean Notes â€” L120](promethean-notes.md#^ref-1c4046b5-120-0) (line 120, col 0, score 1)
- [Promethean Pipelines â€” L121](promethean-pipelines.md#^ref-8b8e6103-121-0) (line 121, col 0, score 1)
- [Prometheus Observability Stack â€” L575](prometheus-observability-stack.md#^ref-e90b5a16-575-0) (line 575, col 0, score 1)
<!-- GENERATED-SECTIONS:DO-NOT-EDIT-ABOVE -->
