
pipelines:
  - name: docs
    steps:
      - id: symdocs-scan
        cwd: .
        inputs: ["packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"]
        outputs: [".cache/symdocs/symbols.json"]
      - id: symdocs-docs
        deps: ["symdocs-scan"]
        inputs: [".cache/symdocs/symbols.json"]
        outputs: [".cache/symdocs/docs.json"]
      - id: symdocs-write
        deps: ["symdocs-docs"]
        inputs: [".cache/symdocs/docs.json"]
        outputs: ["docs/packages/**/**/*.md"]
      - id: symdocs-graph
        deps: ["symdocs-scan"]
        inputs:
          [
            "packages/**/package.json",
            "packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}",
          ]
        outputs: ["docs/packages/README.md", "docs/packages/**/README.md"]

  - name: simtasks
    steps:
      - id: simtasks-scan
        inputs: ["packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"]
        outputs: [".cache/simtasks/functions.json"]
      - id: simtasks-embed
        deps: ["simtasks-scan"]
        inputs: [".cache/simtasks/functions.json"]
        outputs: [".cache/simtasks/embeddings.json"]
      - id: simtasks-cluster
        deps: ["simtasks-embed"]
        inputs: [".cache/simtasks/embeddings.json"]
        outputs: [".cache/simtasks/clusters.json"]
      - id: simtasks-plan
        deps: ["simtasks-cluster"]
        inputs: [".cache/simtasks/clusters.json"]
        outputs: [".cache/simtasks/plans.json"]
      - id: simtasks-write
        deps: ["simtasks-plan"]
        inputs: [".cache/simtasks/plans.json"]
        outputs: ["docs/agile/tasks/*.md"]

  - name: codemods
    steps:
      - id: mods-spec
        inputs: [".cache/simtasks/{functions,clusters,plans}.json"]
        outputs: [".cache/codemods/specs.json"]
      - id: mods-generate
        deps: ["mods-spec"]
        inputs: [".cache/codemods/specs.json"]
        outputs: ["codemods/**/transform.ts"]
      - id: mods-dry-run
        deps: ["mods-generate"]
        inputs:
          [
            "codemods/**/transform.ts",
            "packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}",
          ]
        outputs: ["docs/agile/tasks/codemods/*.md"]
      - id: mods-apply
        deps: ["mods-dry-run"]
        inputs: ["codemods/**/transform.ts"]
        outputs: [".cache/codemods/run-apply.json"]
      - id: mods-verify
        deps: ["mods-apply"]
        inputs: [".cache/codemods/run-apply.json"]
        outputs:
          [
            "docs/agile/tasks/codemods/verify-after.md",
            "docs/agile/tasks/codemods/VERIFY.md",
          ]
  - name: semver-guard
    steps:
      - id: sv-snapshot
        inputs:
          - "packages/**/package.json"
          - "packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"
        outputs: [".cache/semverguard/snapshot.json"]

      - id: sv-diff
        deps: ["sv-snapshot"]
        inputs: [".cache/semverguard/snapshot.json"]
        outputs: [".cache/semverguard/diff.json"]

      - id: sv-plan
        deps: ["sv-diff"]
        inputs: [".cache/semverguard/diff.json"]
        outputs: [".cache/semverguard/plans.json"]

      - id: sv-write
        deps: ["sv-plan"]
        inputs: [".cache/semverguard/plans.json"]
        outputs: ["docs/agile/tasks/semver/*.md"]

      - id: sv-pr
        deps: ["sv-write"]
        inputs:
          - ".cache/semverguard/plans.json"
          - "packages/**/package.json"
        outputs:
          - ".cache/semverguard/pr/summary.json"
  - name: board-review
    steps:
      - id: br-fm
        inputs: ["docs/agile/tasks/**/*.md"]
        outputs: ["docs/agile/tasks/**/*.md"] # FM updates in-place
      - id: br-prompts
        deps: ["br-fm"]
        inputs: ["docs/agile/Process.md"]
        outputs: [".cache/boardrev/prompts.json"]
      - id: br-index
        deps: ["br-fm"]
        inputs:
          - "README.md"
          - "docs/**/*.md"
          - "packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"
        outputs:
          - ".cache/boardrev/repo-index.json"
          - ".cache/boardrev/repo-embeddings.json"
      - id: br-match
        deps: ["br-prompts", "br-index"]
        inputs:
          - "docs/agile/tasks/**/*.md"
          - ".cache/boardrev/repo-index.json"
          - ".cache/boardrev/repo-embeddings.json"
        outputs: [".cache/boardrev/context.json"]
      - id: br-eval
        deps: ["br-match"]
        inputs:
          - ".cache/boardrev/prompts.json"
          - ".cache/boardrev/context.json"
        outputs: [".cache/boardrev/evals.json"]
      - id: br-report
        deps: ["br-eval"]
        inputs: [".cache/boardrev/evals.json"]
        outputs: ["docs/agile/reports/*.md"]
  - name: sonar
    steps:
      - id: sonar-scan
        cwd: .
        env:
          SONAR_HOST_URL: "${SONAR_HOST_URL}"
          SONAR_TOKEN: "${SONAR_TOKEN}"
          SONAR_PROJECT_KEY: "${SONAR_PROJECT_KEY}"
        inputs:
          - "packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"
          - "sonar-project.properties"
        outputs:
          - ".cache/sonar/scan.touch" # marker file we create after scan
      - id: sonar-fetch
        deps: ["sonar-scan"]
        inputs: []
        outputs: [".cache/sonar/issues.json"]
      - id: sonar-plan
        deps: ["sonar-fetch"]
        inputs: [".cache/sonar/issues.json"]
        outputs: [".cache/sonar/plans.json"]
      - id: sonar-write
        deps: ["sonar-plan"]
        inputs: [".cache/sonar/plans.json"]
        outputs: ["docs/agile/tasks/sonar/*.md"]
  - name: readmes
    steps:
      - id: rm-scan
        inputs:
          - "packages/**/package.json"
          - "packages/**/tsconfig.json"
        outputs:
          - ".cache/readmes/scan.json"

      - id: rm-outline
        deps: ["rm-scan"]
        env:
          OLLAMA_URL: "${OLLAMA_URL}"
        inputs:
          - ".cache/readmes/scan.json"
        outputs:
          - ".cache/readmes/outlines.json"

      - id: rm-write
        deps: ["rm-outline"]
        inputs:
          - ".cache/readmes/outlines.json"
        outputs:
          - "packages/**/README.md"

      - id: rm-verify
        deps: ["rm-write"]
        inputs:
          - "packages/**/README.md"
        outputs:
          - "docs/agile/reports/readmes/*.md"
  - name: buildfix
    steps:
      - id: bf-errors
        inputs:
          - "tsconfig.json"
          - "packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"
        outputs:
          - ".cache/buildfix/errors.json"

      - id: bf-iterate
        deps: ["bf-errors"]
        env:
          OLLAMA_URL: "${OLLAMA_URL}"
        inputs:
          - ".cache/buildfix/errors.json"
          - "tsconfig.json"
          - "packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"
        outputs:
          - ".cache/buildfix/summary.json"
          - ".cache/buildfix/history/**"
          - ".cache/buildfix/snippets/**"

      - id: bf-report
        deps: ["bf-iterate"]
        inputs:
          - ".cache/buildfix/summary.json"
        outputs:
          - "docs/agile/reports/buildfix/*.md"
  - name: test-gap
    steps:
      # (Optional) upstream: run your tests to produce lcov.info
      # - id: tg-run-tests
      #   outputs: ["coverage/lcov.info", "packages/**/coverage/lcov.info"]
      - id: tg-exports
        inputs:
          - "packages/**/package.json"
          - "packages/**/{src,lib}/**/*.{ts,tsx,js,jsx}"
        outputs:
          - ".cache/testgap/exports.json"

      - id: tg-coverage
        # deps: ["tg-run-tests"]
        inputs:
          - "coverage/lcov.info"
          - "packages/**/coverage/lcov.info"
        outputs:
          - ".cache/testgap/coverage.json"

      - id: tg-map
        deps: ["tg-exports", "tg-coverage"]
        inputs:
          - ".cache/testgap/exports.json"
          - ".cache/testgap/coverage.json"
        outputs:
          - ".cache/testgap/gaps.json"
      - id: tg-gate
        deps: ["tg-map"]
        inputs: [".cache/testgap/gaps.json"]
        outputs: [".cache/testgap/gate.json"]

      - id: tg-cookbook
        deps: ["tg-map"]
        inputs:
          - "docs/cookbook/**/*.md"
        outputs:
          - ".cache/testgap/cookbook.json"

      - id: tg-plan
        deps: ["tg-cookbook"]
        env:
          OLLAMA_URL: "${OLLAMA_URL}"
        inputs:
          - ".cache/testgap/gaps.json"
          - ".cache/testgap/cookbook.json"
        outputs:
          - ".cache/testgap/plans.json"

      - id: tg-write
        deps: ["tg-plan"]
        inputs:
          - ".cache/testgap/plans.json"
        outputs:
          - "docs/agile/tasks/test-gaps/*.md"

      - id: tg-report
        deps: ["tg-map"]
        inputs:
          - ".cache/testgap/gaps.json"
        outputs:
          - "docs/agile/reports/test-gaps/*.md"
  - name: docops
    steps:
      # a) Ensure / complete front matter (filename/description/tags/uuid)
      - id: doc-fm
        env:
          OLLAMA_URL: "${OLLAMA_URL}"
        inputs:
          - "docs/unique/**/*.md"
        outputs:
          - ".cache/docops/frontmatters.json"

      # b) Chunk + embed (language-aware tokenizer) and build index
      - id: doc-index
        deps: ["doc-fm"]
        env:
          OLLAMA_URL: "${OLLAMA_URL}"
        inputs:
          - "docs/unique/**/*.md"
          - ".cache/docops/frontmatters.json"
        outputs:
          - ".cache/docops/chunks.json"
          - ".cache/docops/embeddings.json"

      # c) Cross-document similarity queries (cache per-chunk results)
      - id: doc-similarity
        deps: ["doc-index"]
        inputsg
          - ".cache/docops/chunks.json"
          - ".cache/docops/embeddings.json"
        outputs:
          - ".cache/docops/queries.json"

      # d) Compute related-doc scores (docâ†”doc)
      - id: doc-related
        deps: ["doc-similarity"]
        inputs:
          - ".cache/docops/queries.json"
          - ".cache/docops/frontmatters.json"
        outputs:
          - ".cache/docops/related.json"

      # e) High-scoring references (chunk-level, with line/col)
      - id: doc-references
        deps: ["doc-similarity"]
        inputs:
          - ".cache/docops/queries.json"
          - ".cache/docops/chunks.json"
        outputs:
          - ".cache/docops/references.json"

      # f) Apply FM updates (add related & references into FM only)
      - id: doc-apply-fm
        deps: ["doc-related", "doc-references"]
        inputs:
          - ".cache/docops/frontmatters.json"
          - ".cache/docops/related.json"
          - ".cache/docops/references.json"
        outputs:
          - ".cache/docops/applied-fm.touch"

      # g) Footer writer (markdown links with line anchors)
      - id: doc-footer
        deps: ["doc-apply-fm"]
        inputs:
          - ".cache/docops/references.json"
          - ".cache/docops/related.json"
          - "docs/unique/**/*.md"
        outputs:
          - ".cache/docops/footer.touch"

      # h) Optional rename pass (based on generated titles)
      - id: doc-rename
        deps: ["doc-apply-fm"]
        inputs:
          - ".cache/docops/frontmatters.json"
        outputs:
          - ".cache/docops/renames.json"
