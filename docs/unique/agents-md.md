---
uuid: 40bc2ba7-9c5c-4f72-8f88-17bef3c6163f
created_at: agents-md.md
filename: Lean AGENT Setup
title: Lean AGENT Setup
description: >-
  A concise agent configuration that avoids role collisions by using a single
  authoritative policy and minimal task briefs. Focuses on clear house rules,
  task templates, and parameterized presets for reliable execution without
  external dependencies.
tags:
  - agent
  - policy
  - task
  - concurrency
  - ava
  - typescript
  - functional
related_to_uuid:
  - 0580dcd3-533d-4834-8a2f-eae3771960a9
  - 618198f4-cfad-4677-9df6-0640d8a97bae
  - 7aa1eb92-7f9a-485b-8218-9b553aa9eefc
  - d5b16703-d7f7-438a-9a75-3ae4589b177b
  - 18344cf9-0c49-4a71-b6c8-b8d84d660fca
  - d8059b6a-c1ec-487d-8e0b-3ce33d6b4d06
  - f2d83a77-7f86-4c56-8538-1350167a0c6c
  - 3a3bf2c9-c0f6-4d7b-bf84-c83c70dece3f
  - e979c50f-69bb-48b0-8417-e1ee1b31c0c0
  - c0392040-16a2-41e8-bd54-75110319e3c0
  - ac60a1d6-fd9f-46dc-bbe7-176dd8017c59
  - d17d3a96-c84d-4738-a403-6c733b874da2
  - 4330e8f0-5f46-4235-918b-39b6b93fa561
  - 7b7ca860-780c-44fa-8d3f-be8bd9496fba
  - 6bcff92c-4224-453d-9993-1be8d37d47c3
  - 30ec3ba6-fbca-4606-ac3e-89b747fbeb7c
  - 98c8ff62-6ea3-4172-9e8b-93913e5d4a7f
  - 9fab9e76-e283-4c9d-a8cd-cb76892ea7ac
  - bc5172ca-7a09-42ad-b418-8e42bb14d089
  - d3e7db72-2e07-4dae-8920-0e07c499a1e5
  - 5c152b08-6b69-4bb8-a1a7-66745789c169
  - bc1dc19d-0e47-4e8a-91d4-544995f143e1
  - 10d98225-12e0-4212-8e15-88b57cf7bee5
  - 13951643-1741-46bb-89dc-1beebb122633
  - 73d3dbf6-9240-46fd-ada9-cc2e7e00dc5f
related_to_title:
  - api-gateway-versioning
  - AI-First-OS-Model-Context-Protocol
  - Board Walk – 2025-08-11
  - AGENTS.md
  - Promethean Chat Activity Report
  - schema-evolution-workflow
  - aionian-circuit-math
  - Promethean Documentation Pipeline Overview
  - DuckDuckGoSearchPipeline
  - Promethean Documentation Update
  - Board Automation Improvements
  - Pure TypeScript Search Microservice
  - Stateful Partitions and Rebalancing
  - TypeScript Patch for Tool Calling Support
  - Post-Linguistic Transhuman Design Frameworks
  - Unique Info Dump Index
  - Optimizing Command Limitations in System Design
  - Promethean Data Sync Protocol
  - prom ui bootstrap
  - balanced-bst
  - OpenAPI Validation Report
  - layer-1-uptime-diagrams
  - Creative Moments
  - Duck's Attractor States
  - Debugging Broker Connections and Agent Behavior
references:
  - uuid: 938eca9c-97e2-4bcc-8653-b0ef1a5ac7a3
    line: 57
    col: 0
    score: 1
  - uuid: 5e408692-0e74-400e-a617-84247c7353ad
    line: 124
    col: 0
    score: 1
  - uuid: 291c7d91-da8c-486c-9bc0-bd2254536e2d
    line: 81
    col: 0
    score: 1
  - uuid: 64a9f9f9-58ee-4996-bdaf-9373845c6b29
    line: 183
    col: 0
    score: 1
  - uuid: 10d98225-12e0-4212-8e15-88b57cf7bee5
    line: 33
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 149
    col: 0
    score: 1
  - uuid: 0580dcd3-533d-4834-8a2f-eae3771960a9
    line: 285
    col: 0
    score: 1
  - uuid: ac60a1d6-fd9f-46dc-bbe7-176dd8017c59
    line: 11
    col: 0
    score: 1
  - uuid: 7aa1eb92-7f9a-485b-8218-9b553aa9eefc
    line: 134
    col: 0
    score: 1
  - uuid: 7cfc230d-8ec2-4cdb-b931-8aec26de2a00
    line: 193
    col: 0
    score: 1
  - uuid: 22b989d5-f4aa-4880-8632-709c21830f83
    line: 203
    col: 0
    score: 1
  - uuid: e9b27b06-f608-4734-ae6c-f03a8b1fcf5f
    line: 151
    col: 0
    score: 1
  - uuid: 1cfae310-35dc-49c2-98f1-b186da25d84b
    line: 281
    col: 0
    score: 1
  - uuid: dd00677a-2280-45a7-91af-0728b21af3ad
    line: 181
    col: 0
    score: 1
  - uuid: 37b5d236-2b3e-4a95-a4e8-31655c3023ef
    line: 220
    col: 0
    score: 1
  - uuid: 291c7d91-da8c-486c-9bc0-bd2254536e2d
    line: 110
    col: 0
    score: 1
  - uuid: ffb9b2a9-744d-4a53-9565-130fceae0832
    line: 118
    col: 0
    score: 1
  - uuid: e018dd7a-1fb7-4732-9e67-cd8b2f0831cf
    line: 329
    col: 0
    score: 1
  - uuid: 0580dcd3-533d-4834-8a2f-eae3771960a9
    line: 287
    col: 0
    score: 1
  - uuid: d3e7db72-2e07-4dae-8920-0e07c499a1e5
    line: 302
    col: 0
    score: 1
  - uuid: ac60a1d6-fd9f-46dc-bbe7-176dd8017c59
    line: 15
    col: 0
    score: 1
  - uuid: 7aa1eb92-7f9a-485b-8218-9b553aa9eefc
    line: 137
    col: 0
    score: 1
  - uuid: d17d3a96-c84d-4738-a403-6c733b874da2
    line: 593
    col: 0
    score: 1
  - uuid: d8059b6a-c1ec-487d-8e0b-3ce33d6b4d06
    line: 561
    col: 0
    score: 1
  - uuid: 4330e8f0-5f46-4235-918b-39b6b93fa561
    line: 607
    col: 0
    score: 1
  - uuid: 7b7ca860-780c-44fa-8d3f-be8bd9496fba
    line: 548
    col: 0
    score: 1
  - uuid: 18344cf9-0c49-4a71-b6c8-b8d84d660fca
    line: 50
    col: 0
    score: 1
  - uuid: 9fab9e76-e283-4c9d-a8cd-cb76892ea7ac
    line: 28
    col: 0
    score: 1
  - uuid: 3a3bf2c9-c0f6-4d7b-bf84-c83c70dece3f
    line: 232
    col: 0
    score: 1
  - uuid: c0392040-16a2-41e8-bd54-75110319e3c0
    line: 29
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 11
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 151
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 152
    col: 0
    score: 1
  - uuid: 0580dcd3-533d-4834-8a2f-eae3771960a9
    line: 286
    col: 0
    score: 1
  - uuid: 0580dcd3-533d-4834-8a2f-eae3771960a9
    line: 288
    col: 0
    score: 1
  - uuid: d3e7db72-2e07-4dae-8920-0e07c499a1e5
    line: 299
    col: 0
    score: 1
  - uuid: ac60a1d6-fd9f-46dc-bbe7-176dd8017c59
    line: 12
    col: 0
    score: 1
  - uuid: 7aa1eb92-7f9a-485b-8218-9b553aa9eefc
    line: 135
    col: 0
    score: 1
  - uuid: d17d3a96-c84d-4738-a403-6c733b874da2
    line: 600
    col: 0
    score: 1
  - uuid: d8059b6a-c1ec-487d-8e0b-3ce33d6b4d06
    line: 583
    col: 0
    score: 1
  - uuid: 4330e8f0-5f46-4235-918b-39b6b93fa561
    line: 610
    col: 0
    score: 1
  - uuid: 7b7ca860-780c-44fa-8d3f-be8bd9496fba
    line: 546
    col: 0
    score: 1
  - uuid: 30ec3ba6-fbca-4606-ac3e-89b747fbeb7c
    line: 150
    col: 0
    score: 1
  - uuid: e979c50f-69bb-48b0-8417-e1ee1b31c0c0
    line: 30
    col: 0
    score: 1
  - uuid: 5c152b08-6b69-4bb8-a1a7-66745789c169
    line: 47
    col: 0
    score: 1
  - uuid: 98c8ff62-6ea3-4172-9e8b-93913e5d4a7f
    line: 82
    col: 0
    score: 1
  - uuid: 6bcff92c-4224-453d-9993-1be8d37d47c3
    line: 148
    col: 0
    score: 1
  - uuid: 18344cf9-0c49-4a71-b6c8-b8d84d660fca
    line: 60
    col: 0
    score: 1
  - uuid: 9fab9e76-e283-4c9d-a8cd-cb76892ea7ac
    line: 39
    col: 0
    score: 1
  - uuid: 3a3bf2c9-c0f6-4d7b-bf84-c83c70dece3f
    line: 168
    col: 0
    score: 1
  - uuid: c0392040-16a2-41e8-bd54-75110319e3c0
    line: 40
    col: 0
    score: 1
  - uuid: d5b16703-d7f7-438a-9a75-3ae4589b177b
    line: 323
    col: 0
    score: 1
  - uuid: d5b16703-d7f7-438a-9a75-3ae4589b177b
    line: 326
    col: 0
    score: 1
  - uuid: 2901a3e9-96f0-497c-ae2c-775f28a702dd
    line: 478
    col: 0
    score: 1
  - uuid: d3e7db72-2e07-4dae-8920-0e07c499a1e5
    line: 315
    col: 0
    score: 1
  - uuid: ac60a1d6-fd9f-46dc-bbe7-176dd8017c59
    line: 27
    col: 0
    score: 1
  - uuid: 10d98225-12e0-4212-8e15-88b57cf7bee5
    line: 176
    col: 0
    score: 1
  - uuid: 73d3dbf6-9240-46fd-ada9-cc2e7e00dc5f
    line: 455
    col: 0
    score: 1
  - uuid: e979c50f-69bb-48b0-8417-e1ee1b31c0c0
    line: 123
    col: 0
    score: 1
  - uuid: 13951643-1741-46bb-89dc-1beebb122633
    line: 366
    col: 0
    score: 1
  - uuid: a4d90289-798d-44a0-a8e8-a055ae12fb52
    line: 632
    col: 0
    score: 1
  - uuid: 6620e2f2-de6d-45d8-a722-5d26e160b370
    line: 829
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 15
    col: 0
    score: 1
  - uuid: 7aa1eb92-7f9a-485b-8218-9b553aa9eefc
    line: 157
    col: 0
    score: 1
  - uuid: d3e7db72-2e07-4dae-8920-0e07c499a1e5
    line: 316
    col: 0
    score: 1
  - uuid: ac60a1d6-fd9f-46dc-bbe7-176dd8017c59
    line: 28
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 61
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 43
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 210
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 100
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 207
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 65
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 282
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 224
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 189
    col: 0
    score: 1
  - uuid: 13951643-1741-46bb-89dc-1beebb122633
    line: 2298
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 388
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 18
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 201
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 140
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 194
    col: 0
    score: 1
  - uuid: 1b1338fc-bb4d-41df-828f-e219cc9442eb
    line: 1062
    col: 0
    score: 1
  - uuid: 10d98225-12e0-4212-8e15-88b57cf7bee5
    line: 558
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 239
    col: 0
    score: 1
  - uuid: 1b1338fc-bb4d-41df-828f-e219cc9442eb
    line: 2228
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 392
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 160
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 293
    col: 0
    score: 1
  - uuid: 008f2ac0-bfaa-4d52-9826-2d5e86c0059f
    line: 723
    col: 0
    score: 1
  - uuid: f2d83a77-7f86-4c56-8538-1350167a0c6c
    line: 256
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 294
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 378
    col: 0
    score: 1
  - uuid: 008f2ac0-bfaa-4d52-9826-2d5e86c0059f
    line: 2868
    col: 0
    score: 1
  - uuid: 13951643-1741-46bb-89dc-1beebb122633
    line: 1256
    col: 0
    score: 1
  - uuid: 008f2ac0-bfaa-4d52-9826-2d5e86c0059f
    line: 1488
    col: 0
    score: 1
  - uuid: 18344cf9-0c49-4a71-b6c8-b8d84d660fca
    line: 574
    col: 0
    score: 1
  - uuid: 03a5578f-d689-45db-95e9-11300e5eee6f
    line: 1469
    col: 0
    score: 1
  - uuid: 0b872af2-4197-46f3-b631-afb4e6135585
    line: 523
    col: 0
    score: 1
  - uuid: 1c4046b5-742d-4004-aec6-b47251fef5d6
    line: 555
    col: 0
    score: 1
  - uuid: 618198f4-cfad-4677-9df6-0640d8a97bae
    line: 196
    col: 0
    score: 1
---
Short answer: yeah—stuffing a dozen “roles” into **AGENTS.md** is how you get instruction collisions and tool drift. LLMs behave best with **one authoritative policy + a tiny task brief**. Keep the rest as parameterized snippets, not separate personas.

Here’s a tighter setup that won’t confuse agents.

# AGENTS.md (lean + unambiguous)

## 0) House Rules (single source of truth)

* **Stack**: Node ≥ 18, TypeScript, functional style (pure functions, immutability, composition). ^ref-bb90903a-9-0
* **Tests**: **AVA only**, concurrent by default. Use `test.serial` only when unavoidable. ^ref-bb90903a-10-0
* **Bans**: No Jest/Vitest. No React. No Python. No external SaaS/tokens. Prefer local services/Docker. ^ref-bb90903a-11-0
* **I/O**: No network egress in tests. Use in-memory fakes, temp dirs, and random ports.
* **Tone**: Skeptical, concise, practical. Admit uncertainty; propose verifiable steps. ^ref-bb90903a-13-0
* **If any input conflicts with these rules: refuse and restate the policy.**

> These rules override anything else in this file.

---

## 1) Task Brief (fill this per request)

```
$GOAL: <what outcome matters to users/devs>
$CONTEXT: <paths, errors, APIs, env limits>
$CONSTRAINTS: <perf/mem caps, Node/TS versions, CI limits>
$DOD (Definition of Done): <checks: tests pass, coverage, lints, timings>
```

---

## 2) Execution Contract (what the agent must return)

1. **Plan**: 3–6 bullets: approach, concurrency risks, validation.
2. **Minimal changes**: only files/patches needed; no drive-by rewrites.
3. **Tests (AVA/TS)**: focus on concurrent behavior and one failure path.
4. **Why it’s safe**: quick rationale (globals avoided, temp dirs, random ports).
5. **Next steps** (optional): one small improvement if time allows.

> If you suggest a dependency: name, license, why needed, local/offline mode.

---

## 3) Prompts you reuse (as *snippets*, not roles)

### A) Concurrency Guard

```
Enforce parallel safety: no fixed ports/paths; use mkdtemp/random ports.
If a test cannot run in parallel, explain why and isolate with `test.serial`.
```
^ref-bb90903a-47-0

### B) Local-Only Guard

```
No external network calls. If something MUST be called, inject a fake via DI and test against that.
^ref-bb90903a-54-0
```
^ref-bb90903a-55-0 ^ref-bb90903a-59-0

### C) FP Discipline

```
Refactor into pure functions at the leaves; isolate side effects in adapters.
Avoid mutation; use mapping and composition; narrow types at boundaries.
```

### D) AVA-Only Test Template (TS)

```
- Use `import test from 'ava'`
- Assertions: `t.is`, `t.truthy`, `t.deepEqual`, `t.throwsAsync`, `t.like`
^ref-bb90903a-67-0
- Snapshots only for stable, structured output (AST/JSON), not volatile strings
^ref-bb90903a-69-0
```
^ref-bb90903a-70-0

---

## 4) Presets (just parameter packs, not personas)

> You apply **House Rules + Execution Contract + one preset**. That’s it.

**Preset: Test Designer**

```
Goal: design concurrent-safe tests that would fail if hidden shared state exists.
Deliver: test plan, fixtures, 2–3 AVA tests, brief why-concurrent section.
```

**Preset: Minimal Repro**

```
Goal: 50–100 line repro + one AVA test that demonstrates bug deterministically.
Constraints: no external I/O; use mkdtemp/random prefixes; finish <5s.
```

**Preset: Refactor-for-Purity**

```
Goal: move logic to pure transforms; keep API stable unless stated.
Deliver: small diff, new pure functions, AVA tests proving referential transparency.
```

**Preset: Pipeline/CLI**

```
Goal: compose small pnpm scripts; deterministic inputs/outputs; add --concurrency flags where useful.
Deliver: scripts, short usage, 1–2 AVA tests for critical behavior.
```

---

## 5) One-shot templates (copy/paste, fill vars)

**Template: Test Designer**

```
Apply Preset: Test Designer.

$GOAL = <...>
$CONTEXT = <paths, failing logs>
$CONSTRAINTS = <node/ts, ci>
$DOD = <what must pass>

Return per Execution Contract. Use snippets A, B, D. Keep code under 120 lines total.
```

**Template: Minimal Repro**

```
Apply Preset: Minimal Repro.

$GOAL = <bug symptom in one line>
$CONTEXT = <file(s), function(s), error text>
$CONSTRAINTS = Node 20, tmpfs in CI
$DOD = "repro fails before fix; passes after"

Return: repro.ts, repro.test.ts, run commands, expected failure text.
Use snippets A, B, D.
```

**Template: Refactor-for-Purity**

```
Apply Preset: Refactor-for-Purity.

$GOAL = <what to simplify>
$CONTEXT = <module path(s)>
$CONSTRAINTS = <perf/size>
$DOD = "tests green; no behavioral change; improved determinism"

Return: plan, minimal diff, AVA tests, rationale. Use snippets B, C, D.
```

---

## 6) Guardrails (non-prompt, repo-level)

* CI job fails if diff introduces `jest`, `@jest/*`, `vitest`, `react`.
* ESLint includes `eslint-plugin-ava`; forbid `describe/it/expect` globals.
* Renovate/Dependabot ignore rules for Jest/Vitest packages.
* A tiny script that greps PRs for fixed ports/paths in tests and warns.

---

### Why this structure works

* **One authority**: House Rules.
* **One task brief**: fewer instructions → fewer collisions.
* **One contract**: consistent outputs you can verify.
* **Presets as data**: you’re not switching personas; you’re switching parameters.
 ^ref-bb90903a-171-0
If you want, I’ll collapse this into your repo’s `docs/AGENTS.md` with your exact directories and CI names baked in so it’s literally paste-and-go.
 ^ref-bb90903a-176-0
\#hashtags
\#prompts #agents #AGENTSmd #ava #concurrency #nodejs #typescript #functionalprogramming #devprocess #obsidian ^ref-bb90903a-175-0
