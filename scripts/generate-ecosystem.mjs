import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

export function generateEcosystem({
  packagesDir = path.resolve("packages"),
  outputFile = path.resolve("ecosystem.generated.mjs"),
} = {}) {
  const entries = fs.readdirSync(packagesDir, { withFileTypes: true });
  const imports = [];
  const vars = [];
  for (const entry of entries) {
    if (!entry.isDirectory()) continue;
    const pkgName = entry.name;
    const configPath = path.join(packagesDir, pkgName, "ecosystem.config.js");
    if (!fs.existsSync(configPath)) continue;
    const varName = pkgName.replace(/[^a-zA-Z0-9]/g, "_");
    const relImport = path
      .relative(path.dirname(outputFile), configPath)
      .replace(/\\/g, "/");
    imports.push(`import * as ${varName} from './${relImport}';`);
    vars.push(varName);
  }
  const content = `// This file is generated by scripts/generate-ecosystem.mjs\n${imports.join(
    "\n",
  )}\n\nconst modules = [${vars.join(
    ", ",
  )}];\nexport const apps = modules.flatMap((m) => m?.default?.apps ?? m.apps ?? []);\n`;
  fs.writeFileSync(outputFile, content);
}

if (
  process.argv[1] &&
  fileURLToPath(import.meta.url) === path.resolve(process.argv[1])
) {
  generateEcosystem();
}
