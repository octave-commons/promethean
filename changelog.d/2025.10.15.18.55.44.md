# Fix Kanban Column Underscore Normalization Bug

## Type

fix

## Description

Fixed inconsistent column name normalization between `columnKey()` function in kanban.ts and `normalizeColumnName()` method in transition-rules.ts.

## Issue

The `normalizeColumnName()` method in transition-rules.ts was missing the crucial step of converting spaces and hyphens to underscores, causing mismatches between CLI commands and transition rule evaluations.

## Root Cause

- `columnKey()`: `.replace(/[\s-]+/g, '_')` - converts spaces and hyphens to underscores
- `normalizeColumnName()` (before fix): `.replace(/[^a-z0-9_]+/g, '')` - removed special chars but didn't convert spaces/hyphens first

## Impact

- CLI commands like `kanban update-status` would fail to find columns with underscores
- Transition rules would not apply correctly to columns with spaces/hyphens in names
- Inconsistent behavior between different parts of the system

## Fix

Updated `normalizeColumnName()` method in transition-rules.ts to match the exact normalization logic of `columnKey()`:

```typescript
private normalizeColumnName(column: string): string {
  return column
    .normalize('NFKD')
    .toLowerCase()
    .replace(/[\s-]+/g, '_') // Convert spaces and hyphens to underscores
    .replace(/[^a-z0-9_]+/g, ''); // Remove other special chars
}
```

## Testing

- Added comprehensive test in `column-key-normalization.test.ts` to verify both functions produce identical results
- Updated `underscore-bug-demo.test.ts` to reflect the fix
- All column name variations now normalize consistently:
  - "in_progress" → "in_progress"
  - "in-progress" → "in_progress"
  - "in progress" → "in_progress"

## Verification

Commands like these now work consistently:

- `pnpm kanban update-status <task-uuid> "in progress"`
- `pnpm kanban update-status <task-uuid> "in-progress"`
- `pnpm kanban update-status <task-uuid> "in_progress"`

All resolve to the same column and transition rules apply correctly.
