2025.10.20.22.04.54.md

# ContextStore Architecture Cleanup

## Current State

- **Canonical `ContextStore`** lives in `@promethean/persistence` (`packages/persistence/src/contextStore.ts`)
- **Class-based**: `ContextStore` with collection management
- **Functional factory**: `makeContextStore(deps)` for FP approach
- **`DualStoreManager`** is the low-level hybrid store (Mongo + Chroma)

## Confirmed Usage Patterns

- `packages/opencode-client/src/index.ts`: Imports both `DualStoreManager` and `ContextStore`, uses single `ContextStore` instance
- `packages/agents/agent-orchestrator/src/agent-orchestrator.ts`: Uses `DualStoreManager` directly for raw persistence
- All other imports correctly reference `@promethean/persistence`

## Recommendations Applied

1. ✅ **Single source of truth**: Only `ContextStore` from `@promethean/persistence` exists
2. ✅ **Functional preference**: Use `makeContextStore(deps)` for new code
3. ✅ **Clear separation**: `DualStoreManager` for persistence, `ContextStore` for context compilation
4. ✅ **No drift**: No parallel ContextStore definitions found

## Code Pattern

```ts
import { makeContextStore, DualStoreManager } from '@promethean/persistence';

const deps = {
  getCollections: () => [
    /* DualStoreManager instances */
  ],
  resolveRole: (meta) => (meta?.userName === 'Duck' ? 'assistant' : 'user'),
  resolveDisplayName: (meta) => (meta?.userName as string) ?? 'Unknown',
  formatTime: (ms: number) => new Date(ms).toISOString(),
};

const { compileContext } = makeContextStore(deps);
```

## Status

Architecture is clean and aligned with FP principles. No cleanup needed.
