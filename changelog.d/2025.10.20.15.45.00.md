# Continuous Whole Message Indexing - COMPLETED

## Summary

Successfully implemented continuous whole message indexing for the `@promethean/opencode-client` package with real-time event subscription and dual store integration.

## Implementation Details

### Core Features

- **Real-time Event Subscription**: Subscribes to OpenCode events via `client.event.subscribe()`
- **Continuous Message Capture**: Captures `message.part.updated`, `message.updated`, and `message.removed` events as they happen
- **Complete Message Storage**: Fetches full message content via `client.session.messages()` when events occur
- **Dual Store Integration**: Messages stored as searchable markdown in both MongoDB and Chroma
- **Session ID Extraction**: Correctly extracts session IDs from event structures for proper message association

### CLI Commands

- `indexer start [--pm2] [--verbose]` - Start indexer (foreground or PM2 daemon) with optional verbose logging
- `indexer stop` - Stop PM2 daemon indexer service
- `indexer status` - Check indexer service status (PM2-aware)

### Logging Improvements

- **Event Deduplication**: Reduces log noise by debouncing identical event types (5-second intervals)
- **Verbose Mode**: `--verbose` flag shows detailed event logging
- **Smart Counting**: Tracks total events and per-event-type counts

### Files Modified/Created

- `src/services/indexer.ts` - Core indexer service with event handling and logging
- `src/commands/indexer/start.ts` - CLI start command with PM2 daemon support
- `src/commands/indexer/stop.ts` - CLI stop command (PM2-aware)
- `src/commands/indexer/status.ts` - CLI status command (PM2-aware)
- `src/commands/indexer/index.ts` - Command group definition with options

## Technical Implementation

### Event Flow

1. Subscribe to OpenCode events via SDK
2. Filter for message-related events (`message.*`)
3. Extract session ID from event properties
4. Fetch complete message content via `client.session.messages()`
5. Convert messages to markdown format
6. Store in dual store (MongoDB + Chroma) with metadata

### Session ID Extraction Logic

- `message.updated/removed`: `properties.info.sessionID` or `properties.sessionID`
- `message.part.updated/removed`: `properties.part.sessionID` or `properties.sessionID`
- `session.updated/deleted`: `properties.info.id`

### Markdown Format

Messages are stored as structured markdown with:

- Message ID and role
- Timestamp and session ID
- Full text content from all text parts
- Proper metadata for search and retrieval

## Status

âœ… **COMPLETE** - Indexer fully functional and tested

## Usage

```bash
# Start indexer (foreground)
node dist/cli.js indexer start

# Start indexer (foreground, verbose)
node dist/cli.js indexer start --verbose

# Start indexer (PM2 daemon)
node dist/cli.js indexer start --pm2

# Start indexer (PM2 daemon, verbose)
node dist/cli.js indexer start --pm2 --verbose

# Check status (PM2-aware)
node dist/cli.js indexer status

# Stop PM2 daemon
node dist/cli.js indexer stop
```

## PM2 Integration

- **Status command** now checks PM2 processes and shows real-time metrics
- **Start command** supports `--pm2` flag for daemon mode
- **Stop command** properly stops PM2 daemon processes
- **Graceful fallback** when PM2 is not installed

The indexer now provides complete, continuous message indexing that captures every message as it's created and stores it for search and retrieval in the dual store system.
