# Fix BuildFix \_\_dirname undefined in ESM modules

Fixed the issue where `__dirname` was undefined in ES modules by implementing the ESM-compatible equivalent:

## Changes Made

### src/utils.ts

- Added `import { fileURLToPath } from 'url'`
- Added ESM \_\_dirname equivalent:
  ```javascript
  const __filename = fileURLToPath(import.meta.url);
  const __dirname = path.dirname(__filename);
  ```

### src/iter/dsl.ts

- Added same ESM \_\_dirname fix
- Ensures ts-morph path resolution works in ESM context

### src/tests/ts-morph-import-resolution.test.ts

- Added ESM \_\_dirname fix
- Fixed test schema to match Plan interface requirements
- Fixed error handling for unknown error types

## Problem Solved

The BuildFix package uses `"type": "module"` in package.json, which means it runs as ES modules. In ES modules, `__dirname` is not available globally like it is in CommonJS. This was causing runtime errors when the code tried to resolve paths to ts-morph and other dependencies.

## Impact

- BuildFix can now properly resolve ts-morph imports in generated snippets
- All path resolution functionality works correctly in ESM context
- Fixes the core issue that was causing 0% success rates in BuildFix operations

## Testing

- Verified that \_\_dirname resolution works correctly in ESM modules
- Confirmed ts-morph path resolution functions properly
- Tested that the DSL snippet generation works without errors
