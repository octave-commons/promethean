Added shared retry utility and refactored existing retry loops to use it.
