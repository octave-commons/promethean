# Agents Package Refactoring - 2025.10.20.18.01.49

## ğŸ¯ Objective

High-priority architectural fixes for the `packages/agents` tree to address domain logic mixing, duplicate types, and class-based patterns.

## âœ… COMPLETED

- **Task 1**: Removed duplicate `MessageEnvelope` from `agent/src/nlp/executor.ts` - kept local interface with TODO to use `@promethean/agent-protocol` when available
- **Task 2**: Standardized store names in `agent-orchestrator` from `'session_messages'/'agent_tasks'` to `'sessions'/'agent-tasks'`
- **Task 3**: Converting NLP classes to functional factories:
  - âœ… Converted `NaturalLanguageCommandParser` to `makeParser` factory in `parser.ts`
  - âœ… Converted `AgentOSCommandExecutor` to `makeExecutor` factory in `executor.ts`
  - âœ… Updated `NLPService` to use new factories, added `makeNLPService` functional factory
  - âœ… Fixed tsconfig.json references and build issues
- **Task 4**: Fixed package.json exports to ESM-only across agents packages:
  - âœ… Removed CJS exports from `@promethean/agent` package.json
  - âœ… Removed CJS exports from `@promethean/agents-workflow` package.json
  - âœ… Removed CJS exports from `@promethean/pantheon` package.json
  - âœ… Removed CJS exports from `@promethean/agent-management-ui` package.json
  - âœ… Removed CJS exports from `@promethean/agent-ecs` package.json
  - âœ… Removed CJS exports from `@promethean/agent-generator` package.json
- **Task 5**: Converted `agent-context` manager to DI-based factory:
  - âœ… Added `makeAuthService` factory function with DI support
  - âœ… Added `AuthServiceConfig` and `AuthServiceDeps` types
  - âœ… Maintained backward compatibility with original `JWTAuthService` class
  - âœ… Exported new factory and types from index.ts

## ğŸ“ Files Modified

- `/packages/agents/agent/src/nlp/parser.ts` - Added `makeParser` factory function
- `/packages/agents/agent/src/nlp/executor.ts` - Added `makeExecutor` factory function, exported `MessageEnvelope`
- `/packages/agents/agent/src/nlp/index.ts` - Updated `NLPService` to use factories, added `makeNLPService`
- `/packages/agents/agent-orchestrator/src/agent-orchestrator.ts` - Updated store names
- `/packages/agents/agent/package.json` - Added dependency on `@promethean/agent-protocol`
- `/packages/agents/agent/tsconfig.json` - Removed invalid security package reference

## ğŸ”§ Technical Details

- Factory pattern: `makeParser(config)` and `makeExecutor(deps)` return plain functions
- Dependency injection: Executors accept `agentRuntime`, `serviceManager`, `workflowManager`, plus optional `id`, `now`, `log`
- Backward compatibility: Original classes remain as wrappers around factories
- Store name standardization: `'sessions'` and `'agent-tasks'` are now the canonical names
