# Agents Package Refactoring - 2025.10.20.18.01.49

## üéØ Objective

High-priority architectural fixes for the `packages/agents` tree to address domain logic mixing, duplicate types, and class-based patterns.

## ‚úÖ COMPLETED

- **Task 1**: Removed duplicate `MessageEnvelope` from `agent/src/nlp/executor.ts` - kept local interface with TODO to use `@promethean/agent-protocol` when available
- **Task 2**: Standardized store names in `agent-orchestrator` from `'session_messages'/'agent_tasks'` to `'sessions'/'agent-tasks'`
- **Task 3**: Converting NLP classes to functional factories:
  - ‚úÖ Converted `NaturalLanguageCommandParser` to `makeParser` factory in `parser.ts`
  - ‚úÖ Converted `AgentOSCommandExecutor` to `makeExecutor` factory in `executor.ts`
  - ‚úÖ Updated `NLPService` to use new factories, added `makeNLPService` functional factory
  - ‚úÖ Fixed tsconfig.json references and build issues
- **Task 4**: Fixed package.json exports to ESM-only across agents packages:
  - ‚úÖ Removed CJS exports from `@promethean/agent` package.json
  - ‚úÖ Removed CJS exports from `@promethean/agents-workflow` package.json
  - ‚úÖ Removed CJS exports from `@promethean/pantheon` package.json
  - ‚úÖ Removed CJS exports from `@promethean/agent-management-ui` package.json
  - ‚úÖ Removed CJS exports from `@promethean/agent-ecs` package.json
  - ‚úÖ Removed CJS exports from `@promethean/agent-generator` package.json
- **Task 5**: Converted `agent-context` manager to DI-based factory:
  - ‚úÖ Added `makeAuthService` factory function with DI support
  - ‚úÖ Added `AuthServiceConfig` and `AuthServiceDeps` types
  - ‚úÖ Maintained backward compatibility with original `JWTAuthService` class
  - ‚úÖ Exported new factory and types from index.ts

## üìÅ Files Modified

- `/packages/agents/agent/src/nlp/parser.ts` - Added `makeParser` factory function
- `/packages/agents/agent/src/nlp/executor.ts` - Added `makeExecutor` factory function, exported `MessageEnvelope`
- `/packages/agents/agent/src/nlp/index.ts` - Updated `NLPService` to use factories, added `makeNLPService`
- `/packages/agents/agent-orchestrator/src/agent-orchestrator.ts` - Updated store names
- `/packages/agents/agent/package.json` - Added dependency on `@promethean/agent-protocol`, removed CJS exports
- `/packages/agents/agent/tsconfig.json` - Removed invalid security package reference
- `/packages/agents/agents-workflow/package.json` - Removed CJS exports
- `/packages/agents/pantheon/package.json` - Removed CJS exports
- `/packages/agents/agent-management-ui/package.json` - Removed CJS exports
- `/packages/agents/agent-ecs/package.json` - Removed CJS exports
- `/packages/agents/agent-generator/package.json` - Removed CJS exports
- `/packages/agents/agent-context/src/auth.ts` - Added `makeAuthService` factory function and types
- `/packages/agents/agent-context/src/index.ts` - Exported new factory and types

## üîß Technical Details

- Factory pattern: `makeParser(config)` and `makeExecutor(deps)` return plain functions
- Dependency injection: Executors accept `agentRuntime`, `serviceManager`, `workflowManager`, plus optional `id`, `now`, `log`
- Backward compatibility: Original classes remain as wrappers around factories
- Store name standardization: `'sessions'` and `'agent-tasks'` are now the canonical names
- ESM-only exports: All agent packages now use only ESM exports, no CJS compatibility layers
- DI-based auth service: `makeAuthService` accepts injectable dependencies for JWT secret, config, ID generation, timing, and logging
