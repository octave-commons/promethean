# 2025.10.19.04.23.45

## Fixed CLI Hanging Issue

### Problem

- CLI commands like `sessions list --limit 5` would display the table but then hang indefinitely instead of exiting
- Commands appeared to work but never returned control to the shell

### Root Cause

- `DualStoreManager.create()` opened MongoDB and ChromaDB connections but had no cleanup mechanism
- Node.js event loop waited for these connections to close before allowing process exit

### Solution

1. **Added cleanup method to DualStoreManager** (`packages/persistence/src/dualStore.ts:272-289`)

   - Properly closes MongoDB connections
   - Handles ChromaDB cleanup gracefully

2. **Enhanced CLI cleanup** (`packages/opencode-client/src/cli.ts:47-63`)

   - Calls cleanup on both sessionStore and agentTaskStore
   - Also closes global MongoDB client
   - Integrated with existing error handlers and exit hooks

3. **Ensured clean command exit** - Added `setImmediate(() => process.exit(0))` to all session commands:
   - `packages/opencode-client/src/commands/sessions/list.ts:82-86`
   - `packages/opencode-client/src/commands/sessions/create.ts:62-66`
   - `packages/opencode-client/src/commands/sessions/get.ts:35-39`
   - `packages/opencode-client/src/commands/sessions/close.ts:13-17`
   - `packages/opencode-client/src/commands/sessions/search.ts:24-28`
   - `packages/opencode-client/src/commands/sessions/diagnose.ts:82-86`

### Test Added

- Created test: `packages/opencode-client/src/tests/session-title.test.ts`
- Verifies: "when a session is created with a title, it shows up in the list with that title"
- Test passes: âœ… (1.2s)

### Verification

- `sessions list --limit 5` now exits in <5 seconds instead of hanging
- `sessions create --title "test"` works and exits cleanly
- `sessions get <id>` works and exits cleanly
- `sessions close <id>` works and exits cleanly
- `sessions search <query>` works and exits cleanly
- `sessions diagnose --stats` works and exits cleanly
- All cleanup hooks work properly on SIGINT, uncaughtException, etc.

### Performance Impact

- **Before**: Commands hung indefinitely (60+ seconds)
- **After**: Commands complete and exit in <5 seconds
- **Memory**: No more connection leaks from unclosed database connections
